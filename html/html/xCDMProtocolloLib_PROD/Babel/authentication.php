<?php
/**
 * Created by PhpStorm.
 * User: d.mengoli
 * Date: 17/05/2019
 * Time: 11:24
 */

require_once __DIR__ . '/../vendor/autoload.php';

require_once __DIR__ . '/../utils.php';

use \Firebase\JWT\JWT;

function GenerateJWTToken($payload){

    $privateKey = <<<EOD
-----BEGIN RSA PRIVATE KEY-----
MIIEowIBAAKCAQEAyBrccDxZqcG0+HOcrulAc71VVma/gZ+Wpzf9PZMzLNKe2nJe
YcctoG8faCUxayovZOf3qyjhlXK7eq/TGX5RJPvOtEHX3lTM2YVnZE58Q2ulZc0e
mg5/gfUIw9VnhavAc2134/WRKQTtCJ+O5b1eG44uV/Y9yVviPmqwuw9ZIKZuP40d
fTxYxRLe47oLEGsK8WdmFkbCc1xE8GQoWjbge2vlH0T40qyfbRmxqLVYTJO2BPNM
Sfsv3U2HpdBANsWU2KnosGAm8+jh2porpQNdrbk6nBh9Cf8wyAWB3OK06X94D2M4
om+A4yW71XEygo/DDt88HAw1TwBHGqIxoobrcwIDAQABAoIBADg9LGUy4PRP57/I
JmoWTjH5LWnKGNqicqHun3LV0xUu4Mx+Rj5uz0j+0jHf+iKnSYivlTD6nWP2SfCy
R78rfDzLtI1+z9/Br40W7DcJw+zi7SpOWuJrXrS0nFEFwkGUQtNuGbrswm5n3wKE
bZHuBevyqt237CeSdmSaca8xIhiFjikl5v7BHL5Lf5eogvel7pWwKZFdWSqfJLpg
O2kDpyBWHpK36gUuVmeqf+F7FRDqAsTKOqwV9C2o832OCD8aAtrT/OG+QzUpUg/3
cDE8KwIXTfF75eLuClMOYGw1bXvgm5qu1HeEezZyFQukRpjbVHjR63WPyYYxPbs6
wJ6d/KkCgYEA+mh/vWZdLxvXhq4INEPzzudbQ6kxRWXpPM39MSZPvdm617fovDK4
/VJ5424KNBr8DgpDhYe8FjEkxS9OOA8GA0NGfiXRJQU7uqsjimAZGDgV+KWf+PEE
vUIe8FVpc/w04f64iwlnIlLZKpy41342M2akHRUZvyLfZEbsb4r+cscCgYEAzJLL
floAPBXG+O6Z92AAc/ycYqwkulwuXgyDJ7g7P4qBU1SP/8n2ZBL3ptAQ6fVQDfTr
L9en2d50766mwUUj9aR4egrCFf8DjuEqRLHObco4h3WMeCk2iCIq9RBAtEEHmgk9
IGVp5ndRrNeT5VzblC+gZadSGOmVtKKV1cDhVfUCgYAQ/cxFLs/95Va/lcmKul2t
2XcQ5UcpnVuxO40Fq8LXcBHEl38cXhi9X75Tl2Dr3jTiQwIH6ojxvI3xL1+QYDyZ
NhRvdON3Lp658Ojtd83cHdon0B1FyBz5NqZgynroWuG/wAgHrzCnXJXN1WqZfL/y
xvE14/umQ5iC9mkOvJC9ewKBgDxjcPKhesRB4XSGaqjdjASxIzD1g/oHUCCvLOBC
wCqnpjmFEuT9J2CvQK/bZ8LIiZM1I2ACFyh3RKmkMtGGqXDP1kigeF6p4tEAosuY
eUlrknhaONcXw2M4QtoIrDEJqUbNR2ASz8oamt+c26mvWZpK3NxlIhT8jxa9j+GD
iIEpAoGBAJEsB7aoZ6rMpXPPlgCX47YZzNNmwnhvsbg9WeoKsdUouh1xV+WWrTne
lAH0R3PS0G0SOuO3eajWWd4n41MZy7srjs75xwNWYSRfoNGqkKcXNZgoH6Wqc7NW
+mN/wVImFbHFzEbg62ae6Q0yqWjqA4gDv//e0776p655ozfnFQSE
-----END RSA PRIVATE KEY-----
EOD;

    $publicKey = <<<EOD
-----BEGIN CERTIFICATE-----
MIIEwTCCAqmgAwIBAgIIFYQ+WJ9V41YwDQYJKoZIhvcNAQELBQAwXjELMAkGA1UE
BhMCSVQxEDAOBgNVBAgTB0JvbG9nbmExEDAOBgNVBAcTB0JvbG9nbmExDDAKBgNV
BAoTA0JEUzEMMAoGA1UECxMDQkRTMQ8wDQYDVQQDEwZCRFMgQ0EwHhcNMTgwNDA2
MDAwMDAwWhcNNDMwNDA1MjM1OTU5WjBxMQswCQYDVQQGEwJJVDEQMA4GA1UECBMH
Qm9sb2duYTEQMA4GA1UEBxMHQm9sb2duYTEMMAoGA1UEChMDQkRTMQwwCgYDVQQL
EwNCRFMxEzARBgNVBAMTClNJUkVSIFRFU1QxDTALBgNVBEgTBFRFU1QwggEiMA0G
CSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQDIGtxwPFmpwbT4c5yu6UBzvVVWZr+B
n5anN/09kzMs0p7acl5hxy2gbx9oJTFrKi9k5/erKOGVcrt6r9MZflEk+860Qdfe
VMzZhWdkTnxDa6VlzR6aDn+B9QjD1WeFq8BzbXfj9ZEpBO0In47lvV4bji5X9j3J
W+I+arC7D1kgpm4/jR19PFjFEt7jugsQawrxZ2YWRsJzXETwZChaNuB7a+UfRPjS
rJ9tGbGotVhMk7YE80xJ+y/dTYel0EA2xZTYqeiwYCbz6OHamiulA12tuTqcGH0J
/zDIBYHc4rTpf3gPYziib4DjJbvVcTKCj8MO3zwcDDVPAEcaojGihutzAgMBAAGj
cDBuMAwGA1UdEwEB/wQCMAAwHQYDVR0OBBYEFMdDv0ugrgZ5am6gXe/fnqA2Qfqs
MAwGA1UdDwQFAwMHsIAwEQYJYIZIAYb4QgEBBAQDAgWgMB4GCWCGSAGG+EIBDQQR
Fg94Y2EgY2VydGlmaWNhdGUwDQYJKoZIhvcNAQELBQADggIBALnTkX2ks56QN4i6
VifDhpHe5axVBFGJlTayNdi/9E1AeQeFrJNB4mOjGzApEGT0AYQK60G9naRqJ/ZZ
J3SaGe8GyyGjT/KNkyTKLtksWEGc0m2oZqAzRyqDTt6QjCRoRprGOgAMnsGNUTDy
dktaJcrgSXCCuqgvZ88Zgwi6UBSYyq46vDUQNrwOf7ZZBj8V2ciqcMoiPpoHh/9/
+YvVkUAiu1yH2yV4DLgn6MgqT5VNvH8ZBE8Cs7WPLgoCg3Pr38Nkt5Ke29KC1f49
cUpO42JiwJvw9gmy22qykFrNIgwgvyv+MZtvVjH8m76j6GLquEo5wGVncUCNZn16
Gru+cI1yTFP8ej1osApoYJADMhshEBOWJzG6C4VUIWagmPX8UZ7vC8AVRAMXRe9B
Yeg5XNlegS+mXiz02ErrItmpR91FxiTaGouYWkLG7ZJV6g2+zCc/9aqq6gGDpkYK
JcO+Y0RFSRfugoVLMvS7pJ2w3pSwCtwZih/3ySCdkKRNkihUe1AyzvKudNFfHEsi
TEQX4v1O/saZIz/9LNZUWnPVhrNG3Yn/JO4VWGk+o6cH1xS6KBYe6UTBujqt3RAd
m4gD/wnEfXplDEfnzIDlz8pwT8MuKxBwd+IuhDsLb0oLqqKfV9dm6g6+YC6tlOt3
3ltQC7Jz+vs5BrFe0WVI8qGeHfXE
-----END CERTIFICATE-----
EOD;

    ///////////////////// CERTIFICATI DI PRODUZIONE ////////////////
/*
    $privateKey = <<<EOD
-----BEGIN RSA PRIVATE KEY-----
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
-----END RSA PRIVATE KEY-----
EOD;

    $publicKey = <<<EOD
-----BEGIN CERTIFICATE-----
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
-----END CERTIFICATE-----
EOD;

    $publicKeyAlternativa_NON_USARE_se_certificato_funziona = <<<EOD
-----BEGIN PUBLIC KEY-----
MIICIjANBgkqhkiG9w0BAQEFAAOCAg8AMIICCgKCAgEAw4QQSa6Sg1zakc8DjZBh
SL/ayrhJoUMNQzcbwOTyGFi8ILdtwNkDvCwg9Hk8PHkbM/t/96vKXt8KCuU3U3xN
gnDabG//LV/QQH4Xt303s4LcAjEJOo24hcz0PTcLnrZssQKsTDWSol/bgr5cXpRy
iUjrOo8IeLbl++ANoa7u1L1jlpXaJ2aa4du0CnylUWgfF2Zgiuc1Sb5XHV4UyLv2
AqrGswb8HTD17LzJQ/XQi/TvdBWIT0kJmjKezHHKRP89OOclGlAHjbYFCgHuMUAH
OdeIvb+qHGGAB8VGDol/OTxyKpgw3bIXHkI/hmYJBbvD3U4l5ICUBnORtet7wKi0
JLFSqEd2jt6xhMUPXfW7dZZsOgER2qCgphsh7+rcotm9HBcQmuruLm/Lnfqr9U3E
Z/A+UKXGN6Q0jGYFLsM/fzJmxdn+DzPlVD77t9zlq1D7wZ2SQip7UIIUEDDrKscM
4jMjeP96VsrpGWrED+7pGLiWip4uOQVUFwl+JbSDUHUzQQuMRbneWx4HOU9HDQOf
YjN6Q571PFJBKO9ZAChAJUI09OAjmtvgsJCF35bmD5sMv1GhcJz8Ia7orEwXsE4N
Ot8+b+WoOWXFK5jQ1ypo+uTHrOwUcKCg2DTv+ahiwixVuxp4wJb4dAqDmtz4UXjf
81K3O9K6/XFLhs1m3ylbtHMCAwEAAQ==
-----END PUBLIC KEY-----
EOD;
*/
    ////////////////////////////////////////////////////////////////

    $certificatePEM = $publicKey;
    $certificatePEM = str_replace("-----BEGIN PUBLIC KEY-----", "", $certificatePEM);
    $certificatePEM = str_replace("-----END PUBLIC KEY-----", "", $certificatePEM);
    $certificatePEM = str_replace("-----BEGIN CERTIFICATE-----", "", $certificatePEM);
    $certificatePEM = str_replace("-----END CERTIFICATE-----", "", $certificatePEM);
    $certificatePEM = str_replace("\r", "", $certificatePEM);
    $certificatePEM = str_replace("\n", "", $certificatePEM);

///////////////////////////////////////////////

    global $babelHost;
    $babelHost = "babelhg.ausl.bologna.it"; //devel
    //$babelHost = "babel-bridge.ausl.bologna.it"; //prod

    $extraHeaders = array();
    $extraHeaders["typ"] = "JWT";
    $extraHeaders["x5c"] = array($certificatePEM);

    $jwt = JWT::encode($payload, $privateKey, 'RS256', null, $extraHeaders);
    return $jwt;
}