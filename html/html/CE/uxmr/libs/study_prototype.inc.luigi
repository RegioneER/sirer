<?php
include_once "xmrwf.inc.php";
/**
 * Clase Prototipo di gestione dello Studio
 *
 * @package CORE
 */
class Study_prototype {
	var $xml_dir;
	var $service;
	var $visit_structure_xml;
	/**
	 * Connessione al DB
	 *
	 * @var dbconn
	 */
	var $conn;
	//var $centers;
	/**
	* Variabile Centro
	*
	* @var String
	*/
	var $center;
	var $vlist;
	/**
	 * Nome delle form
	 *
	 * @var array
	 */
	var $es_name;
	/**
	 * specifiche form
	 *
	 * @var array
	 */
	var $es_form;
	var $patient_table;
	var $session_vars;
	/**
	 * Codice html del body della pagina
	 *
	 * @var String
	 */
	var $body;
	var $onload;
	var $script;
	var $percorso;
	var $user;
	/**
	 * Parametri di configurazione del servizio
	 *
	 * @var array
	 */
	var $config_service;
	var $uploaded_file_dir;
	var $workflow;
	var $pk_service;
	var $mostra_ana_comune;
	var $lang = 'it';
	var $testi;
	var $hrefs;
	/**
	 * Parametri di configurazione
	 *
	 * @var array
	 */
	var $config;
	var $vlist_root;
	var $xmr_root;
	var $notifica;
	/**
	 * Errori
	 *
	 * @var array
	 */
	var $errors;
	/**
	 * Oggetti equery
	 *
	 * @var array
	 */
	var $equery_objs;
	var $integrazione;
	/**
	 * Multi profilo
	 * $profile_id @number
	 * $gestori @Array
	 */
	var $profile_id;
	var $admin_profili;
	var $user_profili;
	var $admin_profili_html;
	/**
	 * Footer della homepage
	 *
	 * @var String
	 */
	var $footer = "
			<table width=\"100%\" >
				<tr>
					<td align=\"center\">
						In collaboration with: <br/><a href=\"http://www.cineca.it/\"><img src=\"/images/logoblu.gif\" alt=\"\" /></a><br/></a>
					</td>
				</tr>
			</table>";

	/**
	 * Gestisce i testi configurabili
	 *
	 * @param String $testo
	 * @return String
	 */
	function testo($testo) {
		//TODO: mettere $this->config_service ['Lista_schede'] nelle frasi in modo da configurarle dallo study.xml


		//HOW TO
		/* Per utilizzare questa funzione chiamarla cosi nel codice:
		* $this->testo("PAROLACHIAVE")
		* e qui dentro definire per ogni lingua
		* $this->testi['PAROLACHIAVE']="Frase da far apparire";
		*/
		//		print_r($this->config_service);
		if (! isset ( $this->testi [$testo] )) {
			if (strtolower ( $this->config_service ['lang'] ) == 'en') {
				$this->testi ['is incomplete']="is incomplete";
				$this->testi ['The form']="The form";
				$this->testi ['add_form']="Add a new esam";
				$this->testi ['apply_changes']="Apply changes";
				$this->testi ['save_neccessary']="Attention, it is necessary to use the following button in order to apply the changes.";
				$this->testi ['Home'] = "Home";
				$this->testi ['Registro Lista Pazienti'] = "Registry Patients List";
				$this->testi ['Registro Lista Centri'] = "Registry Center List";
				$this->testi ['Vista Paziente'] = "Patient's View";
				$this->testi ['Search'] = "Search";
				$this->testi ['ModifyForm'] = "Modify form";
				$this->testi ['notNecessary'] = "Not necessary";
				$this->testi ['necessary'] = "Necessary";
				$this->testi ['sendAnswer'] = "Send answer";
				$this->testi ['cancel'] = "Cancel";
				$this->testi ['Registry'] = "Registry";
				$this->testi ['Center'] = "Center";
				$this->testi ['Visit'] = "Visit";
				$this->testi ['Esam'] = "Esam";
				$this->testi ['eQueryDate'] = "eQuery Date";
				$this->testi ['eQueryList'] = "eQuery List";
				$this->testi ['newEquery'] = "New eQuery";
				$this->testi ['eQueryType'] = "eQuery Type";
				$this->testi ['eQueryType1'] = "eQuery Type 1";
				$this->testi ['eQueryType2'] = "eQuery Type 2";
				$this->testi ['eQueryTypeNull'] = "eQuery Type Null";
				$this->testi ['Dateofanswer'] = "Date of answer";
				$this->testi ['Modify'] = "Modify";
				$this->testi ['closeDate'] = "close date";
				$this->testi ['ChangeNecessary'] = "Change is necessary";
				$this->testi ['ChangeNotNecessary'] = "Change is not necessary";
				$this->testi ['ChangeMadeAt'] = "Changes made to the";
				$this->testi ['noPatient'] = "There are no patients in this center";
$this->testi ['searchEq'] = "Search eQuery";
				$this->testi ['openedEq'] = "List of open eQueries";
				$this->testi ['openedEqS'] = "Show open eQuery";
				$this->testi ['closedEq'] = "View closed eQueries";
				$this->testi ['closedEqL'] = "List of closed eQueries 	";
$this->testi ['allEq'] = "View all eQueries";
				$this->testi ['alldEqL'] = "List of all eQuery";
				$this->testi ['newEq'] = "New eQuery";
				$this->testi ['sendedEq'] = "eQuery Sent";
				$this->testi ['receivedEq'] = "eQuery Received";
				$this->testi ['visualizzaScheda'] = "Show form";
				$this->testi ['userNotCenter'] = "USER NOT IN CENTER LIST";
				//LUIGI: controllo sui diritti di cancellazione
				$this->testi ['NOTDELETABLE'] = "No rights to delete the esam or visit";
				//LUIGI: controllo sui diritti di creazione
				$this->testi ['NOTCREABLE'] = "No rights to create the visit";
				$this->testi ['userNotHaveCenter'] = "USER CAN'T VIEW THIS CENTER: AUTHORIZATION DENIED";
				$this->testi ['badRequest'] = "THE REQUEST IS NOT PROPERLY FORMED, THEREFORE IT CANNOT BE PROCESSED.";
				$this->testi ['mismatchedCenter'] = "MISMATCHED CENTER AND PATIENT: AUTHORIZATION DENIED";
				$this->testi ['schedaInviata'] = "<p align=center><b>This form has been sent !!!<br>Impossible to modify</p>";
				$this->testi ['Lista completa'] ="Complete patient's view";
				$this->testi ['gest_prof'] ="Profile Administration";
			} else {
			    $this->testi ['is incomplete']="&egrave; incompleta";
                $this->testi ['The form']="La scheda";
				$this->testi ['Paziente']="Paziente";
				$this->testi ['add_form']="Aggiungi nuova scheda";
				$this->testi ['apply_changes']="Applica Modifiche";
				$this->testi ['save_neccessary']="Attenzione &egrave; necessario applicare le modifiche con il pulsante apposito";
				$this->testi ['Home'] = "Home";
				$this->testi ['Registro Lista Pazienti'] = "Registro Lista Pazienti";
				$this->testi ['Registro Lista Centri'] = "Registro Lista Centri";
				$this->testi ['Vista Paziente'] = "Vista Paziente";
				$this->testi ['Search'] = "Cerca";
				$this->testi ['ModifyForm'] = "Modifica della form";
				$this->testi ['notNecessary'] = "Non necessaria";
				$this->testi ['necessary'] = "Necessaria";
				$this->testi ['sendAnswer'] = "Invia risposta";
				$this->testi ['cancel'] = "Annulla";
				$this->testi ['Registry'] = "Registro";
				$this->testi ['Center'] = "Centro";
				$this->testi ['Visit'] = "Visita";
				$this->testi ['Esam'] = "Esame";
				$this->testi ['eQueryDate'] = "Data eQuery";
				$this->testi ['eQueryList'] = "Lista eQuery";
				$this->testi ['newEquery'] = "Nuova eQuery";
				$this->testi ['eQueryType'] = "Tipo eQuery";
				$this->testi ['eQueryType1'] = "Modifica dati";
				$this->testi ['eQueryType2'] = "Quesito clinico";
				$this->testi ['eQueryTypeNull'] = "Classificazione non effettuata";
				$this->testi ['Dateofanswer'] = "Data risposta";
				$this->testi ['Modify'] = "Modifica";
				$this->testi ['closeDate'] = "Data di chiusura";
				$this->testi ['ChangeNecessary'] = "Modifica necessaria";
				$this->testi ['ChangeNotNecessary'] = "Modifica non necessaria";
				$this->testi ['ChangeMadeAt'] = "Modifica effettuata il";
				$this->testi ['noPatient'] = "Non ci sono pazienti in questo centro";
				$this->testi ['searchEq'] = "Cerca eQuery";
				$this->testi ['openedEq'] = "Lista eQuery aperte";
				$this->testi ['openedEqS'] = "Vedi eQuery aperte";
				$this->testi ['closedEq'] = "Vedi eQuery chiuse";
				$this->testi ['closedEqL'] = "Lista eQuery chiuse";
				$this->testi ['allEq'] = "Vedi tutte le eQuery";
				$this->testi ['allEqL'] = "Lista di tutte le eQuery";
				$this->testi ['newEq'] = "Nuova eQuery";
				$this->testi ['sendedEq'] = "eQuery Inviate";
				$this->testi ['receivedEq'] = "eQuery Ricevute";
				$this->testi ['visualizzaScheda'] = "Visualizza scheda";
				$this->testi ['userNotCenter'] = "UTENTE NON ABILITATO ALLA VISIONE DI QUESTO CENTRO";
				//LUIGI: controllo sui diritti di cancellazione
				$this->testi ['NOTDELETABLE'] = "Non si hanno i diritti necessari per cancellare la scheda o la visita progressiva";
				//LUIGI: controllo sui diritti di creazione
				$this->testi ['NOTCREABLE'] = "Non si hanno i diritti necessari per creare la visita progressiva";
				$this->testi ['userNotForm'] = "UTENTE NON ABILITATO ALLA VISIONE DI QUESTA SCHEDA";
				$this->testi ['userNotHaveCenter'] = "UTENTE NON ABILITATO ALLA VISIONE DI QUESTO CENTRO";
				$this->testi ['badRequest'] = "LA RICHIESTA E' MAL FORMATA, PERTANTO NON PUO' ESSERE VALUTATA.";
				$this->testi ['mismatchedCenter'] = "PAZIENTE NON AFFERENTE AL CENTRO: AUTORIZZAZIONE NEGATA";
				$this->testi ['schedaInviata'] = "<p align=center><b>La scheda e' gia stata inviata!!!<br>Impossibile modificarla</p>";
				$this->testi ['Lista completa'] ="Lista completa delle schede del Paziente";
				$this->testi ['gest_prof'] ="Gestione profili";
			}
			if ($this->config_service ['Patients_list'] != '')
				$this->testi ['Registro Lista Pazienti'] = $this->config_service ['Patients_list'];

		}
		return $this->testi [$testo];
	}

	/**
	 * Costruttore
	 *
	 * @param String $xml_dir
	 * @param String $service
	 * @param String $visit_structure_xml
	 * @param dbconn $conn
	 * @param array $session_vars
	 * @param array $config_service
	 * @param String $user
	 * @param boolean $configure
	 * @param unknown_type $workflow_name
	 * @return Study_prototype
	 */
	function Study_prototype($xml_dir=null, $service=null, $visit_structure_xml=null, $conn=null, $session_vars=null, $config_service=null, $user=null, $configure = false, $workflow_name = null) {
		$this->xml_dir = $xml_dir;
		$this->uploaded_file_dir = preg_replace ( "!xml$!", "uploaded_file", $xml_dir );
		$this->service = $service;
		$this->visit_structure_xml = $visit_structure_xml;
		$this->conn = $conn;
		$this->session_vars = $session_vars;
		$this->config_service = $config_service;
		if (isset ( $this->config_service ['lang'] ))
		$this->lang = $this->config_service ['lang'];
		else
		$this->config_service ['lang'] = $this->lang;
		$this->user = $user;
		//flag per attivare/disattivare le equery
		$this->notifica = true;

		$sql_center = "select uc.CENTER, uc.TIPOLOGIA from {$this->service}_UTENTI_CENTRI uc where uc.userid='{$this->session_vars['remote_userid']}'";
		$sql = new query ( $this->conn );
		$sql->get_row ( $sql_center );
		$this->center = $sql->row ['CENTER'];

		$exams = $this->visit_structure_xml;
		//		echo $this->xml_dir;
		if ($this->xmr->depth > 0)
		$dir = str_replace ( "/" . $this->service, "", $this->xml_dir );
		else
		$dir = $this->xml_dir;

		$this->xmr_root = new xmrwf ( "study.xml", $conn );
		$this->xmr_root->setConfigParam ( true );
		$this->config = $this->xmr_root->getConfigService ();
		$this->config_service['service_root'] = $this->xmr_root->prefix;
		$this->config['mostraDataInvio']=$this->config_service['mostraDataInvio'];
		//var_dump($dir . '/' . $exams);
		$this->vlist_root = new xml_esams_list ( $dir . '/' . $exams, $this->config, $this->session_vars, $this->conn ,$this->xmr_root->dir.'/xml');

		if (isset ( $this->session_vars [$this->config_service ['PK_SERVICE']] ))
		$this->pk_service = $this->session_vars [$this->config_service ['PK_SERVICE']];

//		$test_date1=date("H:i:s.u");
//		
		if (isset ( $workflow_name )) {
			include_once "WF/bootstrap.inc.php";
			$sql_query = "select id from workflow where descr='$workflow_name'";

			$sql = new query ( $this->conn );
			$sql->get_row ( $sql_query );
			$this->workflow = new WF_PROTOTYPE ( $this->conn, $this->session_vars, $sql->row ['ID'], $this );

			$this->getAdminProfili();

		}
//		$test_date2=date("H:i:s.u");
//		
		if ($configure) {
			$this->CheckXMR ();
			return;
		}


		$this->VisitStructure ();
		$this->CheckVisione ();
		$this->VisitStructure ();
		$this->checkStudyConsistence ();
		if (isset($this->config_service['eQuery']) && $this->config_service['eQuery']==1){
			if (isset($this->pk_service)) $this->integrazione=new integrazioni($this->config_service, $this->conn, $this->user->userid, $this->user->profilo, $this->session_vars ['USER_TIP'],$this->session_vars);
		}
	}
	
	function checkStudyConsistence(){
        if(isset($this->config_service['checkConsistence']) && $this->config_service['checkConsistence']) {
            if (((
                    (isset($_GET['ESAM']) && $_GET['ESAM']!='') && 
                    (isset($_GET['PROGR']) && $_GET['PROGR']!='') &&
                    (isset($_GET['VISITNUM']) && $_GET['VISITNUM']!='')
                ) || (
                        (isset($_POST['ESAM']) && $_POST['ESAM']!='') &&
                        (isset($_POST['PROGR']) && $_POST['PROGR']!='') &&
                        (isset($_POST['VISITNUM']) && $_POST['VISITNUM']!='')
                        )
            ) && $this->pk_service != 'next')
            {
                if ((isset($_GET['ESAM']) && $_GET['ESAM']!='') && 
                    (isset($_GET['VISITNUM']) && $_GET['VISITNUM']!='')) {
                    $visit=$_GET['VISITNUM'];
                    $esam=$_GET['ESAM'];
                    $progr=$_GET['PROGR'];
                    $vprog=$_GET['VISITNUM_PROGR'];
                    $form=$_GET['form'];
                }
                if ((isset($_POST['ESAM']) && $_POST['ESAM']!='') &&
                        (isset($_POST['VISITNUM']) && $_POST['VISITNUM']!='')) {
                    $visit=$_POST['VISITNUM'];
                    $esam=$_POST['ESAM'];
                    $progr=$_POST['PROGR'];
                    $vprog=$_POST['VISITNUM_PROGR'];
                    $form=$_POST['form'];
                }
                $esamSpec=$this->vlist->esams[$visit][$esam];
                
                if (!isset($this->vlist->esams[$visit][$esam])){
                    error_page($this->user->userid, "Errore!!! Scheda non esistente", "Errore!!! Scheda non esistente");
                }
                if ($esamSpec['PROGR']=='' || strtoupper($esamSpec['PROGR'])!=strtoupper("yes")){
                    $progr-=0;
                    if ($progr>1) {
                        error_page($this->user->userid, "Errore!!! Scheda non progressiva", "Errore!!! Scheda non progressiva");
                    }
                }
                $visitSpec=$this->vlist->visitnums[$visit];
                
                if ($visitSpec['PROGR']=='' || strtoupper($visitSpec['PROGR'])!=strtoupper("yes")){
                    $vprog-=0;
                    if ($vprog>0) {
                        error_page($this->user->userid, "Errore!!! Visita non progressiva", "Errore!!! Visita non progressiva");
                    }
                }
                if (isset($form) && $form!='' && $esamSpec['XML']!=$form){
                    error_page($this->user->userid, "Errore! File xml non consistente!", "");
                }
                $sql_abilitato_1="select max(abilitato) as ABILITATO from {$this->service}_COORDINATE where {$this->config_service['PK_SERVICE']}=:pk_service and esam=:esam and visitnum=:visitnum and visitnum_progr=:visitnum_progr";
                $binded['esam']=$esam;
                $binded['visitnum']=$visit;
                $binded['visitnum_progr']=$vprog;
                $binded['pk_service']=$this->pk_service;
                $sql=new query($this->conn);
                $enabled=false;
                
                
                if ($sql->get_row($sql_abilitato_1, $binded)) {
                    if ($sql->row['ABILITATO']==1) $enabled=true;
                }
                
                if (isset($esamSpec['CORR'])){
                    $sql_corr_query="select fine as FINE from {$this->service}_COORDINATE where {$this->config_service['PK_SERVICE']}=:pk_service and esam=:esame_corr and visitnum=:visitnum and visitnum_progr=:visitnum_progr and progr=:progr";
                    $bind['visitnum']=$visit;
                    $bind['visitnum_progr']=$vprog;
                    $bind['progr']=$_GET['PROGR'];
                    $bind['esame_corr']=$esamSpec['CORR'];
                    $bind['pk_service']=$this->pk_service;
                    $sql_corr=new query($this->conn);
                    $sql_corr->get_row($sql_corr_query, $bind);
                    if($sql_corr->row['FINE']==1) {
                        $enabled=true;
                    }
                }
                
                if ($esam!=0 && !$enabled){
                    error_page($this->user->userid, "Errore! Scheda non abilitata!", "");
                }
            }
        }
        else{
            return;
        }
    }

	/**
	 * Restituisce lo stato (WF) dell'oggetto di studio
	 *
	 * @param String $prefix
	 * @return number
	 */
	function GetStato($prefix = null) {
		if (! isset ( $prefix ))
		$prefix = $this->workflow->prefix;
		$stato = new WF_STATO ( $this->conn, null, $this->workflow->prefix );
		if ($this->pk_service == '' || $this->pk_service == 'next') {
			$id_stato = 1;
			return $id_stato;
		}
		$sql_query = "select ID_STATO from {$prefix}_STATO where PK_SERVICE={$this->pk_service}";
		$sql = new query ( $this->conn );
		if ($sql->get_row ( $sql_query )) {
			$id_stato = $sql->row ['ID_STATO'];
		} else
		$id_stato = 1;
		return $id_stato;
	}

	/**
	 * Abilita la visita
	 *
	 * @param number $visita
	 * @param number $visitnum_progr
	 * @return boolean
	 */
	function abilita_visita($visita, $visitnum_progr = '0') {

		$sql = new query ( $this->conn );
		foreach ( $this->vlist->esams [$visita] as $key => $val ) {
			if ($val ['DEFAULT'] == 'yes') {

				$array [$this->config_service ['PK_SERVICE']] = $this->pk_service;
				$array ['VISITNUM'] = $visita;
				$array ['VISITNUM_PROGR'] = $visitnum_progr;
				$array ['ESAM'] = $key;
				$array ['PROGR'] = 1;
				$array ['ABILITATO'] = 1;
				$table = $this->service . "_COORDINATE";
				$sql->insert ( $array, $table, null, true );
			}
		}

		return $this->conn->commit ();
	}

	/**
	 * Elimina visita progressiva (obsoleta)
	 *
	 * @param number $visita
	 * @param number $visitnum_progr
	 * @return boolean
	 */
	function elimina_visita_progr($visita, $visitnum_progr = '0') {
		if ($visitnum_progr != '0') {
			$sql = new query ( $this->conn );
			$str = "delete from {$this->service}_coordinate where visitnum=$visita and visitnum_progr=$visitnum_progr and {$this->config_service['PK_SERVICE']}='$this->pk_service'";
			$str = "delete from {$this->service}_coordinate 
				where visitnum=:visitnum and visitnum_progr=:visitnum_progr and {$this->config_service['PK_SERVICE']}=:pk_service"; //binded
			$bindVars["visitnum"]=$visita;
			$bindVars["visitnum_progr"]=$visitnum_progr;
			$bindVars["pk_service"]=$this->pk_service;
			$sql->ins_upd ( $str , $bindVars); //binded
		}
		return $this->conn->commit ();
	}

	/**
	 * Controlla la struttura dell'XMR
	 *
	 */
	function CheckXMR() {
		$this->body = "<p class=titolo>Configuration tool</p>";
		$do_command ['storico_id_seq'] [0] = "
			create sequence STORICO_ID
				minvalue 1
				maxvalue 99999999
				start with 21
				increment by 1
				cache 20
		";
		$do_command ['coordinate'] [0] = "
			create table {$this->service}_COORDINATE
			(
			  VISITNUM       NUMBER(2) not null,
			  VISITNUM_PROGR NUMBER(3) not null,
			  PROGR          NUMBER(3) not null,
			  ESAM           NUMBER(2) not null,
			  INIZIO         NUMBER(1),
			  FINE           NUMBER(1),
			  INSERTDT       DATE,
			  MODDT          DATE,
			  USERID         VARCHAR2(20),
			  VISITCLOSE     NUMBER(1) default 0,
			  INV_QUERY      VARCHAR2(200),
			  {$this->config_service['PK_SERVICE']}        NUMBER not null,
			  ABILITATO      NUMBER
			)
		";
			  $do_command ['coordinate'] [1] = "
			alter table {$this->service}_COORDINATE
  			add constraint PK_{$this->service}_COORDINATE primary key (VISITNUM, VISITNUM_PROGR, ESAM, {$this->config_service['PK_SERVICE']}, PROGR)
		";
			  $do_command ['equery'] [0] = "
  			create table {$this->service}_EQUERY
			(
			  ID             NUMBER not null,
			  CENTER         VARCHAR2(10),
			  {$this->config_service['PK_SERVICE']}        NUMBER,
			  VISITNUM       NUMBER,
			  VISITNUM_PROGR NUMBER(3) not null,
			  ESAM           NUMBER,
			  PROGR          NUMBER,
			  Q_USERID       VARCHAR2(20),
			  QUESTION       VARCHAR2(400),
			  QUEST_DT       DATE,
			  TO_BE_VALIDATE NUMBER,
			  ANSWER         VARCHAR2(400),
			  ANS_DT         DATE,
			  A_USERID       VARCHAR2(20),
			  VALIDATA       NUMBER,
			  CHIUSA         NUMBER,
			  VAL_DT         DATE,
			  VAL_USERID     VARCHAR2(20)
			)
  		";
			  $do_command ['equery'] [1] = "
			alter table {$this->service}_EQUERY
  			add constraint PK_{$this->service}_EQUERY primary key (ID)
			";
			  $sql_query = "select count(*) as conto from user_all_tables where table_name='{$this->service}_COORDINATE'";

			  $sql = new query ( $this->conn );
			  $sql->set_sql ( $sql_query );
			  $sql->exec ();//non richiede binding
			  $sql->get_row ();

			  if ($sql->row ['CONTO'] == 0) {
			  	foreach ( $do_command ['coordinate'] as $key => $val ) {
			  		$sql->set_sql ( $val );
			  		$sql->ins_upd (); //bind non necessario
			  		$this->body .= "<li>Tabella coordinate creata</li>";
			  	}
			  } else {
			  	$this->body .= "<li>Tabella coordinate gi&agrave; presente</li>";
			  }
			  $sql_query = "select count(*) as conto from user_all_tables where table_name='{$this->service}_EQUERY'";
			  $sql = new query ( $this->conn );
			  $sql->set_sql ( $sql_query );
			  $sql->exec ();//non richiede binding
			  $sql->get_row ();
			  if ($sql->row ['CONTO'] == 0) {
			  	foreach ( $do_command ['equery'] as $key => $val ) {
			  		$sql->set_sql ( $val );
			  		$sql->ins_upd (); //bind non necessario
			  		$this->body .= "<li>Tabella equery creata</li>";
			  	}
			  } else {
			  	$this->body .= "<li>Tabella equery gi&agrave; presente</li>";
			  }
			  $sql_query = "select count(*) as conto from user_sequences where sequence_name='STORICO_ID'";
			  $sql = new query ( $this->conn );
			  $sql->set_sql ( $sql_query );
			  $sql->exec ();//non richiede binding
			  $sql->get_row ();
			  if ($sql->row ['CONTO'] == 0) {
			  	foreach ( $do_command ['storico_id_seq'] as $key => $val ) {
			  		$sql->set_sql ( $val );
			  		$sql->ins_upd (); //bind non necessario
			  		$this->body .= "<li>Sequence storico_id creata</li>";
			  	}
			  } else {
			  	$this->body .= "<li>Sequence storico_id gi&agrave; presente</li>";
			  }
			  if ($this->config_service ['PK_SEQ'] != '') {
			  	$do_command ['pk_seq'] [0] = "
				create sequence {$this->service}_PK_SEQ
					minvalue 1
					maxvalue 99999999
					start with 1
					increment by 1
					cache 20
			";
			  	$sql_query = "select count(*) as conto from user_sequences where sequence_name='{$this->service}_PK_SEQ'";
			  	$sql = new query ( $this->conn );
			  	$sql->set_sql ( $sql_query );
			  	$sql->exec ();//non richiede binding
			  	$sql->get_row ();
			  	if ($sql->row ['CONTO'] == 0) {
			  		foreach ( $do_command ['pk_seq'] as $key => $val ) {
			  			$sql->set_sql ( $val );
			  			$sql->ins_upd (); //bind non necessario
			  			$this->body .= "<li>Sequence {$this->service}_PK_SEQ creata</li>";
			  		}
			  	} else {
			  		$this->body .= "<li>Sequenze {$this->service}_PK_SEQ gi&grave; presente</li>";
			  	}
			  }
			  if ($this->config_service ['ROLE_TB'] != '') {
			  	$do_command ['RULE_TB'] = "
				create table {$this->service}_ROLE(
					ID number,
					ROLE varchar2(40),
					WHERE_ varchar2(4000)
				)
			";
			  	$sql_query = "select count(*) as conto from user_all_tables where table_name='{$this->service}_ROLE'";
			  	$sql = new query ( $this->conn );
			  	$sql->set_sql ( $sql_query );
			  	$sql->exec ();//non richiede binding
			  	$sql->get_row ();
			  	if ($sql->row ['CONTO'] == 0) {
			  		$sql->set_sql ( $do_command ['RULE_TB'] );
			  		$sql->ins_upd (); //bind non necessario
			  		$this->body .= "<li>Tabella ROLE creata</li>";
			  	} else {
			  		$this->body .= "<li>Tabella ROLE gi&agrave; presente</li>";
			  	}
			  	if (isset ( $_GET ['DEL_ROLE_ID'] ) && $_GET ['DEL_ROLE_ID'] != '') {
			  		$sql_delete = "delete from {$this->service}_ROLE where ID=:id"; //binded
			  		$bindVars="";
			  		$bindVars["id"]=$_GET['DEL_ROLE_ID'];
			  		$sql->ins_upd ( $sql_delete, $bindVars ); //binded
			  		$this->conn->commit ();
			  		die ( "<html><head><meta http-equiv=\"refresh\" content=\"0;url=ssup.php\"></head></html>" );
			  	}
			  	if (isset ( $_GET ['ADD_ROLE'] ) && $_GET ['ADD_ROLE'] != '') {
			  		$sql_max = "select max(id) as maxid from {$this->service}_ROLE";
			  		$sql->set_sql ( $sql_max );
			  		$sql->exec ();//non richiede binding
			  		$sql->get_row ();
			  		$max = $sql->row ['MAXID'] - 0;
			  		$max ++;
			  		$sql_insert = "insert into {$this->service}_ROLE (ID, ROLE) values ($max, '{$_GET['ADD_ROLE']}')";
			  		$sql_insert = "insert into {$this->service}_ROLE (ID, ROLE) values (:max, :add_role)";  //binded
			  		$bindVars="";
			  		$bindVars["max"]=$max;
			  		$bindVars["add_role"]=$_GET['ADD_ROLE'];
			  		$sql->ins_upd ( $sql_insert, $bindVars ); //binded
			  		$this->conn->commit ();
			  		die ( "<html><head><meta http-equiv=\"refresh\" content=\"0;url=ssup.php\"></head></html>" );
			  	}
			  	if (isset ( $_POST ['modwhere'] )) {
			  		foreach ( $_POST as $key => $val ) {
			  			if (preg_match ( "!_WHERE_$!", $key )) {
			  				$WHERE_ = $val;
			  				$WHERE_ = str_replace ( "\\'", "''", $WHERE_ );

			  				$id = str_replace ( "_WHERE_", "", $key );
			  				$pk ['ID'] = $id;
			  				$sql_update = "update {$this->service}_ROLE set WHERE_='{$WHERE_}' where id=$id";
			  				$sql_update = "update {$this->service}_ROLE set WHERE_=:where_ where id=:id";
			  				$bindVars="";
			  				$bindVars["where_"]=$WHERE_;
			  				$bindVars["id"]=$id;
			  				$sql->ins_upd ( $sql_update, $bindVars ); //binded
			  			}
			  		}
			  		$this->conn->commit ();
			  		die ( "<html><head><meta http-equiv=\"refresh\" content=\"0;url=ssup.php\"></head></html>" );
			  	}
			  	if (isset ( $_GET ['ROLE_VIEW'] )) {

			  		$sql_view = "
				create or replace view {$this->service}_utenti_centri as
				";
			  		$sql_query = "select * from {$this->service}_ROLE";
			  		$sql->set_sql ( $sql_query );
			  		$sql->exec ();//non richiede binding
			  		while ( $sql->get_row () ) {
			  			if ($sql_view_ != '')
			  			$sql_view_ .= "
						union
						";
			  			$sql_view_ .= "
						select a.userid, c.center as center, '{$sql->row['ROLE']}' as tipologia
			    		from ana_utenti a, {$this->service}_centri c where {$sql->row['WHERE_']}
					";
			  		}
			  		$sql_view .= $sql_view_;
			  		$sql->ins_upd ($sql_view); //bind non necessario
			  		die ( "<html><head><meta http-equiv=\"refresh\" content=\"0;url=ssup.php\"></head></html>" );
			  	}
			  	$sql_query = "select * from {$this->service}_ROLE";
			  	$sql->set_sql ( $sql_query );
			  	$sql->exec ();//non richiede binding
			  	$this->body .= "<form method=post>
			<input type='hidden' name='modwhere' value='yes'>
				<table border=1 cellpadding=0 cellspacing=0 width=98%>
					<tr>
						<td>Elimina</td>
						<td>Ruolo</td>
						<td colspan=2>Where</td>
					</tr>
			";
			  	while ( $sql->get_row () ) {
			  		$this->body .= "
					<tr>
						<td><a href=\"ssup.php?DEL_ROLE_ID={$sql->row['ID']}\">elimina</a></td>
						<td><b>{$sql->row['ROLE']}</b></td>
						<td><textarea cols=40 rows=4 name='{$sql->row['ID']}_WHERE_'>{$sql->row['WHERE_']}</textarea></td>
						<td><b>Attenzione la tabella di anagrafica ha come alias \"a\", quella dei centri invece &egrave; \"c\". Ricordarsi di inserirlo nelle clausole (ad es. a1.userid=c.center)!!!</b></td>
					</tr>
				";
			  	}
			  	if (isset ( $this->workflow )) {
			  		$acts = new WF_ATTORI ( $this->conn, $this->workflow->prefix );
			  		foreach ( $acts->attori as $key => $val ) {
			  			$role [count ( $role )] = $val->getNome ();
			  		}
			  	} else {
			  		$role [0] = "DE";
			  		$role [1] = "DM";
			  		$role [2] = "RO";
			  	}
			  	foreach ( $role as $key => $val ) {
			  		$option_role .= "<option value=\"{$val}\">$val</option>";
			  	}
			  	$this->body .= "
				<tr>
					<td colspan=3>
						<input type='submit' value='salva'>
						<input type='button' value='Rigenera vista' onclick=\"window.location.href='ssup.php?ROLE_VIEW=REG';\">
					</td>
				</tr>
			</table>
			</form>
			<a href=\"#\" onclick=\"document.getElementById('add_role').style.display=''; return false;\">Add role</a>
			<div id='add_role' style=\"display:none\">
				<select onchange=\"window.location.href=window.location.href+'?ADD_ROLE='+this.value;\">
					<option></option>
					$option_role
				</select>
			</div>
			";
			  }
			  if ($this->config_service ['CENTER_TB'] != '') {
			  	$do_command ['CENTER_TB'] = "
				create table {$this->service}_CENTER_TB(
					WHERE_ varchar2(4000)
				)
			";
			  	$sql_query = "select count(*) as conto from user_all_tables where table_name='{$this->service}_CENTER_TB'";
			  	$sql = new query ( $this->conn );
			  	$sql->set_sql ( $sql_query );
			  	$sql->exec ();//non richiede binding
			  	$sql->get_row ();
			  	if ($sql->row ['CONTO'] == 0) {
			  		$sql->ins_upd ($do_command ['CENTER_TB'] ); //bind non necessario
			  		$this->body .= "<li>Tabella CENTER_TB creata</li>";
			  	} else {
			  		$this->body .= "<li>Tabella CENTER_TB gi&agrave; presente</li>";
			  	}
			  	if (isset ( $_POST ['modcenter'] )) {
			  		$sql_delete = "delete from {$this->service}_CENTER_TB";
			  		$sql->ins_upd ($sql_delete); //bind non necessario
			  		$this->conn->commit ();
			  		$where_ = str_replace ( "\\'", "'", $_POST ['WHERE_'] );
			  		$WHERE_ = str_replace ( "\\'", "''", $_POST ['WHERE_'] );
			  		$sql_insert = "insert into {$this->service}_CENTER_TB (WHERE_) values ('$WHERE_')";
			  		$sql_insert = "insert into {$this->service}_CENTER_TB (WHERE_) values (:where_)"; //binded
			  		$bindVars="";
			  		$bindVars["where_"]=$WHERE_;
			  		$sql->ins_upd ( $sql_insert, $bindVars );//binded
			  		$this->conn->commit ();
			  		$sql_view = "
				create or replace view {$this->service}_centri as
					select userid as center, azienda_ente as denom, userid as resp_userid
					from ana_utenti
					where $where_
				";
			  		$sql->ins_upd ($sql_view); //bind non necessario
			  		die ( "<html><head><meta http-equiv=\"refresh\" content=\"0;url=ssup.php\"></head></html>" );
			  	}
			  	$sql_query = "select * from {$this->service}_CENTER_TB";
			  	$sql->set_sql ( $sql_query );
			  	$sql->exec ();//non richiede binding
			  	$sql->get_row ();
			  	$this->body .= "<form method=POST>
				Clusola di where<br>
				<input type='hidden' name='modcenter' value='yes'>
				<textarea name=\"WHERE_\" cols=\"40\" rows=\"4\">{$sql->row['WHERE_']}</textarea>
				<br>
				<input type=\"submit\" value=\"Salva e rigenera la vista\">
			</form>
			";
			  }
	}

	/**
	 * Controlli sulla visione dell'utente
	 *
	 */
	function CheckVisione() {
		$conn = $this->conn;
		$service = $this->service;
        
		$remote_userid = $this->user->userid;
		$in = $this->session_vars;
        if ($this -> config_service['BookPkService'] && (isset($this -> session_vars['INVIOCO']) || $this -> session_vars['CREATE'] == 'Update DB') && $this -> session_vars['ESAM'] === '0') {
            $check_se_nuovo = "select count(*) conto from {$this->service}_REGISTRAZIONE where {$this->config_service['PK_SERVICE']}=:pk_service";
            $query = new query($this -> conn);
            $bind['PK_SERVICE'] = $this -> pk_service;
            $query -> get_row($check_se_nuovo, $bind);
            if ($query -> row['CONTO'] == '0') {
                $pk_service = $this -> pk_service;
                $this -> pk_service = 'next';
                $replaced = true;
            }
        }
		//controllo il centro dell'oggetto (es. paziente o pratica) richiesto
		if($this->pk_service!=''  && $this->pk_service!='next'){
			$check_str="select count(*) vista from user_objects where object_name='{$service}_PK_OBJ_CENTER'";
			$check_query=new query($conn);
			$check_query->set_sql($check_str);
			$check_query->exec();//non richiede binding
			$check_query->get_row();
			if($check_query->row['VISTA']==0){
				//mail("c.contino@cineca.it,g.delsignore@cineca.it", "DA SISTEMARE Errore[".$in['remote_userid']."]","Manca l'oggetto {$service}_PK_OBJ_CENTER","From: ERROR_".$service."@{$_SERVER['SERVER_NAME']}\r\n");
			}else{
				$real_center_str="select center from {$service}_PK_OBJ_CENTER where pk_service=:pk_service";
				$real_center_query=new query($conn);
				//$real_center_query->set_sql($real_center_str);
				unset($bind_pk);
				$bind_pk['PK_SERVICE']=$this->pk_service;
				$real_center_query->exec($real_center_str,$bind_pk);//binded
				$real_center_query->get_row();
				$real_center=$real_center_query->row['CENTER'];
				if($real_center!=$this->session_vars ['CENTER'] && $this->session_vars ['CENTER']!='')
				error_page ( $remote_userid, $this->testo ( "badRequest" ), $this->testo ( "mismatchedCenter" ) );
				else if($this->session_vars ['CENTER']=='')$this->session_vars ['CENTER']=$real_center;
			}

		}
		$query = new query ( $conn );
		$sql = "select uc.CENTER, uc.TIPOLOGIA from " . $service . "_UTENTI_CENTRI uc where uc.userid=:userid";
		unset($bind_userid);
		$bind_userid['USERID']=strtoupper ( $remote_userid );
		$query->exec ($sql,$bind_userid);//binded
		if ($query->numrows == 0)
		error_page ( $remote_userid, $this->testo ( "userNotCenter" ), $this->testo ( "userNotHaveCenter" ) );
		if ($query->numrows == 1) {
			$query->get_row ();
			$this->session_vars ['USER_TIP'] = $query->row ['TIPOLOGIA'];
			if (isset ( $this->session_vars ['CENTER'] ) && $this->session_vars ['CENTER'] != $query->row ['CENTER'])
			error_page ( $remote_userid, $this->testo ( "userNotCenter" ), $this->testo ( "userNotHaveCenter" ) );
			//			if (isset ( $this->session_vars ['CENTER'] ) && $this->session_vars ['CENTER'] != $query->row ['CENTER'] && $in ['SEARCH'] == "")
			if (isset ( $this->center ) && $this->center != $query->row ['CENTER'] && $in ['SEARCH'] == "")
			error_page ( $remote_userid, $this->testo ( "userNotCenter" ), $this->testo ( "userNotHaveCenter" ) );
			$this->session_vars ['CENTER'] = $query->row ['CENTER'];
			$this->centers = "'" . $query->row ['CENTER'] . "'";
		} else {
			$flag_centro=false;
			while ( $query->get_row () ) {
				if ($this->centers != '')
				$this->centers .= ",";
				$this->session_vars ['USER_TIP'] = $query->row ['TIPOLOGIA'];
				$this->centers .= "'" . $query->row ['CENTER'] . "'";
				if($this->session_vars ['CENTER']==$query->row ['CENTER'])$flag_check_centro=true;
			}
			//echo $query->tb_res();
			if(!$flag_check_centro && $this->session_vars ['CENTER']!='')error_page ( $remote_userid, $this->testo ( "userNotCenter" ), $this->testo ( "userNotHaveCenter" ) );
		}
		if (isset ( $this->workflow )) {
			$this->session_vars ['WFact'] = $this->session_vars ['USER_TIP'];
			$stato = new WF_STATO ( $this->conn, null, $this->workflow->prefix );
			$stato->getById ( $this->GetStato () );
			//			print_r($stato);
			$functionCheck = "VisibilitaStato_" . $this->GetStato ();
			$attore_stato = $stato->getAttore ();
			//print_r($attore_stato);

			if (isset ( $this->pk_service ) && $this->pk_service != '' && $attore_stato != '') {
				if (method_exists ( $this, $functionCheck )) {
					$this->{$functionCheck} ();
				}

			}
			if ($attore_stato != '' && $this->session_vars ['USER_TIP'] == $attore_stato->getNome ()) {
				$this->session_vars ['USER_TIP'] = 'DE';
			} else if ($attore_stato != '' && $this->user->profilo == $this->config_service ['DM'] && $this->user->profilo != '') {
				$this->session_vars ['USER_TIP'] = "DM";
			} else {
				$this->session_vars ['USER_TIP'] = 'RO';
			}
		}
		global $in;
		$in = $this->session_vars;
		if ($this -> config_service['BookPkService'] && $replaced) {
            $this -> pk_service = $pk_service;
        }
	}

	/**
	 * Costruisce la struttura dello studio
	 *
	 */
	function VisitStructure() {
		$xml_dir = $this->xml_dir;
		$visit_structure_xml = $this->visit_structure_xml;
		$service = $this->service;

		//controllo che ci sia WF, se c'e prendo nomi degli attori, cerco visite_exams per quegli attori,
		//se non ci sta, prendi visite_exams.xml
		if (isset ( $this->workflow )) {
			$nome_attore = str_replace ( " ", "_", $this->session_vars ['WFact'] );
			$visit_file_attore = str_replace ( ".xml", "_" . $nome_attore . ".xml", $visit_structure_xml );
			if (file_exists ( $xml_dir . '/' . $visit_file_attore ))
			$visit_structure_xml = $visit_file_attore;

			//			
		}
		//echo "Stai usando questo visite_exams= $xml_dir /NO_PRE/  $visit_structure_xml ";
		$vlist = new xml_esams_list ( $xml_dir . '/' . $visit_structure_xml, $this->config_service, $this->session_vars, $this->conn );
		if ($vlist->page ['LEGEND'] == 'yes') {
			$legend_upper = new legend ( $this->config_service );
		}
		foreach ( $vlist->visitnums as $key => $val )
		$vis_name [$key] = $val ['TEXT'];
		if (isset ( $vlist->esams ) && is_array ( $vlist->esams ))
		foreach ( $vlist->esams as $key => $val )
		if (isset ( $val ) && is_array ( $val ))
		foreach ( $val as $kv => $vv ) {
			$es_name [$kv] = $vv ['TESTO'];
			$es_form [$key] [$kv] = $vv ['XML'];
		}
		$form_reg = new xml_form ( );
		$form_reg->xml_form_by_file ( $xml_dir . "/" . $es_form [0] [0] );
		$patients_table = $form_reg->form ['TABLE'];

		$coordinate = strtoupper ( $service ) . "_COORDINATE";
		if (isset ( $ESAM )) {
			if (! isset ( $form )) {
				$form = $es_form [$VISITNUM] [$ESAM];
				$this->session_vars ['form'] = $es_form [$VISITNUM] [$ESAM];
			}
		}

		$this->es_form = $es_form;
		$this->es_name = $es_name;
		$this->vlist = $vlist;
		$this->patient_table = $patients_table;
		global $patients_table;
		$patients_table = $this->patient_table;

	}

	/**
	 * Genera il codice HTML della HomePage
	 *
	 */
	function HomePage() {
		if (isset ( $this->workflow )) {
			$prof_add = str_replace ( " ", "_", $this->session_vars ['WFact'] );
			if(isset($_GET['PREFIX']) && $_GET['PREFIX']!="")
			$xml_page = "home_{$_GET['PREFIX']}.xml";
			else
			$xml_page = "home_{$prof_add}.xml";

		} else
		$xml_page = 'home.xml';
		$legend_upper = "";
		if (preg_match ( "/^MS/", $in ['remote_userid'] ) || preg_match ( "/^AIFA/", $in ['remote_userid'] ))
		$xml_page = 'home_ms.xml';
		if ($in ['USER_TIP'] == 'DM')
		$xml_page = 'home_dm.xml';
		if ($in ['USER_TIP'] == 'RO')
		$xml_page = 'home_ro.xml';

		$body.="<!--$xml_page-->";
		$this->xml_page=$xml_page;
		$page = new xml_page ( $this->xml_dir . '/' . $xml_page, $this->admin_profili );
		$body .= $page->page_html ();
		$body .= $this->footer;

		//Nuovo modo di generare il menu briciola di pane
		$this->percorso = $this->breadcrumb ( "home" );
		$this->body .= $this->percorso;

		$this->body .= $body;
	}

	/**
	 * Gestisce la pagine dei listati
	 *
	 * @param String $percorso_base
	 */
	function ListPage($percorso_base = null) {
		//modifica effettutata da G.Tufano
		//il 26/05/2011. Ora per vedere un pager è sufficiente settare la variabile RPP nel config.inc locale
		//per es: $config_service['RPP'] = 25;
	if (isset($this->config_service['RPP']) && $this->config_service['RPP']  != ''){
			$RPP = $this->config_service['RPP'];
			if($_GET['PAGE']=="")
				$page=1;
			else
				$page=$_GET['PAGE'];
	}	
			$str="select count(*) conto from {$this->service}_utenti_centri where userid='{$this->user->userid}'";
			$sql=new query($this->conn);
			$sql->get_row($str);
			$list=str_replace ( ".xml", "_center.xml", $_GET['list'] );
			if($sql->row['CONTO']>1 && $this->session_vars['CENTER']==''){
				if(file_exists($this->xml_dir. "/" . $list ))
				$_GET['list']=$list;
				$page = "";
				unset($this->config_service['RPP']);
			}
		
		
		$list = $_GET ['list'];
		if ($list == ''){
			$list = 'patients_list.xml';
		}
		if (isset ( $this->workflow ) && $list == 'patients_list.xml') {
			$prof_add = str_replace ( " ", "_", $this->session_vars ['WFact'] );
			$list = str_replace ( ".xml", "_{$prof_add}.xml", $list );
		}
		
		$list_o = new xml_list ( $this->xml_dir . "/" . $list, $page,$RPP, null, null, $this->session_vars, $this->visit_structure );
		
		//viene chiamato patients_list solo in caso sia davvero patients_list. se no altra_list
		if ($list == 'patients_list.xml') {
			$this->percorso = $this->breadcrumb ( "patients_list" );
			}
		else{
			$titolo = $list_o->list['TITOLO'];
			$this->percorso = $this->breadcrumb ( "altra_list",$titolo );
		} 
			
		$this->body .= $this->percorso;

		$this->body .= $list_o->list_html ( $this->session_vars );
		$legend = new legend ( $this->config_service );
		
		#GC 09/12/2015 NUOVA_GRAFICA - Elimino la legenda dalla lista sedute (non ha senso)
		//$this->body .= $legend->html_legend_lista;
	}

	/**
	 * Lista degli esami
	 *
	 * @param String $percorso_base
	 */
	function ExamsLists($percorso_base = null) {
		$this->patient_table = "";

		//Nuovo modo di generare il menu briciola di pane
		$this->percorso = $this->breadcrumb ( "exam_list" );
		//$body .= $this->percorso;

		$exams = $this->visit_structure_xml;
		global $xml_forms_not_valid;
		$this->make_patient_table ();
		$body .= $this->patient_table;
		$body .= "<br>" . $this->tb_riassuntiva ();
		if (isset ( $this->workflow ) && (! isset ( $this->show_gantt ) || $this->show_gantt))
		$body .= "
			<p align=center>
				<a href=\"#\" onclick=\"show_hide('img_rep');return false;\">Mostra/nascondi diagramma temporale</a><br>
				<img style=\"display:none\" id='img_rep' src=\"gantt.php?WF_ID={$this->workflow->id}&PK_SERVICE={$this->pk_service}\">
			</p>";
		else
		$body .= "<br>";

		if ($this->xmr->depth > 0 && $this->session_vars ['VISITNUM'] == '' && $this->mostra_ana_comune) {
			//	$dir= str_replace("/".$this->service,"",$this->xml_dir);
			$xmr = new xmrwf ( "study.xml", $conn );
			$xmr->setConfigParam ( true );
			$config = $xmr->getConfigService ();
			//	$vlist_2 = new xml_esams_list ( $dir . '/' . $exams,$config,$this->session_vars, $this->conn);
			$body .= str_replace ( "index.php", "../index.php", $this->vlist_root->esams_list_html ( $config ['service'] ) );
			$body .= "<table width='95%' align=center><tr><td>";
		}

		$vlist = new xml_esams_list ( $this->xml_dir . '/' . $exams );
		$body .= $this->vlist->esams_list_html ();


		$ret = "";
		if ($this->config_service ['lang'] == "en") {
			$go = "Enter ";
			$data = " data";
		} else {
			$go = "Entra nei dati ";
			$data = "";
		}
		if (isset($this->xmr->substudies) && is_array($this->xmr->substudies)) foreach ( $this->xmr->substudies as $curr_study ) {
			$str = "select count(*) conto from {$curr_study->configurations['PREFIX']}_coordinate where  {$curr_study->configurations['PK_SERVICE']}='{$this->pk_service}'";
			$sql = new query ( $this->conn );
			$sql->get_row ( $str );
			$link = $curr_study->configurations ['PREFIX'] . "/" . $this->hrefs ['Vista Paziente'];
			if ($sql->row ['CONTO'] > 0)
			$ret .= "<p align=\"left\">$go<a href=\"$link\">" . $curr_study->workflow ['DESCR'] . "$data&nbsp;&gt;&gt;</a></p>";
		}
		if($this->xmr->depth!='0'){
			$link = "../" . $this->hrefs ['Vista Paziente'];
			$ret .= "<p align=\"left\">$go<a href=\"$link\">" . $this->xmr_root->workflow ['DESCR'] . "$data&nbsp;&gt;&gt;</a></p>";
		}
		$body .= $ret;
		if($this->xmr->depth > 0 && $this->session_vars ['VISITNUM'] == '' && $this->mostra_ana_comune) {
			$body.="</td></tr></table>";
		}
		$legend = new legend ( $this->config_service );
		if($this->session_vars['VISITNUM']!="" || $this->session_vars['GROUP']!="")
		$body.='<p align="right"><a href="index.php?exams=visite_exam.xml&'.$this->config_service['PK_SERVICE'].'='.$this->session_vars[$this->config_service['PK_SERVICE']].'&CENTER='.$this->session_vars['CENTER'].'">'.$this->testo("Lista completa").'</a></p>';

		$body .= $legend->html_legend_visita;
		if (isset ( $xml_forms_not_valid ) && is_array ( $xml_forms_not_valid ))
		foreach ( $xml_forms_not_valid as $key => $val ) {
			$forms_not_valid .= "<li>$val</li>";
		}
		if ($forms_not_valid != '') {
			$forms_not_valid = "<font color='red'><b>Attention: these forms can't be sent:</b></font><ul>$forms_not_valid</ul>Compile all mandatory fields";
		}
		$body = $forms_not_valid . $body;
		$body = $percorso . $body;
		$this->body = $body;
	}

	/**
	 * Costruisce la tabella riassuntiva dell'oggetto dello studio
	 *
	 */
	function tb_riassuntiva() {

		return;
	}

	



	/**
	 * Aggiunge una visita progressiva
	 *
	 * @param number $visitnum
	 */
	function addVProgr($visitnum) {
		if ($this->integrazione->eq_enabled){
			if ($this->integrazione->eq_int==''){
				$this->integrazione->createEq();
			}
		}
		$sql = new query ( $this->conn );
		$sql_query = "select max(visitnum_progr)+1 as vprogr from {$this->service}_coordinate
		where {$this->config['PK_SERVICE']}={$this->pk_service}
		and visitnum=$visitnum
		";
		$sql->get_row ( $sql_query );
		$vprogr = $sql->row ['VPROGR'];
		if ($vprogr=='') $vprogr=0;
		foreach ( $this->vlist->esams [$visitnum] as $key => $val ) {
			if ($val ['DEFAULT'] == 'yes') {
				$goon = true;
				if ($val ['CONDITION_VAR'] != '') {
					$splits = explode ( ".", $val ['CONDITION_VAR'] );
					$sql_query = "select {$splits[1]} from {$splits[0]} where {$this->config_service['PK_SERVICE']}={$_GET[$this->config_service['PK_SERVICE']]}";
					$sql2 = new query ( $this->conn );
					$sql2->get_row ( $sql_query );
					if ($sql2->row [$splits [1]] != $val ['CONDITION_VALUE'])
					$goon = false;
				}
				if ($goon) {
					$values ['VISITNUM'] = $visitnum;
					$values ['VISITNUM_PROGR'] = $vprogr;
					$values ['ESAM'] = $key;
					$values ['PROGR'] = 1;
					$values [$this->config ['PK_SERVICE']] = $this->pk_service;
					$values ['ABILITATO'] = 1;
					if (isset($this->integrazione->eq_int) && $this->integrazione->eq_int!=''){
						$values['EQ_ACTION']=1;
						$values['INV_QUERY']=$this->integrazione->eq_int;
					}
					$pk = '';
					$sql->insert ( $values, "{$this->service}_coordinate", $pk );
				}
			}
		}
		if (method_exists($this, "vProgrAddRules")){
			$this->vProgrAddRules($visitnum, $vprogr);
		}
		$this->conn->commit ();
		$redirect = "index.php?{$this->config['PK_SERVICE']}={$this->pk_service}&exams&VISITNUM=$visitnum";
		header ( "location:$redirect" );
		die ();
	}

	/**
	 * Elimina una visita progressiva
	 *
	 * @param number $visitnum
	 * @param number $vprogr
	 */
	function DelVisitProgr($visitnum, $vprogr, $redir=true) {
        if ($this->integrazione->eq_enabled){
            if ($this->integrazione->eq_int==''){
                $this->integrazione->createEq();
            }
            $bind['PK_SERVICE']=$this->pk_service;
            $bind['VISITNUM']=$visitnum;
            $bind['VISITNUM_PROGR']=$vprogr;
            $sql_delete = "delete from {$this->service}_coordinate
            where {$this->config['PK_SERVICE']}=:pk_service and visitnum=:visitnum and visitnum_progr=:visitnum_progr and eq_action=1";
            $sql=new query($this->conn);
            $sql->ins_upd ($sql_delete,$bind);//binded

            $sql_update="update {$this->service}_coordinate set inv_query={$this->integrazione->eq_int}, eq_action=2 where
            {$this->config['PK_SERVICE']}=:pk_service and visitnum=:visitnum and visitnum_progr=:visitnum_progr
            ";
            $sql=new query($this->conn);
            $sql->ins_upd($sql_update,$bind);//binded
            $this->conn->commit ();
            $redirect = "index.php?{$this->config['PK_SERVICE']}={$this->pk_service}&exams&VISITNUM=$visitnum";
            header ( "location:$redirect" );
            die ( $redirect );
        }
        $sql = new query ( $this->conn );
        foreach ( $this->vlist->esams [$visitnum] as $key => $val ) {
            $xml_form = new xml_form ( $this->conn, $this->service, $this->config_service, $this->session_vars, $this->uploaded_file_dir );
            $xml_form->xml_form_by_file ( $this->xml_dir . '/' . $val ['XML'] );
            $tbs [$xml_form->form ['TABLE']] = true;
        }
        unset($bindInsert);
        $bindInsert['PK_SERVICE']=$this->pk_service;
        $bindInsert['VISITNUM']=$visitnum;
        $bindInsert['VISITNUM_PROGR']=$vprogr;
        foreach ( $tbs as $key => $val ) {
            $sql_storico = "insert into s_{$key} select '{$this->user->userid}', sysdate, storico_id.nextval, 'E', null, {$key}.* from {$key}
            where {$this->config['PK_SERVICE']}=:pk_service and visitnum=:visitnum and visitnum_progr=:visitnum_progr";
            $sql->ins_upd ($sql_storico,$bindInsert); //binded
        }
        $sql_delete = "delete from {$this->service}_coordinate where {$this->config['PK_SERVICE']}={$this->pk_service} and visitnum=$visitnum and visitnum_progr=$vprogr";
        unset($bindDelete);
        $bindDelete['PK_SERVICE']=$this->pk_service;
        $bindDelete['VISITNUM']=$visitnum;
        $bindDelete['VISITNUM_PROGR']=$vprogr;
        $sql->ins_upd ($sql_delete,$bindDelete);//binded
        if(!$this->config_service['ALLOW_BLANK_VPROGR']){       
            $sql_query = "select max(visitnum_progr) as maxvprogr from {$this->service}_coordinate
            where {$this->config['PK_SERVICE']}={$this->pk_service}
            and visitnum=$visitnum
            ";
            $sql->get_row ( $sql_query );
            $maxvprogr = $sql->row ['MAXVPROGR'];

            for($i = $vprogr; $i < $maxvprogr; $i ++) {
                $nextvprogr = $i + 1;
                $sql_insert_coord = "
                insert into {$this->service}_coordinate
                (VISITNUM,VISITNUM_PROGR,PROGR,ESAM,INIZIO,FINE,INSERTDT,MODDT,USERID,VISITCLOSE,INV_QUERY,{$this->config['PK_SERVICE']},ABILITATO)
                select
                VISITNUM,$i,PROGR,ESAM,INIZIO,FINE,INSERTDT,MODDT,USERID,VISITCLOSE,INV_QUERY,{$this->config['PK_SERVICE']},ABILITATO
                from {$this->service}_coordinate where
                {$this->config['PK_SERVICE']}=:pk_service
                and visitnum=:visitnum
                and visitnum_progr=:visitnum_progr
                ";
                unset($bindInsert);
                $bindInsert['PK_SERVICE']=$this->pk_service;
                $bindInsert['VISITNUM']=$visitnum;
                $bindInsert['VISITNUM_PROGR']=$nextvprogr;
                $sql->ins_upd ($sql_insert_coord,$bindInsert);//binded
                foreach ( $tbs as $key => $val ) {
                    $sql_storico = "insert into s_{$key} select '{$this->user->userid}', sysdate, storico_id.nextval, 'S', null, {$key}.* from {$key}
                    where {$this->config['PK_SERVICE']}=:pk_service and visitnum=:visitnum and visitnum_progr=:visitnum_progr";
                    $sql->ins_upd ($sql_storico,$bindInsert);//binded
                    $sql_update = "update $key set visitnum_progr=$i
                    where {$this->config['PK_SERVICE']}=:pk_service and visitnum=:visitnum and visitnum_progr=:visitnum_progr";
                    $sql->ins_upd ($sql_update,$bindInsert);//binded
                }
                $sql_delete_coord = "delete from {$this->service}_coordinate
                where
                {$this->config['PK_SERVICE']}=:pk_service
                and visitnum=:visitnum
                and visitnum_progr=:visitnum_progr";
                unset($bindDelete);
                $bindDelete['PK_SERVICE']=$this->pk_service;
                $bindDelete['VISITNUM']=$visitnum;
                $bindDelete['VISITNUM_PROGR']=$nextvprogr;
                $sql->ins_upd ($sql_delete_coord,$bindDelete);//binded
            }
        }
        $this->conn->commit ();
        
        if($redir==true){
            $redirect = "index.php?{$this->config['PK_SERVICE']}={$this->pk_service}&exams&VISITNUM=$visitnum";
            header ( "location:$redirect" );
            die ( $redirect );
        }
    }

	/**
	 * Controller
	 *
	 */
	function Controller() {
		
		
//		$test_date=date("H:i:s.u");
//		
        if (isset($_GET['SFOGLIA']) || isset($_POST['SFOGLIA'])) {
            $this -> SfogliaPage();
            return;
        }
        if (isset($this->session_vars['CMELayer']) && !isset($this->session_vars['DocPrat']) ){
            include_once("CMELayer.inc");
            if(!class_exists("CMELayerWCA")){
                include_once("libs/CMELayer.inc");
                eval("class CMELayerWCA extends CMELayerWCAPrototype{}");
            }
            $configuration['SERVICE']=$this->service;
            $configuration['PK_SERVICE']=$this->config_service['PK_SERVICE'];
            $configuration['queryNames']=$this->config_service['QUERYNAMES'];
            $CME=new CMELayerWCA($this->conn,$configuration,$this->session_vars,$this->config_service);
            $CME->controller();
            $this->body.=$CME->html;
            return;        
        }
		if (isset($_GET['XmrFileUpload'])){
			include_once "libs/field_big_file.inc";
			field_big_file::showApplet($this);
		}
		if (isset($_POST['XmrFileUpload'])){
			include_once "libs/field_big_file.inc";
			field_big_file::gestSaving($this);
		}
		if (isset($this -> session_vars['pdf_esame'])) {
		    $visitnum_progr=$this->session_vars['VISITNUM_PROGR']?$this->session_vars['VISITNUM_PROGR']:0;
		    $progr=$this->session_vars['PROGR']?$this->session_vars['PROGR']:1;
            return $this -> pdf_esame($this->session_vars['ESAM'], $this->session_vars['VISITNUM'], $visitnum_progr, $progr);
        }
		if (isset ( $this->workflow )) {
			if ($this->pk_service != '')
			$this->workflow->MakeAutomaticChange ();

			//se il multiprofilo è abiltiato per questo xmr
			if($this->config_service['multi_profilo'][$this->service] && $this->config_service['multi_profilo_prefix'][$this->service]==$this->workflow->prefix) {
				//$cookie_name="MultiProfilo_".$this->workflow->prefix;
				$cookie_name="MultiProfilo_".$this->workflow->prefix."_".$this->user->userid;
				
				//CAMBIO DEL PROFILO DA GET/COOKIE
				if(isset($_GET['profile']) && $_GET['profile']!="" && preg_match("/[0-9]+/",$_GET['profile']) /*&& array_key_exists($_GET['profile'],$this->workflow->profile_list)*/) {
					//controllare che questo utente posso farlo
					$this->profile_id=$_GET['profile'];
					setcookie($cookie_name, $_GET['profile'],time()+3600);
					//setcookie($cookie_name, $this->user->userid,time()+3600);
					$url=preg_replace("/\&profile=[0-9]/i","",$_SERVER['REQUEST_URI']);

					if(!preg_match("/\?/",$url)) $url=$url."?";
					$url=rtrim($url,'?');

					header("Location: $url");
					die();
				}

				//SE esiste questa vista è abilitato il multiprofilo
//				$sql_query="select * from user_tables where table_name = '{$this->workflow->prefix}_ASSIGN_PROFILI'";
//	//			echo $sql_query;
//				$sql_check=new query($this->conn);
//				$sql_check->set_sql($sql_query);
//				$sql_check->exec();//commentata
//				if($sql_check->numrows>0) {
//					$sql_query="select PROFILE from {$this->workflow->prefix}_ASSIGN_PROFILI where USERID='{$this->user->userid}' AND PREDEF_ID='Yes'";
//	//				echo $sql_query;
//					$sql_att=new query($this->conn);
//					$sql_att->set_sql($sql_query);
//					$sql_att->exec();//commentata
//					$sql_att->get_row();
//	//				echo "<!--PROFILE: ".	$sql_att->row['PROFILE']."-->";
//				}
				//estraggo gli user dei profili
				$sql_query="select table_name from user_tables where table_name = '{$this->workflow->prefix}_ASSIGN_PROFILI'";
				$sql_check=new query($this->conn);
				$sql_check->set_sql($sql_query);
				$sql_check->exec();	//non richiede binding			

				if(isset($_COOKIE[$cookie_name]) && $_COOKIE[$cookie_name]!="" /*&& array_key_exists($_COOKIE[$cookie_name],$this->workflow->profile_list)*/) {
					//considerare il nome utente
					$this->profile_id=$_COOKIE[$cookie_name];
				} else if($sql_check->numrows>0) {
					//print_r($this->workflow); die();
					$sql_query="select PROFILE from {$this->workflow->prefix}_ASSIGN_PROFILI where USERID=:userid AND PREDEF_ID='Yes'";
					$sql_att=new query($this->conn);
					$sql_att->set_sql($sql_query);
					unset($bind_userid);
					$bind_userid['USERID']=$this->user->userid;
					$sql_att->exec($sql_query,$bind_userid);//binded
					$sql_att->get_row();

					//lettura del predefinito
					$this->profile_id=$sql_att->row['PROFILE'];
					//					echo "profilo_id: ".$this->profile_id;
//					$cookie_name="MultiProfilo_".$this->workflow->prefix."_".$this->user->userid;

 					if(array_key_exists($this->profile_id,$this->workflow->profile_list) && preg_match("/[0-9]+/",$this->profile_id)) {
						setcookie($cookie_name, $this->profile_id,time()+3600);
 					}
					//setcookie($cookie_name, ,time()+3600);

				}
				//FINE CAMBIO DEL PROFILO DA GET/COOKIE

				if(isset($_GET['ADMIN_PROFILI']) && $_GET['ADMIN_PROFILI']!="") {
					$this->admin_profili_html=$this->admin_profili_tb();
					$this->body=$this->admin_profili_html;
				}

			}//chiuso if abilitato multiprof

		}
		
//		$test_date=date("H:i:s.u");
		
		if (isset($_GET['eCRF_PDF'])){
			$this->eCRF(true);
		}  
		if (isset($_GET['eCRF'])){
			$this->eCRF(false);
		}  
//		
		
		//Luigi: assegna automaticamente il prossimo progr senza ricavarlo manualmente
		if (isset($_GET['AUTOPROGR'])){
			$sql_query="select max(progr) as maxprogr from {$this->service}_coordinate where {$this->config_service['PK_SERVICE']}=:ID_SPER and esam=:ESAM and visitnum=:VISITNUM and visitnum_progr=:VISITNUM_PROGR";
			$array_bind['ID_SPER']=$this->pk_service;
			$array_bind['ESAM']=$_GET['ESAM'];
			$array_bind['VISITNUM']=$_GET['VISITNUM'];
			$array_bind['VISITNUM_PROGR']=$_GET['VISITNUM_PROGR'] ? $_GET['VISITNUM_PROGR'] : 0;
            
			$query=new query($this->conn);
			$query->exec($sql_query,$array_bind);
			$query->get_row();
			if ($query->row['MAXPROGR']==''){$query->row['MAXPROGR']+=1;}
///			print ($query->row['MAXPROGR']);
			
			$sql_query2="select inizio from {$this->service}_coordinate where {$this->config_service['PK_SERVICE']}=:ID_SPER and esam=:ESAM and visitnum=:VISITNUM and progr={$query->row['MAXPROGR']} and visitnum_progr=:VISITNUM_PROGR";
			$query2=new query($this->conn);
			$query2->exec($sql_query2,$array_bind);
			$query2->get_row();
			
			if ($query2->row['INIZIO']==1) $nextprogr=$query->row['MAXPROGR']+1;
			else $nextprogr=$query->row['MAXPROGR'];
			
			foreach ($_GET as $indice => $valore){
				if ($indice!="AUTOPROGR"){
				$param.=$indice;
				$param.="=";
				$param.=$valore;
				$param.="&";
				}
			}
			$param.="PROGR=$nextprogr";
			header ( "location: index.php?$param" );
			die ();
		}
			
			//Luigi: assegna automaticamente il prossimo visitnum_progr senza ricavarlo manualmente
		if (isset($_GET['AUTOVPROGR'])){
			$sql_query="select max(visitnum_progr) as maxvprogr from ossc3_coordinate where {$this->config_service['PK_SERVICE']}=:ID_SPER and visitnum=:VISITNUM";
			$array_bind['ID_SPER']=$_GET['ID_SPER'];
			$array_bind['VISITNUM']=$_GET['VISITNUM'];
			
			$query=new query($this->conn);
			$query->exec($sql_query,$array_bind);
			$query->get_row();
			
			if ($query->row['MAXVPROGR']!='') $nextprogr=$query->row['MAXVPROGR']+1;
			else $nextprogr=0;
			
			foreach ($_GET as $indice => $valore){
				if ($indice!="AUTOVPROGR"){
				$param.=$indice;
				$param.="=";
				$param.=$valore;
				$param.="&";
				}
			}
			$param.="VISITNUM_PROGR=$nextprogr";
			header ( "location: index.php?$param" );
			die ();
			}
		
		//			}
		if (isset($_GET['field_file_doc'])){
			if (file_exists("fields/field_file_doc.inc")) include_once "fields/field_file_doc.inc";
			else include_once "libs/field_file_doc.inc";
			if (class_exists("field_file_doc_gest")){
				$field_file_doc_ajax_gest=new  field_file_doc_gest();
				$field_file_doc_ajax_gest->Controller();
				die();
			}
		}
		if (isset($_GET['field_file_cme'])){
			if (file_exists($this->config_service['field_lib']."/field_file_cme.inc")) include_once $this->config_service['field_lib']."/field_file_cme.inc";
			else include_once "libs/field_file_cme.inc";
			if (class_exists("field_file_cme_gest")){
				$field_file_cme_ajax_gest=new  field_file_cme_gest();
				$field_file_cme_ajax_gest->Controller();
				die();
			}
		}
		if(isset($_GET['getFP'])){
			echo "<table cellpadding=0 cellspacing=0 border=1>";
			foreach ($this->vlist->esams as $k=>$v){
				foreach ($v as $e => $es){

					$xml_form = new xml_form ( $this->conn, $this->service, $this->config_service, $this->session_vars, $this->uploaded_file_dir );
					$xml_form->xml_form_by_file ( $this->xml_dir . '/' . $es['XML'] );
					$count_campi=0;
					$tb_='';
					$tb_ext='';
					$tbf_='';
					foreach ($xml_form->fields as $key=>$val){
						if ($val['VAR']!='' && $val['TB']!='no')
						$count_campi++;
						if ($val['BYTB']!=''){
							$tb_ext[$val['BYTB']]=true;
						}
					}
					foreach ($tb_ext as $key=>$val){
						$tb_.="$key<br/>";
						$tbf_.="2<br/>";
					}
					if (isset($xml_form->form['F_TO_CALL'])){
						$f_ext="Controllare la funzione:{$xml_form->form['F_TO_CALL']}";
					}
					$tb_=rtrim($tb_, "<br/>");
					$tbf_=rtrim($tbf_, "<br/>");
					echo "
					<tr>
						<td>{$xml_form->form['TITOLO']}</td>
						<td>{$xml_form->form['TABLE']}</td>
						<td>$count_campi</td>
						<td>$tb_</td>
						<td>$tbf_</td>
						<td>{$xml_form->form['TABLE']}</td>
						<td>$count_campi</td>
						<td>$f_ext</td>
						<td>$f_ext</td>
					</tr>";
				}
			}
			echo "</table>";
			die();
		}



		if (isset ( $_POST ['eQuery_Integrazione_Send_'] ) || isset ( $_POST ['eQuery_Integrazione_Send'] )) {
			print_r ( $_POST );
			die ();
		}
		if (isset ( $_GET ['CLOSE_VISIT'] )) {

			$this->body = $this->close_all ( $_GET ['CLOSE_VISIT'] );
			return;
		}
		if (isset($_POST['EQUERY_OBJ'])) {
			$curr_equery_obj=$this->equery_objs[$_POST['EQUERY_OBJ']];
			$curr_equery_obj->save();
		}
		if (isset($_POST['ID_QUERY']) && !isset($_POST['eform']) && !isset($_POST['EQUERY_OBJ'])) {
			$this->eQuerySave();
		}
		if (isset($_GET['CREATE_VPROGR']) && $_GET['CREATE_VPROGR']=='yes'){
			//LUIGI: controllo sui diritti di creazione
			$visitnum = $_GET ['VISITNUM'];
			if(!isset ( $this->vlist->visitnums[$visitnum]['BUTTONS_DISABLED']) && $this->session_vars['USER_TIP']=='DE'){
			$this->addVProgr($_GET['VISITNUM']);
			die();
		}else{
			error_page ( $this->user->userid, $this->testo ( "NOTCREABLE" ), "" );
			}
		}
		if (isset($_GET['DelVisitProgr']) && $_GET['DelVisitProgr']=='yes'){
			//LUIGI: controllo sui diritti di cancellazione
			$visitnum = $_GET ['VISITNUM'];
			if (!isset($this->config_service['deletableVisits']) || $this->config_service['deletableVisits'][$this->user->profilo][$visitnum]==true){ 
			$this->DelVisitProgr($_GET['VISITNUM'], $_GET['VISITNUM_PROGR']);
			die();
			} else {
				error_page ( $this->user->userid, $this->testo ( "NOTDELETABLE" ), "" );
			}
		}
		
		if ($_GET ['ELIMINA_LA_SCHEDA'] == 'yes') {
			$this->pk_service = $_GET [$this->config_service ['PK_SERVICE']];
			$esam = $_GET ['ESAM'];
			$visitnum = $_GET ['VISITNUM'];
			$visitnum_progr = $_GET ['VISITNUM_PROGR'];
			$progr = $_GET ['PROGR'];
			//LUIGI: controllo sui diritti di cancellazione
			if ($this->config_service['deletableExams'][$this->user->profilo][$visitnum][$esam]==true){ 
			$this->DeleteProgrEsam ("", $visitnum, $visitnum_progr, $esam, $progr );
			foreach ($_GET as $key => $val){
				if ($key!='ELIMINA_LA_SCHEDA' && $key!='PROGR'){
					$param.="$key={$val}&amp;";
				}
			}
			$param.="NoQuickAccess=yes";
			$param=rtrim($param, "&amp;");
			$url="index.php?$param";
// 			die("<html><head><meta http-equiv=\"refresh\" content=\"0;url=$url\"></head></html>");
			ob_clean();
			header('location:'.$url);
			die();
			return;
			} else {
				error_page ( $this->user->userid, "Scheda non eliminabile", "" );
			}
		}

		if (((isset ( $_POST ['invia'] ) && $_POST ['invia'] != '')) || $_POST ['INVIOCO'] == '1') {

			$this->SendForm ( $_POST ['form'] );

		}
		if (((isset ( $_GET ['invia'] ) && $_GET ['invia'] != '')) || $_GET ['INVIOCO'] == '1') {
			$this->SendForm ( $_GET ['form'], true );

		}

		if ((isset ( $_GET ['salva'] ) && $_GET ['salva'] != '') || $_GET ['INVIOCO'] == '0') {

			$this->SaveForm ( $_GET ['form'], true );
		}
		if ((isset ( $_POST ['salva'] ) && $_POST ['salva'] != '') || $_POST ['INVIOCO'] == '0') {

			$this->SaveForm ( $_POST ['form'] );
		}

		if (count ( $_GET ) == 0 && count ( $_POST ) == 0) {
			$this->HomePage ();
		}

		if (isset ( $_GET ['list'] )) {
			$this->ListPage ();
		}


		if (isset ( $_GET ['exams'] )) {
			$this->ExamsLists ();
		}
		if ((isset ( $_GET ['form'] ) || isset ( $_GET ['ESAM'] )) && !isset($_GET['EQUERY_OBJ']) && !isset($_GET['eQuery'])) {
			$this->EsamPage ();
		}

		if ((isset ( $_GET ['form'] ) || isset ( $_GET ['ESAM'] )) && isset($_GET['EQUERY_OBJ'])) {

			$xml = $this->es_form [$_GET ['VISITNUM']] [$_GET ['ESAM']];
			if($this->pk_service!='' && $this->pk_service!='next') {
				$this->make_patient_table();
				$body=$this->patient_table;
				$body .= "<br><br>" . $this->tb_riassuntiva ();
			}
			$curr_equery_obj=$this->equery_objs[$_GET['EQUERY_OBJ']];
			$this->body=$body.$curr_equery_obj->form($xml);
			$this->script=$curr_equery_obj->script;
			$this->onload=$curr_equery_obj->onload;
		}

		if (isset ( $_GET ['SEARCH'] ) || isset ( $_POST ['SEARCH'] )) {
			$this->SearchPage ();
		}

		if (isset ( $_GET ['eQuery'] ) || isset ( $_POST ['eQuery'] )) {
			$this->onload="";
			$this->body = $this->Equery ();
		}
		if($this->session_vars['rep_link']=='true'){
			include_once("report_linker.php");
			$module=new linkModule($this->conn,$this->xmr);
			$module->controller($this->session_vars);
			$this->body.=$module->getResult();
		}

//		if (isset ( $_GET ['INREV'] ) || $_GET ['INREV']==1 ) {
//		    //insert in EQ con nuovo stato = 5
//			$sql=new query($this->conn);
//			$sql_seq="select {$this->service}_eqseq.nextval as eq_int from dual";
//			$sql->exec($sql_seq);//commentata
//			$sql->get_row();
//			$values['ID_PRAT']=$this->pk_service;
//			$values['EQUERY_INT']=$sql->row['EQ_INT'];
//			$values['USERID_INS']=$this->user->userid;
//			$values['INS_DT']="sysdate";
//			//stato 5 in revisione all'azienda
//			$values['STATO']="5";
//
//			if($this->config_service['eQuerySpec']['txt_eq_inrev'][$this->service]!="")
//			$values['RICH_DM']=$this->config_service['eQuerySpec']['txt_eq_inrev'][$this->service];
//			else if($this->config_service['eQuerySpec']['txt_eq_inrev']!="")
//			$values['RICH_DM']=$this->config_service['eQuerySpec']['txt_eq_inrev'];
//			else
//			$values['RICH_DM']="Richiesta revisione al DE";
//
//			$sql_wfstato="select * from {$this->service}WF_STATO where PK_SERVICE={$this->pk_service}";
//			$sql_wf=new query($this->conn);
//			$sql_wf->get_row($sql_wfstato);
//			$values['WF_STATO']=$sql_wf->row['ID_STATO'];
////			if($sql_wf->row['ID_STATO']!=5) die("STATO SBAGLIATO");
//			$sql_2=new query($this->conn);
//			$sql_2->insert($values,$this->service."_EQ");
//
//			//mail e visitclose gestirli dal controller del servizio
//			$this->conn->commit();
//			die("gestire il controler di study_prototype");
//		}


	}

	/**
	 * Gestisce la pagina di ricerca
	 *
	 */
	function SearchPage() {
		return;
	}
    /**
     * Gestisce la pagina di sfoglia
     *
     */
    function SfogliaPage() {

        $this -> session_vars['source'] = str_replace('|', ',', $this -> session_vars['source']);
        $this -> session_vars['dest'] = str_replace('|', ',', $this -> session_vars['dest']);

        $dir = $_SERVER['PATH_TRANSLATED'];

        $dir = preg_replace("/\/index.php/", "", $dir);
        //$filetxt = file_get_contents($dir.'/template.htm');
        if ($this -> session_vars['FORM'] != '') {
            $file_form = $this -> xml_dir . "/sfoglia_form_{$this -> session_vars['FORM']}.xml";

            $xml_form = new xml_form($this -> conn, $this -> service, $this -> config_service, $this -> session_vars, $this -> xml_dir);

            $xml_form -> xml_form_by_file($file_form);
            $xml_form -> open_form();
            $body .= $xml_form -> body;
        }

        global $in;
        $in = $this -> session_vars;
        if (isset($this -> session_vars['TSEARCH'])) {
            $in['list'] = $list = "sfoglia_list_{$this -> session_vars['SFOGLIA']}.xml";
            $list_o = new xml_list($this -> xml_dir . "/" . $list);

            $body .= $list_o -> list_html();
        }
        $filetxt = preg_replace("/<!--body-->/", $body, $filetxt);
        $script = "<script type=\"text/javascript\">
          function invia_f()
          {
          
         
           
           f=document.forms[0];
           el=f.elements;
          
           document.forms[0].TSEARCH.value='1';
           document.forms[0].action='index.php';
           document.forms[0].submit();
           }
           function cf(){}
         </script>
          ";
        $script .= $xml_form -> script_js;
        $codice_sis = $remote_userid - 0;
        $user_name = "<p align=right>
    <br><br><br>";
        //echo "<hr>$nome_user";
        $nome_user = str_replace("\\'", "'", $nome_user);

        $this -> body = $body;
        $this -> script = $script;
    }
    
	/**
	 * Gestione della pagina della scheda
	 *
	 * @param boolean $no_link_back
	 */
	function EsamPage($no_link_back=false) {
		$this->patient_table = "";

		if (isset ( $this->config_service ['patients_list_substudy'] ) && $this->config_service ['patients_list_substudy'] != "") {
			$destination_url = "../index.php";
		} else {
			$destination_url = "index.php";
		}

		/*if (preg_match ( "!,!", $this->centers) && (!isset($this->config_service['NO_LISTA_CENTRI'])))
		 {	$percorso = "
		 <a href=\"{$destination_url}\">Home Page</a>&gt;&gt;
		 <a href=\"{$destination_url}?list=patients_list.xml\">Lista centri</a>&gt;&gt;
		 <a href=\"{$destination_url}?list=patients_list.xml&CENTER={$_GET['CENTER']}\">{$this->config_service['Patients_list']}</a>&gt;&gt;


		 ";
		 }
		 else {

		 $percorso = "
		 <a href=\"{$destination_url}\">Home Page</a>&gt;&gt;
		 <a href=\"{$destination_url}?list=patients_list.xml\">{$this->config_service['Patients_list']}</a>&gt;&gt;

		 ";
		 }
		 if (isset($this->pk_service)) $percorso.="<a href=\"{$destination_url}?&exams=visite_exam.xml&{$this->config_service['PK_SERVICE']}={$_GET[$this->config_service['PK_SERVICE']]}\">{$this->config_service['Lista_schede']}</a>&gt;&gt;";
		 $percorso.="<b>{$this->vlist->esams[$_GET['VISITNUM']][$_GET['ESAM']]['TESTO']}</b>";
		 */
		$type = "form";
		$percorso = $this->breadcrumb ( "form", $this->vlist->esams [$_GET ['VISITNUM']] [$_GET ['ESAM']] ['TESTO'] );
		if (! isset ( $_GET ['form'] ))
		$xml = $this->es_form [$_GET ['VISITNUM']] [$_GET ['ESAM']];
		else
		$xml = $_GET ['form'];

		$this->form ( $xml, true, $no_link_back );

		//		die($this->vlist->make_patient_table());


		//$this->body = $percorso . $this->body;
		$this->percorso = $percorso;

	}
	
	/**
	 * Costruisce un XML con i dati dell'oggetto di studio differenziando i file per visitnum_progr
	 *
	 * @param String $xsl
	 * @param String $file_output
	 * @param String $visitnum - il visitnum che ha visitnum_progr diversi 
	 * 
	 */
/*	function xmlData_multi($xsl, $file_output = false, $visitnum = null) {

		$sql_alter = "alter session set nls_date_format = 'DD/MM/YYYY'";
		$sql = new query ( $this->conn );
		$sql->set_sql ( $sql_alter );
		$sql->ins_upd ();//commentata
		
		
		$sql_query="select distinct visitnum_progr from {$this->service}_coordinate where id_prat={$this->pk_service} and visitnum=$visitnum order by visitnum_progr";
		$sql_=new query($this->conn);
		$sql_->exec($sql_query);//commentata
		while ($sql_->get_row()){
			
		
		$sql_query = "
			select * from {$this->service}_coordinate
			where {$this->config_service['PK_SERVICE']}={$this->pk_service}
			and abilitato=1 and eq_action is null and visitnum <>$visitnum
			union
			select * from {$this->service}_coordinate
			where {$this->config_service['PK_SERVICE']}={$this->pk_service}
			and abilitato=1 and eq_action is null and visitnum =$visitnum and visitnum_progr={$sql_->row['VISITNUM_PROGR']}
			";
		if ($this->integrazione->eq_enabled && $this->integrazione->eq_int!=''){
			$sql_query="select * from {$this->service}_coordinate
			where {$this->config_service['PK_SERVICE']}={$this->pk_service}
			and abilitato=1 and (eq_action is null or (eq_action=1 and inv_query={$this->integrazione->eq_int}))
			and visitnum <>$visitnum
			union
			select * from {$this->service}_coordinate
			where {$this->config_service['PK_SERVICE']}={$this->pk_service}
			and abilitato=1 and eq_action is null and visitnum=$visitnum and visitnum_progr={$sql_->row['VISITNUM_PROGR']}
			";
		}

		
		//		print_r($this->vlist->esams);
		$sql = new query ( $this->conn );
		$sql->exec ( $sql_query );//commentata
//		$scheda=array();
		while ( $sql->get_row () ) {
			$scheda [$sql->row ['VISITNUM']] [$sql->row ['VISITNUM_PROGR']] [$sql->row ['ESAM']] [$sql->row ['PROGR']] = true;
		}
//		echo "<pre>";
//		print_r($scheda); echo "<hr>";
		if (! $file_output)
		header ( "content-type: text/xml" );

		$output = "<?xml version=\"1.0\" encoding=\"UTF-8\"?>
		<?xml-stylesheet type=\"text/xsl\" href=\"$xsl\" ?>
	<Object>
		<PK_SERVICE id=\"{$this->pk_service}\"/>";
		foreach ( $this->vlist->visitnums as $vis => $vis_val ) {
			if (isset ( $scheda [$vis] )) {

				$visit_tag = strtoupper ( $vis_val ['SHORT_TXT'] );
				$visit_tag = str_replace ( " ", "_", $visit_tag );
				$output .= "
		<VISITNUM_{$vis} id=\"{$vis}\">";
				for($i = 0; $i < count ( $scheda [$vis] ); $i ++) {
					if ($vis_val ['PROGR'] == 'yes')
					$output .= "
			<VISITNUM_PROGR id=\"$i\">";
					foreach ( $this->vlist->esams [$vis] as $esam => $esam_val ) {
						if (isset ( $scheda [$vis] [$i] [$esam] )) {
							$xml_form = new xml_form ( $this->conn, $this->service, $this->config_service, $session_vars, $this->uploaded_file_dir );
							if (file_exists ( $this->xml_dir . '/' . $esam_val ['XML'] ))
							$xml_form->xml_form_by_file ( $this->xml_dir . '/' . $esam_val ['XML'] );
							$table = $xml_form->form ['TABLE'];
							if ($table != '') {
								$output .= "
					<ESAM_{$esam} id=\"$esam\" table=\"$table\">";
								for($p = 1; $p <= count ( $scheda [$vis] [$i] [$esam] ); $p ++) {
									if ($esam_val ['PROGR'] == 'yes')
									$output .= "
						<PROGR id=\"$p\">";

									$sql_query = "select * from $table
									where {$this->config_service['PK_SERVICE']}={$this->pk_service}
									and visitnum=$vis
									and visitnum_progr=$i
									and esam=$esam
									and progr=$p
									";
									$sql = new query ( $this->conn );
									$sql->get_row ( $sql_query );
									foreach ( $sql->row as $key => $val ) {
										if ($this->integrazione->eq_enabled && $this->integrazione->eq_int!='') {
											$sql_query_eq_field = "select VALORE from {$this->service}_EQFIELD
											where {$this->config_service['PK_SERVICE']}={$this->pk_service}
											and visitnum=$vis
											and visitnum_progr=$i
											and esam=$esam
											and progr=$p
											and field = '$key'
											and eq_int =  {$this->integrazione->eq_int}
											";
											$sql_field = new query ( $this->conn );
											if($sql_field->get_row ( $sql_query_eq_field  )) {
												if($sql->type[$key]=="DATE")
												$val=substr($sql_field->row['VALORE'],0,2)."/".substr($sql_field->row['VALORE'],2,2)."/".substr($sql_field->row['VALORE'],4);
												else
												$val=$sql_field->row['VALORE'];
											}
										}
										if ($val != '')
										$output .= "
											<$key><![CDATA[$val]]></$key>";
									}
									if ($esam_val ['PROGR'] == 'yes')
									$output .= "
						</PROGR>";
								}
								$output .= "
					</ESAM_{$esam}>";
							}
						}

					}
					if ($vis_val ['PROGR'] == 'yes')
					$output .= "
				</VISITNUM_PROGR>";
				}
				$output .= "
			</VISITNUM_{$vis}>";

			}
		}
		$output .= "
	</Object>";
		
		
		
			if ($file_output) {
				$file_dest = "tmp/{$this->config_service['PK_SERVICE']}_{$_GET[$this->config_service['PK_SERVICE']]}_VPROGR_{$sql->row ['VISITNUM_PROGR']}.xml";
				
				//die($file_dest);
				$fp = fopen ( $file_dest, 'w' );
				fwrite ( $fp, $output );
				fclose ( $fp );
			} else {
				die ( "Passare il nome del file di output per il multi-VPROGR" );
			}
		
		}
		
	}*/

	/**
	 * Costruisce un XML con i dati dell'oggetto di studio
	 *
	 * @param String $xsl
	 * @param String $file_output
	 */
	function xmlData($xsl, $file_output = false) {

		$sql_alter = "alter session set nls_date_format = 'DD/MM/YYYY'";
		$sql = new query ( $this->conn );
		$sql->set_sql ( $sql_alter );
		$sql->ins_upd ();//non richiede binding
		
		$sql_query = "
			select * from {$this->service}_coordinate
			where {$this->config_service['PK_SERVICE']}=:pk_service
			and abilitato=1 and eq_action is null
			";
		if ($this->integrazione->eq_enabled && $this->integrazione->eq_int!=''){
			$sql_query="select * from {$this->service}_coordinate
			where {$this->config_service['PK_SERVICE']}=:pk_service
			and abilitato=1 and (eq_action is null or (eq_action=1 and inv_query=:eq_id))";
		}
		
		//		print_r($this->vlist->esams);
		$sql = new query ( $this->conn );
		unset($bind);
		$bind['EQ_ID']=$this->integrazione->eq_int;
		$bind['PK_SERVICE']=$this->pk_service;
		$sql->exec ( $sql_query,$bind );//binded
		while ( $sql->get_row () ) {
			$scheda [$sql->row ['VISITNUM']] [$sql->row ['VISITNUM_PROGR']] [$sql->row ['ESAM']] [$sql->row ['PROGR']] = true;
		}
		if (! $file_output)
		header ( "content-type: text/xml" );

		$output = "<?xml version=\"1.0\" encoding=\"UTF-8\"?>
		<?xml-stylesheet type=\"text/xsl\" href=\"$xsl\" ?>
	<Object>
		<PK_SERVICE id=\"{$this->pk_service}\"/>";
		foreach ( $this->vlist->visitnums as $vis => $vis_val ) {
			if (isset ( $scheda [$vis] )) {

				$visit_tag = strtoupper ( $vis_val ['SHORT_TXT'] );
				$visit_tag = str_replace ( " ", "_", $visit_tag );
				$output .= "
		<VISITNUM_{$vis} id=\"{$vis}\">";
				for($i = 0; $i < count ( $scheda [$vis] ); $i ++) {
					if ($vis_val ['PROGR'] == 'yes')
					$output .= "
			<VISITNUM_PROGR id=\"$i\">";
					foreach ( $this->vlist->esams [$vis] as $esam => $esam_val ) {
						if (isset ( $scheda [$vis] [$i] [$esam] )) {
							
							$xml_form = new xml_form ( $this->conn, $this->service, $this->config_service, $session_vars, $this->uploaded_file_dir );
							if (file_exists ( $this->xml_dir . '/' . $esam_val ['XML'] ))
							$xml_form->xml_form_by_file ( $this->xml_dir . '/' . $esam_val ['XML'] );
							$table = $xml_form->form ['TABLE'];
							if ($table != '') {
								$output .= "
					<ESAM_{$esam} id=\"$esam\" table=\"$table\">";
								for($p = 1; $p <= count ( $scheda [$vis] [$i] [$esam] ); $p ++) {
									if ($esam_val ['PROGR'] == 'yes')
									$output .= "
						<PROGR id=\"$p\">";

									$sql_query = "select * from $table
									where {$this->config_service['PK_SERVICE']}={$this->pk_service}
									and visitnum=$vis
									and visitnum_progr=$i
									and esam=$esam
									and progr=$p
									";
									$sql = new query ( $this->conn );
									$sql->get_row ( $sql_query );
									foreach ( $sql->row as $key => $val ) {
										if ($this->integrazione->eq_enabled && $this->integrazione->eq_int!='') {
											$sql_query_eq_field = "select VALORE from {$this->service}_EQFIELD
											where {$this->config_service['PK_SERVICE']}={$this->pk_service}
											and visitnum=$vis
											and visitnum_progr=$i
											and esam=$esam
											and progr=$p
											and field = '$key'
											and eq_int =  {$this->integrazione->eq_int}
											";
											$sql_field = new query ( $this->conn );
											if($sql_field->get_row ( $sql_query_eq_field  )) {
												if($sql->type[$key]=="DATE")
												$val=substr($sql_field->row['VALORE'],0,2)."/".substr($sql_field->row['VALORE'],2,2)."/".substr($sql_field->row['VALORE'],4);
												else
												$val=$sql_field->row['VALORE'];
											}
										}
										if ($val != '')
										$output .= "
											<$key><![CDATA[$val]]></$key>";
									}
									if ($esam_val ['PROGR'] == 'yes')
									$output .= "
						</PROGR>";
								}
								$output .= "
					</ESAM_{$esam}>";
							}
						}

					}
					if ($vis_val ['PROGR'] == 'yes')
					$output .= "
				</VISITNUM_PROGR>";
				}
				$output .= "
			</VISITNUM_{$vis}>";

			}
		}
		$output .= "
	</Object>";
		if ($file_output) {
			$file_dest = "tmp/{$this->config_service['PK_SERVICE']}_{$_GET[$this->config_service['PK_SERVICE']]}.xml";
			//die($file_dest);
			$fp = fopen ( $file_dest, 'w' );
			fwrite ( $fp, $output );
			fclose ( $fp );
		} else
		die ( $output );

	}

	/**
	 * Controlla la chiusura della scheda
	 *
	 * @param number $visitnum
	 * @param number $esam
	 * @param number $visitnum_progr
	 * @param String $testo_waiting
	 * @return String
	 */
	function CheckClosure($visitnum = null, $esam = null, $visitnum_progr = null, $testo_waiting = null) {
		unset($bind);
		if (isset ( $visitnum ))
		if (is_array($visitnum)) {
			foreach ($visitnum as $key=>$val){
				$ins.="$val,";
			}
			$ins=rtrim($ins,",");
			$where .= "and visitnum in ($ins)";
		}

		else
		{
			$where .= "and visitnum=:visitnum";
			$bind['VISITNUM']=$visitnum;
		}
		if (isset ( $esam )){
			$where .= "and esam=:esam";
			$bind['ESAM']=$esam;
		}
		if (isset ( $visitnum_progr )){
			$where .= "and visitnum_progr=$visitnum_progr";
			$bind['VISITNUM_PROGR']=$visitnum_progr;
		}
		$where_agg='';
		if ($this->integrazione->eq_enabled && $this->integrazione->eq_int) $where_agg=" and nvl(eq_action,1)!=2";
		$sql_query = "
			select esam, progr,visitnum, visitnum_progr, inizio, {$this->config_service['PK_SERVICE']} from {$this->service}_coordinate
			where {$this->config_service['PK_SERVICE']}=:pk_service
			and nvl(fine,0)<>1 $where_agg
			$where
		";
			
			$bind['PK_SERVICE']=$this->pk_service;
			$sql = new query ( $this->conn );
			$sql->exec ( $sql_query,$bind );//binded
			$message = "";
			$completed = true;
			while ( $sql->get_row () ) {
				if (!isset($this->vlist->esams[$sql->row['VISITNUM']][$sql->row['ESAM']])) continue;
				if ($sql->row ['INIZIO'] == '') {

					if ($this->vlist->esams [$sql->row ['VISITNUM']] [$sql->row ['ESAM']] ['OPTIONAL'] == '') {
						$returns [] ['TEXT'] = $this->testo('The form')." {$this->vlist->esams[$sql->row['VISITNUM']][$sql->row['ESAM']]['TESTO']} ".$this->testo('is incomplete');
						if($this->vlist->esams[$sql->row['VISITNUM']][$sql->row['ESAM']]['SFOGLIA_CALL']=="yes")
						$returns [count ( $returns ) - 1] ['href'] = "index.php?VISITNUM={$sql->row['VISITNUM']}&ESAM={$sql->row['ESAM']}&VISITNUM_PROGR={$sql->row['VISITNUM_PROGR']}&{$this->config_service['PK_SERVICE']}={$sql->row[$this->config_service['PK_SERVICE']]}";
						else
						$returns [count ( $returns ) - 1] ['href'] = "index.php?VISITNUM={$sql->row['VISITNUM']}&ESAM={$sql->row['ESAM']}&PROGR={$sql->row['PROGR']}&VISITNUM_PROGR={$sql->row['VISITNUM_PROGR']}&{$this->config_service['PK_SERVICE']}={$sql->row[$this->config_service['PK_SERVICE']]}";
						$completed = false;
					}
				} else {
					if (! ($this->closeable_esam ( $sql->row ['VISITNUM'], $sql->row ['ESAM'], $sql->row ['VISITNUM_PROGR'], $sql->row ['PROGR'] ))) {
						$returns [] ['TEXT'] = $this->testo('The form')." {$this->vlist->esams[$sql->row['VISITNUM']][$sql->row['ESAM']]['TESTO']} ".$this->testo('is incomplete');
						if($this->vlist->esams[$sql->row['VISITNUM']][$sql->row['ESAM']]['SFOGLIA_CALL']=="yes")
						$returns [count ( $returns ) - 1] ['href'] = "index.php?VISITNUM={$sql->row['VISITNUM']}&ESAM={$sql->row['ESAM']}&PROGR={$sql->row['PROGR']}&VISITNUM_PROGR={$sql->row['VISITNUM_PROGR']}&{$this->config_service['PK_SERVICE']}={$sql->row[$this->config_service['PK_SERVICE']]}";
						else
						$returns [count ( $returns ) - 1] ['href'] = "index.php?VISITNUM={$sql->row['VISITNUM']}&ESAM={$sql->row['ESAM']}&PROGR={$sql->row['PROGR']}&VISITNUM_PROGR={$sql->row['VISITNUM_PROGR']}&{$this->config_service['PK_SERVICE']}={$sql->row[$this->config_service['PK_SERVICE']]}";
						$completed = false;
					}
				}
			}
			$ret ['Check'] = $completed;
			$ret ['AggInfo'] = $returns;
			return $ret;
	}

	/**
	 * Chiude tutte le schede
	 *
	 * @param number $visitnum
	 * @param number $esam
	 * @param number $visitnum_progr
	 * @param String $redir_url
	 * @param String $testo_waiting
	 * @return String
	 */
	function close_all($visitnum = null, $esam = null, $visitnum_progr = null, $redir_url = null, $testo_waiting = null) {
		unset($bind);
		if (isset ( $visitnum )){
			$where .= "and visitnum=:visitnum";
			$bind['VISITNUM']=$visitnum;
		}
		if (isset ( $esam )){
			$where .= "and esam=$esam";
			$bind['ESAM']=$esam;
		}
		if (isset ( $visitnum_progr ))
		$where .= "and visitnum_progr=$visitnum_progr";
		$sql_query = "
			select esam, progr,visitnum, visitnum_progr, inizio from {$this->service}_coordinate
			where {$this->config_service['PK_SERVICE']}=:pk_service
			and nvl(fine,0)<>1
			$where
		";
			$sql = new query ( $this->conn );
			
			$bind['PK_SERVICE']=$this->pk_service;
			$sql->exec ( $sql_query ,$bind); //binded
			$message = "";
			$completed = true;
			while ( $sql->get_row () ) {
				if ($sql->row ['INIZIO'] == '') {
					if ($this->vlist->esams [$sql->row ['VISITNUM']] [$sql->row ['ESAM']] ['OPTIONAL'] == '') {
						$str_incompleted .= "<li>La scheda {$this->vlist->esams[$sql->row['VISITNUM']][$sql->row['ESAM']]['TESTO']} &egrave; incompleta</li>";
						$completed = false;
					}
				}
				/* XXX non togliere - lorenzo 7/7/2010
				 else if ($this->vlist->esams[$sql->row['VISITNUM']][$sql->row ['ESAM']]['CONDITIONAL'] != ''){
				 error_log("----------- conditional");
				 $cond_var = $this->vlist->esams[$sql->row['VISITNUM']][$sql->row['ESAM']]['CONDITION_VAR'];
				 $cond_val = $this->vlist->esams[$sql->row['VISITNUM']][$sql->row['ESAM']]['CONDITION_VALUE'];
				 $cond_tb = $this->vlist->esams[$sql->row['VISITNUM']][$sql->row['ESAM']]['CONDITION_TABLE'];

				 // TODO riguardare
				 $query = "SELECT {$cond_var} FROM {$cond_tb} where {$this->config_service['PK_SERVICE']} = {$in['{$this->config_service['PK_SERVICE']}']} AND VISITNUM_PROGR = {$in['VISITNUM_PROGR']}";
				 $sql = new query($this->conn);
				 $sql->exec($query);
				 $sql->get_row();

				 if ($sql->row[$cond_var] == $cond_val) {
					// condition true
					} else { // condition false
					$completed = false;
					// TODO cambiare messaggio
					$str_incompleted .= "<li>La scheda {$this->vlist->esams[$sql->row['VISITNUM']][$sql->row['ESAM']]['TESTO']} &egrave; incompleta</li>";
					}
					}
					*/
				else {
					if (! ($this->closeable_esam ( $sql->row ['VISITNUM'], $sql->row ['ESAM'], $sql->row ['VISITNUM_PROGR'], $sql->row ['PROGR'] ))) {
						$str_incompleted .= "<li>La scheda {$this->vlist->esams[$sql->row['VISITNUM']][$sql->row['ESAM']]['TESTO']} &egrave; incompleta</li>";
						$completed = false;
					}
				}
			}
			if ($completed) {
				$sql_update = "
				update {$this->service}_coordinate set FINE=1, MODDT=sysdate
				where {$this->config_service['PK_SERVICE']}=:pk_service
				and fine<>1
				$where
			";
				$this->session_vars ['VISITNUM'] = $visitnum;
				$sql = new query ( $this->conn );
				$sql->ins_upd ($sql_update,$bind);//binded
				$sql_update = "
				update {$this->service}_coordinate set VISITCLOSE=1
				where {$this->config_service['PK_SERVICE']}=:pk_service
				$where
			";
				$sql->ins_upd ($sql_update,$bind);//binded
				if (isset ( $_GET ['NOTE_CHIUSURA_SPEC'] )) {
					$tb = $this->vlist->visitnums [$visitnum] ['CLOSE_VISIT_NOTE_ATTR'] ['TB'];
					$note = $this->vlist->visitnums [$visitnum] ['CLOSE_VISIT_NOTE_ATTR'] ['FIELD'];
					$tb = "{$this->service}_$tb";
					$values = '';
					$values [$note] = $_GET ['NOTE_CHIUSURA_SPEC'];
					$pk [$this->config_service ['PK_SERVICE']] = $this->pk_service;
					$sql->update ( $values, $tb, $pk );
				}
				$this->conn->commit ();
				if ($testo_waiting == null)
				$testo_waiting = "Save data...<br>Waiting";
				if (isset ( $redir_url ))
				die ( "<html><head><meta http-equiv=\"refresh\" content=\"0;url=$redir_url\"></head><body>$testo_waiting</body></html>" );
				else
				die ( "<html><head><meta http-equiv=\"refresh\" content=\"0;url=index.php?&exams=visite_exam.xml&{$this->config_service['PK_SERVICE']}={$this->pk_service}&CENTER={$this->session_vars['CENTER']}\"></head><body>$testo_waiting</body></html>" );

			}
			if ($this->config_service ['testo_chiusura_non_possibile'] != '')
			$testo_incompleted = $this->config_service ['testo_chiusura_non_possibile'];
			else
			$testo_incompleted = "Attenzione non &ograve; possibile chiudere la/e schede in quanto";
			$str_incompleted = "
			<p class=titolo>$testo_incompleted:</p>
				<div style=\"color:red;font-weight:bold\">" . $str_incompleted . "</div><br>
			<a href=\"index.php?&exams=visite_exam.xml&{$this->config_service['PK_SERVICE']}={$this->pk_service}&CENTER={$this->session_vars['CENTER']}\">&lt;&lt; indietro</a>
				";
			return $str_incompleted;
	}

	/**
	 * Controlla se una schede rispetta i requisiti per essere chiusa
	 *
	 * @param number $visitnum
	 * @param number $esam
	 * @param number $visitnum_progr
	 * @param number $progr
	 * @return String
	 */
	function closeable_esam($visitnum, $esam, $visitnum_progr, $progr) {
		Logger::send('$visitnum',$visitnum);
		Logger::send('$esam',$esam);
		Logger::send('$visitnum_progr',$visitnum_progr);
		Logger::send('$progr',$progr);
		$sql_query = "
			select fine from {$this->service}_coordinate
				where {$this->config_service['PK_SERVICE']}={$this->pk_service}
				and visitnum=$visitnum
				and visitnum_progr=$visitnum_progr
				and esam=$esam
				and progr=$progr
				";
		$sql = new query ( $this->conn );
		$sql->get_row ( $sql_query );
		if ($sql->row ['FINE'] == 1)
		return true;
		$xml_file = $this->vlist->esams [$visitnum] [$esam] ['XML'];
		$session_vars = $this->session_vars;
		$session_vars ['VISITNUM'] = $visitnum;
		$session_vars ['VISITNUM_PROGR'] = $visitnum_progr;
		$session_vars ['PROGR'] = $progr;
		$session_vars ['ESAM'] = $esam;
		$xml_form = new xml_form ( $this->conn, $this->service, $this->config_service, $session_vars, $this->uploaded_file_dir );
		$xml_form->xml_form_by_file ( $this->xml_dir . '/' . $xml_file );
		$xml_form->closed_form ();
		foreach ( $xml_form->tb_vals as $key => $val ) {
			$session_vars [$key] = $val;
		}
		$session_vars ['INVIOCO'] = 1;
		$xml_form = new xml_form ( $this->conn, $this->service, $this->config_service, $session_vars, $this->uploaded_file_dir );
		$xml_form->xml_form_by_file ( $this->xml_dir . '/' . $xml_file );
		if ($xml_form->valida ()) {
			return true;
		} else {
			return false;
		}
	}

	/**
	 * Modalità di visualizzazione ALL_IN delle schede progressive
	 *
	 * @param String $xml_form
	 * @return String
	 */
	 
	function all_in_form_view($xml_form) {
	
		//$exclude_visit si riferisce anche ad exclude_esam si consiglia di rinominare la variabile appena possibile 
		//al momento non si considera per l'exclude esam la visitnum verificare che impatto ci sarebbe a modificare e correggere
	
		if($this->config_service['eQuerySpec']['Integrazione']['EXCLUDE_VISIT'][$this->config_service['service']][$_GET['VISITNUM']]!="")
		$exclude_visit=$this->config_service['eQuerySpec']['Integrazione']['EXCLUDE_VISIT'][$this->config_service['service']][$_GET['VISITNUM']];
		else
		$exclude_visit=$this->config_service['eQuerySpec']['Integrazione']['EXCLUDE_VISIT'][$_GET['VISITNUM']];
		if(!$exclude_visit){
			if($this->config_service['eQuerySpec']['Integrazione']['EXCLUDE_ESAM'][$this->config_service['service']][$_GET['ESAM']]!="")
			$exclude_visit=$this->config_service['eQuerySpec']['Integrazione']['EXCLUDE_VISIT'][$this->config_service['service']][$_GET['VISITNUM']];
			else
			$exclude_visit=$this->config_service['eQuerySpec']['Integrazione']['EXCLUDE_ESAM'][$_GET['ESAM']];
		}
	
		$this->session_vars ['form'] = $xml;
		$vlist = $this->vlist;
		$in = $this->session_vars;
		$conn = $this->conn;
		$service = $this->service;
		$sql_query = "select max(progr) as max_p from {$service}_coordinate where {$this->config_service['PK_SERVICE']}=:pk_service and esam=:esam and visitnum=:visitnum and VISITNUM_PROGR=:visitnum_progr and inizio is not null";
//		echo $sql_query;
		unset($bind);
		$bind['PK_SERVICE']=$in[$this->config_service['PK_SERVICE']];
		$bind['ESAM']=$in['ESAM'];
		$bind['VISITNUM']=$in['VISITNUM'];
		$bind['VISITNUM_PROGR']=$in['VISITNUM_PROGR'];
		$sql = new query ( $conn );
		$sql->exec ($sql_query ,$bind); //binded
		$sql->get_row (); 
// 		
// 		
		$sql->row['MAX_P']-=0;
		if ($this->session_vars['USER_TIP']=='DE' && $sql->row['MAX_P']<1 && $this->vlist->esams[$_GET['VISITNUM']][$_GET ['ESAM']]['QUICKACCESS']=='yes' && !isset($_GET['NoQuickAccess'])){
			$linkff="{$_SERVER['REQUEST_URI']}&PROGR=1";
			
			header("Location: $linkff");
			die();
		}
		$m_p = $sql->row ['MAX_P'];
		$max = $m_p - 0;
		if ($m_p == '' || $m_p == 0)
		$m_p ++;
		$real_progr = $_GET ['PROGR'];
		$next = $m_p + 1;
// 		
		if (isset ( $_GET ['PROGR'] )) {
			/*Controllo di visibilita*/
			if (isset ( $this->vlist->esams [$_GET ['VISITNUM']] [$_GET ['ESAM']] ['VIEWABLE_ON_CLOSE'] ) && $this->vlist->esams [$_GET ['VISITNUM']] [$_GET ['ESAM']] ['VIEWABLE_ON_CLOSE'] != '') {
				if ($_GET ['VISITNUM_PROGR'] == '')
				$_GET ['VISITNUM_PROGR'] = 0;
				$sql_query = "
								select
									fine,
									userid
								from {$service}_coordinate
								where visitnum={$_GET['VISITNUM']}
								and visitnum_progr={$_GET['VISITNUM_PROGR']}
								and esam={$_GET['ESAM']}
								and progr={$_GET ['PROGR']}
								and {$this->config_service['PK_SERVICE']}={$this->pk_service}
								";
	
				$sql_abil = new query ( $this->conn );
				$sql_abil->get_row ( $sql_query );
				if ($sql_abil->row ['FINE'] != 1 && ($sql_abil->row ['USERID'] != $this->user->userid && $in ['USER_TIP'] != 'DE')) {
					error_page ( $this->user->userid, $this->testo ( "userNotCenter" ), "" );
				}
			}
			$xml_form->make_html ();
			$script = "
				<script type=\"text/javascript\">
				" . $xml_form->salva_js . "
				" . $xml_form->invia_js . "
				" . $xml_form->check_js . "
				" . $xml_form->inrevisione_js . "
				</script>
				";
			$onload .= $xml_form->onload . ";";
			if ($this->pk_service != '' && $this->pk_service != 'next') {
				$this->make_patient_table ();
				$body = $this->patient_table;
				$body .= "<br><br>" . $this->tb_riassuntiva ();
			} else
			$body = '';
			$body .= $xml_form->body;
		} else {
			$colspan = 4;
			if (isset ( $xml_form->form ['FIELD_AGG'] )) {
				/*Modalità con modifica diretta dei valori in schema riassuntivo*/
				$tr_agg = "<tr>";
				$fields_agg = explode ( "|", $xml_form->form ['FIELD_AGG'] );
				$fields_agg_txt = explode ( "|", $xml_form->form ['FIELD_AGG_TXT'] );
				if (isset ( $_GET ['ADDBLANK'] )) {
					/*Aggiunta di scehda vuota*/
					if($sql->row['MAX_P']!="") {
						if($sql->row['MAX_P']>=$_GET ['ADDBLANK'] || $sql->row['MAX_P']+1<$_GET ['ADDBLANK']) {
							error_page ( $remote_userid, "La scheda numero {$_GET ['ADDBLANK']} è già stata inserita. Non utilizzare il tasto back del browser o ritornare alla lista schede aggiornata.", "La scheda numero {$_GET ['ADDBLANK']} è già stata inserita. Non utilizzare il tasto back del browser o ritornare alla lista schede aggiornata." );
						}
					}
					if (! isset ( $_GET ['VISITNUM_PROGR'] ) || $_GET ['VISITNUM_PROGR'] == '')
					$_GET ['VISITNUM_PROGR'] = 0;
					$redirect = $_SERVER ['REQUEST_URI'];
					$redirect = str_replace ( "&ADDBLANK={$_GET['ADDBLANK']}", "", $redirect );
					$values ['INIZIO'] = 1;
					$values ['ABILITATO'] = 1;
					$values ['USERID'] = $this->user->userid;
					$values ['INSERTDT'] = sysdate;
					$values [$this->config ['PK_SERVICE']] = $_GET [$this->config ['PK_SERVICE']];
					$tb_prefix = "{$this->service}";
					$sql_query = "
								select count(*) as conto from {$tb_prefix}_coordinate
								where
									VISITNUM={$_GET['VISITNUM']}
									and
									VISITNUM_PROGR={$_GET['VISITNUM_PROGR']}
									and
									ESAM={$_GET['ESAM']}
									and
									PROGR={$_GET['ADDBLANK']}
									and
									{$this->config['PK_SERVICE']}={$_GET[$this->config['PK_SERVICE']]}
							";
									$sql->get_row ( $sql_query );
	
										if ($this->integrazione->eq_enabled && $this->integrazione->role==$this->user->profilo){
										if ($this->integrazione->eq_int=='') $this->integrazione->CreateEq();
										$values['INV_QUERY']=$this->integrazione->eq_int;
										$values['EQ_ACTION']=1;
									}
									if ($sql->row ['CONTO'] == 0) {
										$values ['VISITNUM'] = $_GET ['VISITNUM'];
										$values ['VISITNUM_PROGR'] = $_GET ['VISITNUM_PROGR'];
										$values ['ESAM'] = $_GET ['ESAM'];
										$values ['PROGR'] = $_GET ['ADDBLANK'];
										$values [$this->config ['PK_SERVICE']] = $_GET [$this->config ['PK_SERVICE']];
										$tb_coord = $tb_prefix . "_coordinate";
										$pk = '';
										$sql->insert ( $values, $tb_coord, $pk );
									} else {

										$tb_coord = $tb_prefix . "_coordinate";
										$pk ['VISITNUM'] = $_GET ['VISITNUM'];
										$pk ['VISITNUM_PROGR'] = $_GET ['VISITNUM_PROGR'];
										$pk ['ESAM'] = $_GET ['ESAM'];
										$pk ['PROGR'] = $_GET ['ADDBLANK'];

										$pk [$this->config ['PK_SERVICE']] = $_GET [$this->config ['PK_SERVICE']];
										$sql->update ( $values, $tb_coord, $pk );
									}
									$pk = '';
									$values = '';
									$values ['VISITNUM'] = $_GET ['VISITNUM'];
									$values ['VISITNUM_PROGR'] = $_GET ['VISITNUM_PROGR'];
									$values ['ESAM'] = $_GET ['ESAM'];
									$values ['PROGR'] = $_GET ['ADDBLANK'];
									$values [$this->config ['PK_SERVICE']] = $_GET [$this->config ['PK_SERVICE']];
									$tb_ = $xml_form->form ['TABLE'];

									$sql->insert ( $values, $tb_, $pk );

									if ((isset ( $this->vlist->esams [$_GET ['VISITNUM']] [$_GET ['ESAM']] ['SFOGLIA_CALL'] )) && $this->vlist->esams [$_GET ['VISITNUM']] [$_GET ['ESAM']] ['SFOGLIA_CALL'] == 'yes') {
										$redirect .= "&CALL_Sfoglia";
									}

									$this->conn->commit ();
									header ( "location:$redirect" );
									die ();
				}
				if (isset ( $_POST ['ApplMod'] )) {
					/*Applico le modifiche*/
					$redirect = $_SERVER ['REQUEST_URI'];
					$param='';
					foreach ($_GET as $key => $val){
						if ($key!='CALL_Sfoglia')
						$param.="$key=$val&";
					}
					$param=rtrim($param, "&");
					$redirect="index.php?{$param}";
					$table = $xml_form->form ['TABLE'];
	
					$visitnum = $_GET ['VISITNUM'];
					$esam = $_GET ['ESAM'];
					if ($_GET ['VISITNUM_PROGR'] != '')
					$visitnum_progr = $_GET ['VISITNUM_PROGR'];
					else
					$visitnum_progr = 0;
					foreach ( $fields_agg as $fk => $field ) {
						foreach ( $xml_form->fields as $key => $val ) {
							if ($val ['VAR'] == $field) {

								foreach ( $_POST as $pkey => $pval ) {
									$field = new field ( $xml_form, $key );

									if (preg_match ( "!^{$val ['VAR']}_PROGR_!", $pkey ) && ! preg_match ( "!D$!", $pkey ) && ! preg_match ( "!M$!", $pkey ) && ! preg_match ( "!Y$!", $pkey ) && ! preg_match ( "!RC$!", $pkey )) {
										$progr = str_replace ( "{$val ['VAR']}_PROGR_", "", $pkey );
										if ($val ['TYPE'] == 'radio') {
											$values [$progr] ["D_" . $val ['VAR']] = $field->values [$_POST [$val ['VAR'] . "_PROGR_" . $progr]];
										}
										if ($val ['TYPE'] == 'select') {
											$values [$progr] ["D_" . $val ['VAR']] = $field->values [$_POST [$val ['VAR'] . "_PROGR_" . $progr]];

										}
										$values [$progr] [$val ['VAR']] = $pval;
										if ($val ['TYPE'] == 'data') {
											if ($pval != '') {
												$values [$progr] [$val ['VAR']] = "to_date('{$pval}','DDMMYYYY')";
												$values [$progr] [$val ['VAR'] . "RC"] = "OKOKOK";
											} else
											unset ( $values [$progr] [$val ['VAR']] );
										}
									}
								}
							}
						}
					}
					foreach ( $values as $progr => $values_ ) {
						$pk [$this->config_service ['PK_SERVICE']] = $this->pk_service;
						$pk ['VISITNUM'] = $visitnum;
						$pk ['VISITNUM_PROGR'] = $visitnum_progr;
						$pk ['ESAM'] = $esam;
						$pk ['PROGR'] = $progr;
						if (count ( $values_ ) > 0) {
							//echo "<hr>$progr";
							$sql = new query ( $this->conn );
							$sql->update ( $values_, $table, $pk );
							//ufficio prova 1
							//							$sql_uff = new query ( $this->conn );
							//							$sql_uff->update ( $values_, "CP_VI_CONFEZIONI_UFF", $pk );
								
						}
						if (isset($this->integrazione) && $this->integrazione->eq_int!=''){
// 							
							$sql_query_coord="select eq_action from {$this->service}_COORDINATE
								where 
								visitnum=:visitnum
								and visitnum_progr=:visitnum_progr
								and progr=:progr
								and esam=:esam 
								and {$this->config_service ['PK_SERVICE']}=:pk_service
								";
							$bind_['visitnum']=$visitnum;
							$bind_['visitnum_progr']=$visitnum_progr;
							$bind_['progr']=$progr;
							$bind_['pk_service']=$this->pk_service;
							$bind_['esam']=$esam;
							$sql->get_row($sql_query_coord, $bind_);
// 							
							$action=$sql->row['EQ_ACTION']-0;
							foreach ($values_ as $field=>$val){
							$bind1='';
// 									
									$sql_query="select count(*) as C from {$this->service}_EQFIELD 
									where eq_int=:eq_int
									and visitnum=:visitnum
									and visitnum_progr=:visitnum_progr
									and progr=:progr
									and esam=:esam
									and field=:field
									and {$this->config_service ['PK_SERVICE']}=:pk_service";
									$bind1['eq_int']=$this->integrazione->eq_int;
								$bind1['visitnum']=$visitnum;
							$bind1['visitnum_progr']=$visitnum_progr;
							$bind1['progr']=$progr;
									$bind1['pk_service']=$this->pk_service;
							$bind1['esam']=$esam;
									$bind1['field']=$field;
									$sql->get_row($sql_query, $bind1);
// 							
							$eqPkAssoc['EQ_INT']=$this->integrazione->eq_int;
							$eqPkAssoc['VISITNUM']=$visitnum;
									$eqPkAssoc['VISITNUM_PROGR']=$visitnum_progr;
									$eqPkAssoc['PROGR']=$progr;
									$eqPkAssoc[$this->config_service ['PK_SERVICE']]=$this->pk_service;
									$eqPkAssoc['ESAM']=$esam;
							$eqPkAssoc['FIELD']=$field;
							if ($sql->row['C']>0){
							$eqValues='';
							$eqValues['VALORE']=$val;
							$eqValues['ACTION']=$action;
// 							
								
										$sql->update($eqValues, $this->service."_EQFIELD", $eqPkAssoc);
							}
									else {
// 							
							$eqValues='';
										$eqpk='';
							$eqValues['VALORE']=$val;
										$eqValues['ACTION']=$action;
										foreach ($eqPkAssoc as $bk=>$bv){
										$eqValues[$bk]=$bv;
							}
										$sql->insert($eqValues, $this->service."_EQFIELD", $eqpk);
						}
					}
											
							}
							
							}
					if ($xml_form->form ['F_TO_CALL'] != '') {
						$f_to_call = $xml_form->form ['F_TO_CALL'];
						$f_to_call ( $xml_form );
					}
					$this->conn->commit ();
					header ( "location:$redirect" );
					die ();
				}
				/*Header della tabella*/
				foreach ( $fields_agg_txt as $key => $val ) {
					$field_agg_txt .= "<td class=int>$val</td>";
				}
				foreach ( $fields_agg as $fk => $field ) {
					$colspan ++;
					foreach ( $xml_form->fields as $key => $val ) {
						if ($val ['VAR'] == $field) {
							$nextrow = count ( $type_fields_agg );
							foreach ( $val as $k => $v ) {
								$type_fields_agg [$nextrow] [$k] = $v;
							}
							$field_tot = '';
							$field_type="field_".$val['TYPE'];

							if ($val['TYPE']!='file_doc')
							$select_field .= "$field,";
							if ($this->config_service['field_lib'] != '' && file_exists ( $this->config_service['field_lib'] . $field_type . ".inc" )) {
								include_once $this->config_service['field_lib'] . $field_type . ".inc";
							} else {
								include_once "{$field_type}.inc";
							}
							//include_once "libs/$field_type.inc";
							$tr_agg.=call_user_func(array($field_type, "S_all_in"), $field, $m_p, $xml_form);
						}
					}
				}

				$rowspan = " rowspan='2'";
				$tr_agg .= "</tr>";
			}
			$sql = new query ( $this->conn );
			if ($_GET ['VISITNUM_PROGR'] == '')
			$visitnum_progr = 0;
			else
			$visitnum_progr = $_GET ['VISITNUM_PROGR'];
			$where_agg_eq='';
				if ($this->config_service['eQuerySpec']['Integrazione']['ON'] && (!$this->integrazione->eq_enabled || $this->integrazione->eq_int==''))
				$where_agg_eq="and (INV_QUERY is null or EQ_ACTION=2)";
					
			$sql_query = "select min(fine) as fine from {$this->service}_coordinate where
			VISITNUM={$_GET['VISITNUM']}
			and esam={$_GET['ESAM']}
			and {$this->config_service['PK_SERVICE']}={$this->pk_service}
			and visitnum_progr=$visitnum_progr
			$where_agg_eq
			";
			$sql->get_row ( $sql_query );
			if (($sql->row ['FINE'] == 1 || $this->session_vars ['USER_TIP'] != 'DE') && !($this->integrazione->eq_enabled && $this->integrazione->role==$this->user->profilo && !$exclude_visit)) {
				$closed_all = true;
				$rowspan = "";
				$tr_agg = "";
				$colspan --;
				$elimina_col = "";
			} else {
				$closed_all = false;
				if ($this->vlist->esams [$in ['VISITNUM']] [$in ['ESAM']] ['TRASH'] != '' && ($this->session_vars ['USER_TIP'] == 'DE' || $this->integrazione->eq_enabled))
					$elimina_col = "<td class='int' width='40' align='center' $rowspan>Elimina</td>";
			}
			$body.=$this->tb_riassuntiva();
			$body .= "
				<p align=center><b>{$vlist->esams[$in['VISITNUM']][$in['ESAM']]['TESTO']}</b></p>
				<form method=\"POST\" name=\"ALL_IN_FORMS\" action=\"index.php?VISITNUM_PROGR={$_GET['VISITNUM_PROGR']}&{$this->config_service['PK_SERVICE']}={$_GET[$this->config_service['PK_SERVICE']]}&ESAM={$_GET['ESAM']}&VISITNUM={$_GET['VISITNUM']}\">
				<table border=0 cellpadding=0 cellspacing=2 width=95%>";
			$col_modifica=true;
			if ($xml_form->form ['NO_MOD_COL'] != '')
			$col_modifica = false;
			if ($col_modifica)
			if (strtolower ( $this->config_service ['lang'] ) == 'en') {
				$col_modifica_header = "<td class=int width=40 align=center $rowspan>View/Update </td>";
				$col_num_txt = "Number";
			} else {
				$col_modifica_header = "<td class=int width=40 align=center $rowspan>Modifica/visualizza </td>";
				$col_num_txt = "N.ro";
			}
			if ($max > 0) {
				if ($xml_form->form ['TB_HEADER'] != '')
				$tb_header = "<td class=int $rowspan>{$xml_form->form['TB_HEADER']}</td>";
				else
				$tb_header = "";

				if(isset($xml_form->form['FIELD_TB_PLUS'])) {
				$tb_header_split=explode("|",$xml_form->form['FIELD_TB_PLUS_DECODE']);
				//				print_r($tb_header_split);
						$tb_plus_header="";
						foreach($tb_header_split as $key => $val) {
				$val=str_replace("'","",$val);
				$tb_plus_header.="<td class=int nowrap>$val</td>";
				}
				}
	
				$body .= "
						<tr>
							<td class=int $rowspan>$col_num_txt</td>
							$tb_header
							$field_agg_txt
								$tb_plus_header
							$col_modifica_header
							$elimina_col
						</tr>
						$tr_agg
						";
			}
			if ($in ['PROGR'] > $m_p)
			$m_p = $in ['PROGR'];
			if ($max > 0)
			$all_closed = true;
			$counter=0;
			for($i = 1; $i <= $max; $i ++) {

				if ($_GET ['VISITNUM_PROGR'] == '')
				$_GET ['VISITNUM_PROGR'] = 0;
	
					$where_agg="";
				if($this->config_service['eQuerySpec']['Integrazione']['ROLE'][$this->config_service['service']]!=$this->session_vars['WFact'] && $confs!="") {
						$where_agg=" and EQ_ACTION is null";
				}
				$sql_query = "
								select
				INIZIO,
									FINE,
				USERID,
				VISITCLOSE,
									ABILITATO,
									EQ_ACTION
								from {$service}_coordinate
								where visitnum={$_GET['VISITNUM']}
								and visitnum_progr={$_GET['VISITNUM_PROGR']}
								and esam={$_GET['ESAM']}
								and progr=$i
								and {$this->config_service['PK_SERVICE']}={$this->pk_service}
								$where_agg
								";
				$sql_abil = new query ( $this->conn );
				if (!$sql_abil->get_row ( $sql_query )) continue;
				if ($sql_abil->row['ABILITATO']!=1) continue;
				if ($sql_abil->row['INIZIO']!=1 && $sql_abil->row['VISITCLOSE']==1) continue;
				$eq_new=false;
	
	
				if ($this->integrazione->eq_enabled && $this->integrazione->eq_int!=''){
					if ($sql_abil->row['EQ_ACTION']==1) {
						$eq_new=true;
					}
					//if ($sql_abil->row['EQ_ACTION']==2) continue;
				}else {
					if ($sql_abil->row['EQ_ACTION']==1) continue;
				}

				if (isset ( $this->vlist->esams [$_GET ['VISITNUM']] [$_GET ['ESAM']] ['VIEWABLE_ON_CLOSE'] ) && $this->vlist->esams [$_GET ['VISITNUM']] [$_GET ['ESAM']] ['VIEWABLE_ON_CLOSE'] != '') {
					if ($_GET ['VISITNUM_PROGR'] == '')
					$_GET ['VISITNUM_PROGR'] = 0;

					$sql_query = "
								select
									fine,
									userid
								from {$service}_coordinate
								where visitnum={$_GET['VISITNUM']}
								and visitnum_progr={$_GET['VISITNUM_PROGR']}
								and esam={$_GET['ESAM']}
								and progr=$i
								and {$this->config_service['PK_SERVICE']}={$this->pk_service}
								";
					$sql_abil = new query ( $this->conn );
					$sql_abil->get_row ( $sql_query );
					if ($sql_abil->row ['FINE'] != 1 && $sql_abil->row ['USERID'] != $this->user->userid)
					continue;
				}
				if ($sql_abil->row['FINE']==1) $this_close=true;
				else $this_close=false;
				$body .= "<tr>";
				$counter++;
				if ($i != $real_progr) {
					$in ['PROGR'] = $i;
						$table=$xml_form->form['TABLE'];
				$sql_query = "select $select_field {$xml_form->form['FIELD_TB_SHOW']} as FIELD_TB_SHOW from $table where {$this->config_service['PK_SERVICE']}='{$in[$this->config_service['PK_SERVICE']]}' and visitnum={$in['VISITNUM']} and visitnum_progr={$in['VISITNUM_PROGR']} and progr=$i";
						
						if ($this->integrazione->eq_enabled && $this->integrazione->eq_int!='' && $sql_abil->row['EQ_ACTION']==''){
							
							$sql_query_eq="select FIELD, VALORE from {$this->service}_EQFIELD where eq_int=:eq_int and action=0 and esam=:esam and visitnum=:visitnum and visitnum_progr=:visitnum_progr and progr=:progr and {$this->config_service['PK_SERVICE']}=:pk_service";
						
							$bind_eq["eq_int"]=$this->integrazione->eq_int;
							$bind_eq['esam']=$_GET['ESAM'];
							$bind_eq['visitnum']=$_GET['VISITNUM'];
					$bind_eq['visitnum_progr']=$_GET['VISITNUM_PROGR']-0;
							$bind_eq['progr']=$i;
				$bind_eq['pk_service']=$_GET[$this->config_service['PK_SERVICE']];
							$sql2=new query($this->conn);
				$sql2->exec($sql_query_eq, $bind_eq);
							while ($sql2->get_row()){
				$eqValues[$i][$sql2->row['FIELD']]=$sql2->row['VALORE'];
				}
							if (count($eqValues[$i])>0){
				$sql_query_tb_descr="select column_name from user_tab_columns where TABLE_NAME=upper('$table')";
					$fromTBeq="select ";
								$sql2->exec($sql_query_tb_descr);
					$bind2='';
					while ($sql2->get_row()){
					if (isset($eqValues[$i][$sql2->row['COLUMN_NAME']])) {
							$fromTBeq.=":{$sql2->row['COLUMN_NAME']}_EQ as {$sql2->row['COLUMN_NAME']},";
							$bind2[$sql2->row['COLUMN_NAME']."_EQ"]=$eqValues[$i][$sql2->row['COLUMN_NAME']];
					}else
					$fromTBeq.="{$sql2->row['COLUMN_NAME']},";
					}
					$fromTBeq=rtrim($fromTBeq, ",");
					$fromTBeq.=" from $table where {$this->config_service['PK_SERVICE']}=:pk_service and visitnum=:visitnum and visitnum_progr=:visitnum_progr and esam=:esam and progr=:progr";
					$bind2['esam']=$_GET['ESAM'];
					$bind2['visitnum']=$_GET['VISITNUM'];
								$bind2['visitnum_progr']=$_GET['VISITNUM_PROGR']-0;
								$bind2['progr']=$i;
								$bind2['pk_service']=$_GET[$this->config_service['PK_SERVICE']];
								$sql = new query ( $conn );
								$sql_query="select $select_field {$xml_form->form['FIELD_TB_SHOW']} as FIELD_TB_SHOW from ($fromTBeq)";
								//$sql->set_sql ($sql_query , $bind2);
// 								
// 								
								$sql->exec ($sql_query, $bind2);
									
								
					}else {
								$sql_query = "select $select_field {$xml_form->form['FIELD_TB_SHOW']} as FIELD_TB_SHOW from $table where {$this->config_service['PK_SERVICE']}=:pk_service and esam=:esam and visitnum=:visitnum and visitnum_progr=:visitnum_progr and progr=:progr";
								$bind3['esam']=$in['ESAM'];
								$bind3['visitnum']=$in['VISITNUM'];
								$bind3['visitnum_progr']=$in['VISITNUM_PROGR']-0;
								$bind3['progr']=$i;
								$bind3['pk_service']=$in[$this->config_service['PK_SERVICE']];
								$sql = new query ( $conn );
// 								
								$sql->exec ($sql_query,$bind3);
								}
							}else {
								$sql_query = "select $select_field {$xml_form->form['FIELD_TB_SHOW']} as FIELD_TB_SHOW from $table where {$this->config_service['PK_SERVICE']}=:pk_service and esam=:esam and visitnum=:visitnum and visitnum_progr=:visitnum_progr and progr=:progr";
								$bind3['esam']=$in['ESAM'];
								$bind3['visitnum']=$in['VISITNUM'];
								$bind3['visitnum_progr']=$in['VISITNUM_PROGR']-0;
								$bind3['progr']=$i;
								$bind3['pk_service']=$in[$this->config_service['PK_SERVICE']];
								$sql = new query ( $conn );
// 								
								$sql->exec ($sql_query,$bind3);
							}
					
						$sql->get_row ();
						$TXT = $sql->row ['FIELD_TB_SHOW'];
					$TXT = preg_replace ( "!#(.*?)#!m", "<$1>", $TXT );

					if ($TXT!='')
						$tb_content = "<td class=sc4bis $css_style> $TXT &nbsp;</td>";
					else
						$tb_content = "";
	
						if(isset($xml_form->form['FIELD_TB_PLUS'])) {
	
						$where_plus=$xml_form->form['FIELD_TB_PLUS_WHERE'];
						$where_tb_field=preg_replace("/(.*)\[(.*?)\](.*)/",'$2',$where_plus);
	
						$sql_query_field="select $where_tb_field from {$xml_form->form['TABLE']} where {$this->config_service['PK_SERVICE']}='{$in[$this->config_service['PK_SERVICE']]}' and visitnum={$in['VISITNUM']} and visitnum_progr={$in['VISITNUM_PROGR']} and progr=$i";
						$sql_f = new query ( $conn );
						$sql_f->set_sql ( $sql_query_field );
						$sql_f->exec ();
							$sql_f->get_row ();
						$where_original_cond=$sql_f->row[$where_tb_field];
	
							$where_plus=str_replace("[$where_tb_field]","'".$where_original_cond."'",$where_plus);
	
						$field_plus=str_replace("|",",",$xml_form->form['FIELD_TB_PLUS']);
						$sql_query = "select $field_plus from {$xml_form->form['FIELD_TB_PLUS_VIEW']} where $where_plus";
						$sql = new query ( $conn );
						$sql->set_sql ( $sql_query );
						$sql->exec ();
						$sql->get_row ();
						$td_plus="";
							foreach($sql->row as $key => $val) {
						$td_plus.="<td class=sc4bis $css_style>$val</td>";
							}
						}
	
					$add_txt='';
						if(!$exclude_visit) {
					if ($this->integrazione->eq_enabled && $this->integrazione->eq_int!='' && $sql_abil->row['EQ_ACTION']=='2') {
						$add_txt="<img src=\"images/iphone_delete_icon.png\">";
				}
						if ($this->integrazione->eq_enabled && $this->integrazione->eq_int!='' && $sql_abil->row['EQ_ACTION']=='1') {
						$add_txt="<img src=\"images/plus-icon.png\" width=15px>";
						}
						if ($this->integrazione->eq_enabled && $this->integrazione->eq_int!='' && count($eqValues[$i])>o) {
						$add_txt="<img src=\"images/eq_img.png\" width=15px>";
						}

						/*if( $this->session_vars['WFact']!=$this->config_service['eQuerySpec']['Integrazione']['ROLE'][$this->config_service['service']]){
						$add_txt="";
					}*/
						}
					$body .= "
							<td class=sc4bis $css_style><b>$add_txt $counter</b></td>
							$tb_content
							$td_plus
							";
							$progr = $in ['PROGR'];
							//if (($xml_form->closed_form ( $progr ) || $this->session_vars ['USER_TIP'] != 'DE') && !($this->integrazione->eq_enabled && $this->integrazione->role==$this->user->profilo)) {
							//	$this_closed = true;
							//} else
							//	$this_closed = false;

							$progr = $in ['PROGR'];
							if (! $xml_form->closed_form ( $progr ) || ($this->integrazione->eq_enabled && $this->integrazione->role==$this->user->profilo && !$exclude_visit)) {
//							se questo if lo mettiamo dentro al prossimo if e anche dentro al prossimo else valorizza le var anche alla progr = 1
							//modifica edo e giorgio per far valorizzare la $in anche alla prima progressiva dell'all_in_form_view
							if (isset ( $type_fields_agg )) {
								foreach ( $type_fields_agg as $key => $val ) {
									$var = $val ['VAR'];
									$field_type = "field_{$val['TYPE']}";
									if ($this->config_service['field_lib'] != '' && file_exists ( $this->config_service['field_lib'] . $field_type . ".inc" )) {
										include_once $this->config_service['field_lib'] . $field_type . ".inc";
									} else {
										include_once "{$field_type}.inc";
									}
									//include_once "libs/$field_type.inc";
									$field_obj = new $field_type ( $xml_form, $xml_form->vars [$var], $xml_form->conn, $xml_form->tb_vals, $xml_form->session_vars, $xml_form->service, $xml_form->errors );
							$ret = $field_obj->all_in ( $var, $i, $sql->row, $this_close );

							if ($sql_abil->row['EQ_ACTION']=='') $ret = $field_obj->all_in ( $var, $i, $sql->row, $this_close );
							if ($sql_abil->row['EQ_ACTION']=='2') $ret = $field_obj->all_in ( $var, $i, $sql->row, true );
									$body .= $ret ['body'];
									$c1_agg .= $ret ['c1_agg'];
									if ($ret['last_call_sfoglia']!=''){
										$last_call_sfoglia=$ret['last_call_sfoglia'];
									}
								}
							}

								$all_closed = false;
								if ($col_modifica)
								$col_modifica_td = "<td class=sc4bis align=center><a href=\"index.php?CENTER={$in['CENTER']}&{$this->config_service['PK_SERVICE']}={$in[$this->config_service['PK_SERVICE']]}&ESAM={$in['ESAM']}&VISITNUM={$in['VISITNUM']}&VISITNUM_PROGR={$in['VISITNUM_PROGR']}&PROGR={$i}\"><img src=\"images/pen.png\" border=0></a></td>";
								$body .= $col_modifica_td;

								if (! $xml_form->closed_form ( $progr ) || $this->integrazione->eq_enabled) {
								//							echo $this->vlist->esams [$in ['VISITNUM']] [$in ['ESAM']] ['TRASH']."<br>";
								if ($this->vlist->esams [$in ['VISITNUM']] [$in ['ESAM']] ['TRASH'] != '' &&
										(
										(($this->session_vars ['USER_TIP'] == 'DE' && $sql_abil->row['USERID']=='') ||
								$sql_abil->row['USERID']==$this->user->userid) ||
								($this->integrazione->eq_enabled && $this->integrazione->role==$this->user->profilo) || !$this->integrazione->eq_enabled)
								) {
									
									if ($sql_abil->row['EQ_ACTION']=='2')
									$body .= "
							<td class=sc4bis align=center>
							{$add_txt}Scheda eliminata
							</td>";
							else if($this->integrazione->stato!=2){
								if($this->integrazione->eq_enabled && $this->integrazione->role==$this->user->profilo && !$exclude_visit) $add_eq="&per_integrazione=true";
								else $add_eq="";
                            if($elimina_col)$body .= "
							<td class=sc4bis align=center><a onclick=\"if (!confirm('E\\' sicuro di voler eliminare la scheda: {$this->vlist->esams [$in ['VISITNUM']] [$in ['ESAM']] ['TESTO']}?')) return false;\" href=\"index.php?CENTER={$in['CENTER']}&{$this->config_service['PK_SERVICE']}={$in[$this->config_service['PK_SERVICE']]}&ESAM={$in['ESAM']}&VISITNUM={$in['VISITNUM']}&VISITNUM_PROGR={$in['VISITNUM_PROGR']}&PROGR={$i}&ELIMINA_LA_SCHEDA=yes{$add_eq}\">
								<img src=\"images/trash.png\" border=0>
							</a></td>";
							
						}
							else $body .= "<td class=sc4bis align=center>&nbsp;</td>";
								}
	
									//							else {
									//								$body .= "<td class=sc4bis align=center>&nbsp;</td>";
										//							}
									}
							} else {
									//modifica edo e giorgio per far valorizzare la $in anche alla prima progressiva dell'all_in_form_view
									if (isset ( $type_fields_agg )) {
								foreach ( $type_fields_agg as $key => $val ) {
								$var = $val ['VAR'];
								$field_type = "field_{$val['TYPE']}";
								include_once "libs/$field_type.inc";
								$field_obj = new $field_type ( $xml_form, $xml_form->vars [$var], $xml_form->conn, $xml_form->tb_vals, $xml_form->session_vars, $xml_form->service, $xml_form->errors );
								$ret = $field_obj->all_in ( $var, $i, $sql->row, $this_close );
	
								if ($sql_abil->row['EQ_ACTION']=='') $ret = $field_obj->all_in ( $var, $i, $sql->row, $this_close );
								if ($sql_abil->row['EQ_ACTION']=='2') $ret = $field_obj->all_in ( $var, $i, $sql->row, true );
								$body .= $ret ['body'];
								$c1_agg .= $ret ['c1_agg'];
								if ($ret['last_call_sfoglia']!=''){
								$last_call_sfoglia=$ret['last_call_sfoglia'];
								}
								}
								}
	
	
								if ($col_modifica)
								$col_modifica_td = "<td class=sc4bis align=center><a href=\"index.php?CENTER={$in['CENTER']}&{$this->config_service['PK_SERVICE']}={$in[$this->config_service['PK_SERVICE']]}&ESAM={$in['ESAM']}&VISITNUM={$in['VISITNUM']}&VISITNUM_PROGR={$in['VISITNUM_PROGR']}&PROGR={$i}\"><img src=\"images/lente.gif\" border=0></a></td>";
								$body .= "
								$col_modifica_td
						";
								//								if (! $closed_all)
								//								$body .= "<!--td class=sc4bis>&nbsp;</td-->";
							}
								if($this->vlist->esams [$in ['VISITNUM']] [$in ['ESAM']] ['TRASH'] != '' &&
                                $this->session_vars ['USER_TIP'] == 'DE' && ($sql_abil->row['USERID']=='' || $sql_abil->row['FINE']==1))
								$body .= "<td class=sc4bis>&nbsp;</td>";
							$body .= "</tr>";
				}
			}

			if ($max == 0)
			$next = 1;
			if (isset ( $xml_form->form ['FIELD_AGG'] ) && ($this->session_vars ['USER_TIP'] == 'DE' || $this->integrazione->eq_enabled)) {
				if (isset ( $_GET ['CALL_Sfoglia'] ) && $last_call_sfoglia != '')
				$body .= "
							<script>
							apri_window('/$last_call_sfoglia');
							</script>";
				if (isset ( $_GET ['JUST_DELETE'] ) )
				$body .= "
							<script>
							document.forms['ALL_IN_FORMS'].submit();
							</script>";
					if (! $all_closed &&  $this->integrazione->stato!=2 || $exclude_visit ) {
				$body .= "
							<tr>
								<td colspan=$colspan align=center>
								<font color=red><b>Attenzione &egrave; necessario applicare le modifiche con il pulsante apposito</b></font><br>
									<input type='hidden' name='ApplMod' value='Salva le modifiche'>
									<input type='submit' name='ApplMod_button' value='Applica Modifiche' onclick=\"
										f=document.forms[0];
										el=f.elements;
										specifiche='A=ON&L=0&F=0';
								  		c1='';
								  		$c1_agg;
										rc=contr(c1,specifiche);
								  		if (rc) return false;
									\">
								</td>
							</tr>";
			}
				}
			$add_progr = $this->vlist->esams [$_GET ['VISITNUM']] [$_GET ['ESAM']] ['ADD_PROGR'];
			if (! isset ( $this->config_service ['Aggiungi_nuova_scheda'] )) {
				$this->config_service ['Aggiungi_nuova_scheda'] = 'Aggiungi nuova scheda';
			}
			$where_agg_eq='';
			if ($this->config_service['eQuerySpec']['Integrazione']['ON'] && (!$this->integrazione->eq_enabled || $this->integrazione->eq_int=='')) $where_agg_eq="and (INV_QUERY is null or EQ_ACTION=2)";
			$sql_visitclose = "select min(visitclose) as closed
			from {$service}_coordinate where visitnum={$_GET['VISITNUM']}
			and {$this->config_service['PK_SERVICE']}={$in[$this->config_service['PK_SERVICE']]}
			$where_agg_eq
			";

			$sql_c = new query ( $this->conn );
			$sql_c->get_row ( $sql_visitclose );
			if ($sql_c->row ['CLOSED'] == 1)
			$visit_closed = true;
			else
			$visit_closed = false;
			
			if (
			(
			(!$visit_closed && $in ['USER_TIP'] == 'DE')
			|| ($this->integrazione->eq_enabled  && $this->integrazione->stato!=2 && $this->integrazione->role==$this->user->profilo && !$exclude_visit)
			)
				&& $add_progr != 'no' && $this->vlist->esams [$_GET ['VISITNUM']] [$_GET ['ESAM']] ['NEXT_ENABLED'] != 'no') {
				if (isset ( $this->vlist->esams [$_GET ['VISITNUM']] [$_GET ['ESAM']] ['ADD_BLANK'] )) {
					//echo "<li>{$_SERVER['REQUEST_URI']}&ADDBLANK=$next</li>";
					$button = "<input type=\"button\"
								onclick=\"window.location.href='{$_SERVER['REQUEST_URI']}&ADDBLANK=$next'\"
							value=\"{$this->config_service['Aggiungi_nuova_scheda']}\">";
				} else
				$button = "<input type=\"button\" onclick=\"window.location.href='index.php?CENTER={$in['CENTER']}&{$this->config_service['PK_SERVICE']}={$in[$this->config_service['PK_SERVICE']]}&ESAM={$in['ESAM']}&VISITNUM={$in['VISITNUM']}&VISITNUM_PROGR={$in['VISITNUM_PROGR']}&PROGR={$next}'\" value=\"{$this->config_service['Aggiungi_nuova_scheda']}\">";
				$body .= "
						<tr>
							<td colspan=$colspan align=center>
							$button
							</td>
						</tr>";
			}

			if (isset ( $this->config_service ['Note'] [$_GET ['VISITNUM']] [$_GET ['ESAM']] )) {
				$body .= "<tr><td colspan=$colspan align=center style=\"color:red\">{$this->config_service['Note'][$_GET['VISITNUM']][$_GET['ESAM']]}</td></tr>";
			}
			$body .= "</table></form>";
			$body .= "<br><br><a href=\"index.php?VISITNUM={$_GET['VISITNUM']}&CENTER={$in['CENTER']}&{$this->config_service['PK_SERVICE']}={$in[$this->config_service['PK_SERVICE']]}&exams=visite_exams.xml\">&lt;&lt; {$this->config_service ['Torna_lista_schede']}</a>";
		}
		$ret ['body'] = $body;
		return $ret;
	}
	 
	
	/**
	 * Genera il codice HTML della scheda
	 *
	 * @param String $xml
	 * @param boolean $col_modifica
	 * @param boolean $no_link_back
	 */
	function form($xml, $col_modifica = true, $no_link_back=false) {
		$this->session_vars ['form'] = $xml;
		$vlist = $this->vlist;
		$in = $this->session_vars;
		$conn = $this->conn;
		$service = $this->service;
		$xml_form = new xml_form ( $this->conn, $this->service, $this->config_service, $this->session_vars, $this->uploaded_file_dir );

		$xml_form->xml_form_by_file ( $this->xml_dir . '/' . $xml );

		if (! $xml_form->allinea_db ()) {
			$body .= "<p align=center>";
			$body = $xml_form->body;
			$body .= "<form method=post align=center>";

			foreach ( $in as $key => $val )
			$body .= "<input type=\"hidden\" name=\"$key\" value=\"$val\">";
			$body .= "<input type=\"submit\" name=\"CREATE\" value=\"Update DB\"></form></p>";
		} else {

			if ($vlist->esams [$in ['VISITNUM']] [$in ['ESAM']] ['ALL_IN'] != '' && !isset($in['PROGR']) ) {
				$ret = $this->all_in_form_view ( $xml_form );
				$body .= $ret ['body'];
			} else {

				if (isset ( $this->vlist->esams [$_GET ['VISITNUM']] [$_GET ['ESAM']] ['VIEWABLE_ON_CLOSE'] ) && $this->vlist->esams [$_GET ['VISITNUM']] [$_GET ['ESAM']] ['VIEWABLE_ON_CLOSE'] != '') {

					if ($_GET ['VISITNUM_PROGR'] == '')
					$_GET ['VISITNUM_PROGR'] = 0;
					$sql_query = "
								select
									fine,
									userid
								from {$service}_coordinate
								where visitnum={$_GET['VISITNUM']}
								and visitnum_progr={$_GET['VISITNUM_PROGR']}
								and esam={$_GET['ESAM']}
								and progr={$_GET ['PROGR']}
								and {$this->config_service['PK_SERVICE']}={$this->pk_service}
								";
					$sql_abil = new query ( $this->conn );
					$sql_abil->get_row ( $sql_query );
					if ($sql_abil->row ['FINE'] != 1 && $sql_abil->row ['USERID'] != $this->user->userid) {
						error_page ( $this->user->userid, $this->testo ( "userNotCenter" ), "" );
					}
				}

				$xml_form->make_html ($no_link_back);

				if ($this->pk_service != '' && $this->pk_service != 'next') {
					$this->make_patient_table ();
					$body = $this->patient_table;
					$body .= "<br><br>" . $this->tb_riassuntiva ();
				} else
				$body = '';

				$body .= $xml_form->body;

				$script = "
				<script type=\"text/javascript\">
				" . $xml_form->salva_js . "
				" . $xml_form->invia_js . "
				" . $xml_form->check_js . "
				" . $xml_form->inrevisione_js . "
				</script>
				" . $xml_form -> script_js . "
				";
				$onload .= $xml_form->onload . ";";

			}
			if ($this->config_service ['lang'] == "en") {
				$link_equery = "Send eQuery on this form";
			} else {
				$link_equery = "Invia eQuery su questa scheda";
			}
			if ($xml_form->closed && $this->config_service ['equery'] == 'yes') {
				//modifica G.Tufano 05/07/2010
				//controllo se sono in un sottostudio o no
				$profond = $this->xmr->depth;
				$lvl_up = "";
				//depth >0 sono in un sottostudio
				if($profond > 0){
					do{
						$lvl_up .= "../";
						$profond--;
					}
					while($profond > 0);
				}

				$body .= "
					<br>
					<p align=right>
						<a href=\"{$lvl_up}index.php?CENTER={$in['CENTER']}&{$this->config_service['PK_SERVICE']}={$in[$this->config_service['PK_SERVICE']]}&REGISTRY={$this->xmr->prefix}&ESAM={$in['ESAM']}&PROGR={$in['PROGR']}&VISITNUM={$in['VISITNUM']}&VISITNUM_PROGR={$in['VISITNUM_PROGR']}&eQuery&eform\">
						$link_equery
						</a>
					</p>
				";
			}
		}
		if ($xml_form->closed && $this->config_service['equery_objs']=='yes') {
			//global $config_service;
			$index="index.php";
			foreach ($this->equery_objs as $curr_equery_obj){
				$body .="<br>
					<p align=right>".$curr_equery_obj->link('nuovo')."</p>";
			}
		}
		$this->body = $this->audit_trail_form_body().$body;
		$this->onload = $onload;
		$this -> script = $script.$this->audit_trail_form_js();

	}

	/**
	 * Gestisce il salvataggio dei dati all'invio
	 *
	 * @param String $xml_form
	 * @param String $debug
	 */
	function invia_db_dm($xml_form, $debug = null) {
		global $filetxt;
		global $body;
		$filetxt = preg_replace ( "/<!--user_name-->/", "Loading...", $filetxt );
		//		print($body);
		$conn = $this->conn;
		$in = $this->session_vars;
		$service = $this->service;
		//		foreach ( $in as $key => $val )
		//		$in [$key] = ora_escape ( $in [$key] );
		$this->invia_form ( $xml_form, $in );
		if ($in ['ID_QUERY'] > 0) {
			$query = new query ( $this->conn );
			$sql_equery = "update " . $this->config_service['service_root']. "_equery set validata=1, val_userid=:userid, val_dt=sysdate, chiusa='1', chiusa_dt=sysdate where id=:id_query";
			unset($bindUpdate);
			$bindUpdate['USERID']=$in ['remote_userid'];
			$bindUpdate['ID_QUERY']=$in ['ID_QUERY'];
			$query->ins_upd ($sql_equery,$bindUpdate);//binded
		}

		//controllo se sono in un sottostudio o no
		$profond = $this->xmr->depth;
		$lvl_up = "";
		//depth >0 sono in un sottostudio
		if($profond > 0){
			do{
				$lvl_up .= "../";
				$profond--;
			}
			while($profond > 0);
		}

		if ($in ['ID_QUERY'] > 0) {
			$link = "{$lvl_up}index.php?eQuery";
		} else {
			$link = "{$lvl_up}index.php?exams=visite_exams.xml&{$this->config_service['PK_SERVICE']}={$in[$this->config_service['PK_SERVICE']]}&CENTER={$in['CENTER']}&VISITNUM={$in['VISITNUM']}";
		}
		if (isset ( $in ['ajax_call'] )) {
			die ( "link_to:" . $link );
		} else {
			$this->check_visit_closure ();
			if (! ($debug == 1))
			$filetxt = preg_replace ( "/<!--meta refresh-->/", "<meta http-equiv=\"refresh\" content=\"1;url=$link\">", $filetxt );
		}

		$this->conn->commit ();
		$in ['invia'] = '';
		$in ['INVIOCO'] = '';
		$in ['ESAM'] = '';
		$form = '';
		$in ['form'] = '';
		if ($debug != 1)
		$filetxt = preg_replace ( "/<!--meta refresh-->/", "<meta http-equiv=\"refresh\" content=\"1;url=$link\">", $filetxt );
		$script = "";
		$onload = '';
		$body = ' &nbsp; SAVING...';
	}

	/**
	 * Gestisce il salvataggio dei dati al salvataggio della scheda
	 *
	 * @param String $xml_form
	 * @param String $debug
	 * @return String
	 */
	function salva_db($xml_form, $debug = null, $force_save=false) {
		$conn = $this->conn;
		$filetxt = $this->config_service ['filetxt'];
		$filetxt = preg_replace ( "/<!--user_name-->/", "Loading...", $filetxt );
		$in = $this->session_vars;
		$service = $this->service;
		$query = new query ( $conn );
		if ($xml_form->closed_form () && !$force_save){
			/*$debug_values.="SALVA DB LINEA 2594";
			foreach($in as $key=>$val) {
				$debug_values.="\n- Nome variabile: ".$key." -> Valore variabile: ".$val;
			}
			foreach($xml_form as $key=>$val) {
				$debug_values.="\n- Nome variabile: ".$key." -> Valore variabile: ".$val;
			}*/
			$txt_error=$this->testo ( "schedaInviata" );
			error_page ( $in ['remote_userid'], $txt_error , "" );
		}
		
		$this->salva_form ( $xml_form, $in ,$force_save);
		$new_xml_form = new xml_form ( );
		foreach ( $old_in as $key => $val )
		$in [$key] = $val;
		$in ['invia'] = '';
		$in ['INVIOCO'] = '';
		$form = '';
		$in ['form'] = '';
		$link = $xml_form->form ['LINK_TO'];
		if ($link == '')
			$link = "index.php";
		else {
			$link = str_replace ( "|and|", "&", $link );
			//$link = preg_replace ( "/\[(.*?)\]/e", "var_glob('\\1')", $link );
			$link = preg_replace_callback ( "/\[(.*?)\]/", function($matches){return var_glob($matches[1]);}, $link );
		}
		$insert_errors = $this->errors;
		if (count ( $insert_errors ) > 0)
		return false;
		if (isset ( $in ['ajax'] ))
		die ( "link_to:" . $link );
		else
		$filetxt = preg_replace ( "/<!--meta refresh-->/", "<meta http-equiv=\"refresh\" content=\"1;url=$link\">", $filetxt );
		global $link_to;
		$link_to = $link;
		$conn->commit ();
		$this->body = ' &nbsp; Saving...';
		$filetxt = preg_replace ( "/<!--body-->/", $this->body, $filetxt );
		die ( $filetxt );
	}

	/**
	 * Salva i dati in DB (gestione salva)
	 *
	 * @param String $xml_form
	 * @param array $in_s
	 */
	function salva_form($xml_form, $in_s, $forceSave=false) {
		$conn = $this->conn;
		$in = $this->session_vars;
		$in = $in_s;
		$debug = 1;
        $this->audit_trail($xml_form);
		$query = new query ( $conn );
		$xml_form->query_builder ($forceSave);
		$this->errors = $xml_form->getErrors ();
		//		global $config_service;
		$f_to_call = $xml_form->form ['F_TO_CALL'];
		if (function_exists ( $f_to_call ))
		$f_to_call ( $xml_form );
		for($i = 0; $i < count ( $xml_form->query_enable ); $i ++) {
			$query->set_sql ( $xml_form->query_enable [$i] );
			$query->ins_upd ();//non richiede binding
		}
		foreach ( $in as $key => $val ) {
			$old_in [$key] = $val;
			if (preg_match ( "/TB_COLL/", $key )) {
				$numero_record = preg_replace ( "/TB_COLL_/", "", $key );
				$numero_record = preg_replace ( "/(.*?)_(.*)/", "$1", $numero_record );
				if (! isset ( $forms_coll [$numero_record] ))
				$forms_coll [$numero_record] = true;
			}

		}
	}

	/**
	 * Salva i dati in DB (gestione invio)
	 */
	function invia_db($xml_form, $debug = null) {
		$conn = $this->conn;
		$filetxt = $this->config_service ['filetxt'];
		$in = $this->session_vars;
		$service = $this->service;
		$query = new query ( $conn );
		if ($xml_form->closed_form ())
		error_page ( $in ['remote_userid'], $this->testo ( "schedaInviata" ), "" );

		$this->invia_form ( $xml_form, $in );
		$new_xml_form = new xml_form ( );
		foreach ( $old_in as $key => $val )
		$in [$key] = $val;
		$in ['invia'] = '';
		$in ['INVIOCO'] = '';
		$form = '';
		$in ['form'] = '';
		$link = $xml_form->form ['LINK_TO'];
		if ($link == '')
		$link = "index.php";
		else {
			$link = str_replace ( "|and|", "&", $link );
			//$link = preg_replace ( "/\[(.*?)\]/e", "var_glob('\\1')", $link );
			$link = preg_replace_callback ( "/\[(.*?)\]/", function($matches){return var_glob($matches[1]);}, $link );
		}

		if (count ( $this->errors ) > 0)
		return false;
		if (isset ( $in ['ajax_call'] ))
		die ( "link_to:" . $link );
		else {
			$this->check_enable_visit ();
			if (! ($debug == 1))
			$filetxt = preg_replace ( "/<!--meta refresh-->/", "<meta http-equiv=\"refresh\" content=\"1;url=$link\">", $filetxt );
		}
		global $link_to;
		$link_to = $link;
		$conn->commit ();
		$this->body = ' &nbsp; Sending...';
		$filetxt = preg_replace ( "/<!--body-->/", $this->body, $filetxt );
		die ( $filetxt );
	}

	/**
	 * Operazioni da effettuare al cambio di stato
	 *
	 * @param number $dest
	 */
	function StatusChangePostOperation($dest) {
		return;
	}

	/**
	 * Gestisce le operazioni da effettuare all'"invio" della form
	 *
	 * @param String $xml_form_file
	 * @param String $ajax_call
	 */
	function SendForm($xml_form_file, $ajax_call = false) {

		$xml_form = new xml_form ( $this->conn, $this->service, $this->config_service, $this->session_vars, $this->uploaded_file_dir );
		$xml_form->xml_form_by_file ( $this->xml_dir . '/' . $xml_form_file );
		$this->session_vars ['INVIOCO'] = '1';
		$validata = false;
		$validata = $xml_form->valida ();
		if ($validata) {
			//echo "sono qui";
			if ($this->invia_db ( $xml_form )) {

				$filetxt = preg_replace ( "/<!--body-->/", $body, $filetxt );
				if ($this->session_vars ['ajax_call'] != '')
				die ( "link_to:$link_to" );
				echo $filetxt;
				die ();
			} else {
				if ($this->session_vars ['ajax_call'] != '') {
					echo "Error:";
					foreach ( $xml_form->errors as $key => $val ) {
						die ( $key . "#error#" . $val );
					}
				}
			}
		} else {
			if ($this->session_vars ['ajax_call'] != '') {
				echo "Error:";
				foreach ( $xml_form->errors as $key => $val ) {
					die ( $key . "#error#" . $val );
				}
			}

			else
			foreach ( $xml_form->errors as $key => $val ) {
				die ( $key . "#error#" . $val );
			}
		}
	}

	/**
	 * Gestisce le operazioni da effettuare al'"salva" della form
	 *
	 *
	 *
	 */
	function SaveForm($xml_form_file, $ajax_call = false, $forceSave=false) {
		$xml_form = new xml_form ( $this->conn, $this->service, $this->config_service, $this->session_vars, $this->uploaded_file_dir );
		$xml_form->xml_form_by_file ( $this->xml_dir . '/' . $xml_form_file );
		$this->session_vars ['INVIOCO'] = '1';
		$validata = false;
		$validata = $xml_form->valida ();
		if ($validata) {
			if ($this->salva_db ( $xml_form,null,$forceSave )) {
				$filetxt = preg_replace ( "/<!--body-->/", $body, $filetxt );
				if ($this->session_vars ['ajax_call'] != '')
				die ( "link_to:$link_to" );
				echo $filetxt;
				die ();
			} else { //Questo else mi sembra completamente inutile
				if ($this->session_vars ['ajax_call'] != '') {
					echo "Error:";
					foreach ( $xml_form->errors as $key => $val ) {
						die ( $key . "#error#" . $val );
					}
				}
			}
		} else {
// 			
// 			
// 			
// 			
			if ($this->session_vars ['ajax_call'] != '') {
			foreach ( $xml_form->errors as $key => $val ) 	die ( "Error:".$key . "#error#" . $val );
			}
			//print_r ( $this->errors );
		}
	}

	/**
	 * Effettua il salvataggio in DB (gestione invio)
	 */
	function invia_form($xml_form, $in_s) {
		$conn = $this->conn;
		$in = $this->in;
		//		global $config_service;
		$in = $in_s;
		$debug = 1;
        $this->audit_trail($xml_form);
		$query = new query ( $conn );

		$xml_form->query_builder ();
		$this->errors = $xml_form->getErrors ();
		//		global $config_service;
		$f_to_call = $xml_form->form ['F_TO_CALL'];

		if (function_exists ( $f_to_call ))
		$f_to_call ( $xml_form );

		for($i = 0; $i < count ( $xml_form->query_enable ); $i ++) {
			$query->set_sql ( $xml_form->query_enable [$i] );
			$query->ins_upd ();//non richiede binding
		}

	}

	/**
	 * Controlla la chiusura delle visite (obsoleta)
	 *
	 */
	function check_visit_closure() {
		$this->check_enable_visit ();
	}

	/**
	 * Controlla l'abilitazione delle visite
	 *
	 */
	function check_enable_visit() {
		if ($this->session_vars [$this->config_service ['PK_SERVICE']] == 'next')
		return;
		$conn = $this->conn;
		$filetxt = $this->config_service ['filetxt'];
		$in = $this->session_vars;
		$service = $this->service;
		$xml_dir = $this->xml_dir;
		$config_service = $this->config_service;
		foreach ( $this->vlist->esams [$in ['VISITNUM']] as $key => $val ) {
			if (isset ( $val ['MANDATORY'] ) && $val ['MANDATORY'] == 'yes')
			$mand_exams [$key] = "yes";
		}
		foreach ( $mand_exams as $key => $val ) {
			$exams .= "$key,";
		}
		$exams = rtrim ( $exams, "," );
		if ($exams != '') {
			$sql = "select min(nvl(fine,0)) as fine from {$service}_COORDINATE where {$config_service['PK_SERVICE']}=:pk_service and VISITNUM=:visitnum and esam in ($exams)";
			$query = new query ( $conn );
			unset($bind);
			$bind['PK_SERVICE']=$in[$config_service['PK_SERVICE']];
			$bind['VISITNUM']=$in['VISITNUM'];
						
			//$query->set_sql ( $sql );
			$query->exec ($sql,$bind);//binded
			$query->get_row ();
			$fine = $query->row ['FINE'];
			//echo "<li>$sql</li>";
			//echo $query->tb_res();
			if ($fine == 1) {
				foreach ( $this->vlist->enable_visit [$in ['VISITNUM']] as $key => $val ) {
					$number_visit = $val ['NUMBER'];
					$progr_visit = $val ['PROGR'];
					$abilita = false;
					//print_r($val);
					if ($val ['CONDITION_VALUE'] != '') {
						$condition_value = $val ['CONDITION_VALUE'];

						$condition_value = str_replace ( ",", "','", $condition_value );

						$condition_value = "'$condition_value'";

						$conditions = explode ( ".", $val ['CONDITION'] );
						//print_r($conditions);
						$condition_var = $conditions [1];
						$condition_table = $conditions [0];
						$sql_query = "
						select
							count(*) as conto
						from {$service}_{$condition_table}
						where
						{$config_service['PK_SERVICE']}=:pk_service
							and {$service}_{$condition_table}.{$condition_var} in ($condition_value)
							";
						unset($bind);
						$bind['PK_SERVICE']=$in[$config_service['PK_SERVICE']];
						
						$sql = new query ( $conn );
						//$sql->set_sql ( $sql_query );
						$sql->exec ($sql_query,$bind);//binded
						
						//echo "<li>$sql_query</li>";
						//echo $sql->tb_res();
						$sql->get_row ();
						if ($sql->row ['CONTO'] > 0)
						$abilita = true;
					} else {
						$abilita = true;
					}
					if ($abilita && ($val ['AUTO'] == 'yes' || (isset ( $in ['CLOSE_VISIT'] ) && $in ['CLOSE_VISIT'] == $in ['VISITNUM']))) {
						foreach ( $this->vlist->esams [$number_visit] as $key_e => $val_e ) {
							if ($val_e ['DEFAULT'] == "yes") {
								$sql_controllo = "
									select
										count(*) as conto
									from {$service}_coordinate where
									{$config_service['PK_SERVICE']}=:pk_service
									   and visitnum=:visitnum
									   and visitnum_progr=:visitnum_progr
									   and esam=:esam
									   and progr=1
								";
									unset($bind);
									$bind['PK_SERVICE']=$in[$config_service['PK_SERVICE']];
									$bind['VISITNUM']=$number_visit;
									$bind['VISITNUM_PROGR']=$progr_visit;
									$bind['ESAM']=$val_e['NUMBER'];
									$query = new query ( $conn );
									$query->set_sql ( $sql_controllo );
									$query->exec ($sql_controllo,$bind); //binded
									//echo "<li>$sql_controllo</li>";
									//echo $query->tb_res();
									$query->get_row ();
									if ($query->row ['CONTO'] == 0) {
										$sql_update = "
										insert into {$service}_coordinate
											(VISITNUM, VISITNUM_PROGR, ESAM, PROGR, {$config_service['PK_SERVICE']}, ABILITATO)
										values
											(:visitnum, :visitnum_progr, :esam, 1, :pk_service,1)
									";
//									echo "<li>$sql_update</li>";
										$query = new query ( $conn );
										$query->ins_upd ($sql_update,$bind);//binded
									}
							}
						}
					}
				}
				/*
				 $sql="select * from {$service}_COORDINATE where {$config_service['PK_SERVICE']}='{$in[$config_service['PK_SERVICE']]}'";
				 $query=new query($conn);
				 $query->set_sql($sql);
				 $query->exec();//commentata
				 echo $query->tb_res();
				 */
			}
		}
	}

	/**
	 * Restituisce il codice html della form in visualizzazione
	 *
	 * @param number $esam
	 * @param number $visitnum
	 * @param number $visitnum_progr
	 * @param number $progr
	 * @return String
	 */
	function printable_form($esam, $visitnum, $visitnum_progr, $progr, $footer_header=false) {
		$_GET ['ESAM'] = $this->session_vars ['ESAM'] = $esam;
		$_GET ['VISITNUM'] = $this->session_vars ['VISITNUM'] = $visitnum;
		$_GET ['VISITNUM_PROGR'] = $this->session_vars ['VISITNUM_PROGR'] = $visitnum_progr;
		$_GET ['PROGR'] = $this->session_vars ['PROGR'] = $progr;
		$form = $this->vlist->esams [$visitnum] [$esam] ['XML'];
		$xml_form = new xml_form ( $this->conn, $this->service, $this->config_service, $this->session_vars, $this->uploaded_file_dir );
		$xml_form->xml_form_by_file ( $this->xml_dir . '/' . $form );
		$xml_form->make_html ( true, true );
        if($footer_header){
            //$prepend= preg_replace ( "/\[(.*?)\]/e", "var_glob('\\1')", $xml_form->header );
			$prepend = preg_replace_callback ( "/\[(.*?)\]/", function($matches){return var_glob($matches[1]);}, $xml_form->header );
            //$append = preg_replace ( "/\[(.*?)\]/e", "var_glob('\\1')", $xml_form->footer );
			$append = preg_replace_callback ( "/\[(.*?)\]/", function($matches){return var_glob($matches[1]);}, $xml_form->footer );
        }
		unset ( $_GET ['ESAM'] );
		unset ( $_GET ['VISITNUM'] );
		unset ( $_GET ['VISITNUM_PROGR'] );
		unset ( $_GET ['PROGR'] );
		return $prepend.$xml_form->body.$append;
	}


	/**
	 * Genera il codice html di tutte le schede compilate in visualizzazione
	 *
	 * @param String $service
	 * @return String
	 */
	function view_all($service = null,$vlist=null) {
		if ($service == '')
		$service = $this->config_service ['service'];
		$sql_query = "select visitnum, esam, visitnum_progr, progr from {$service}_coordinate where fine=1 and {$this->config_service['PK_SERVICE']}=:pk_service order by progr asc";
		$sql = new query ( $this->conn );
		unset($bind_pk);
		$bind_pk['PK_SERVICE']=$this->pk_service;
		$sql->exec ( $sql_query ,$bind_pk);//binded
		while ( $sql->get_row () ) {
			$res [$sql->row ['VISITNUM']] [$sql->row ['VISITNUM_PROGR']] [$sql->row ['ESAM']] [$sql->row ['PROGR']] = true;
		}
		if(!isset($vlist))$vlist=$this->vlist;
		foreach ($vlist->visitnums as $visitnum => $visitnum_val){
			if (isset($res[$visitnum])){
				foreach ($res[$visitnum] as $visitnum_progr => $vprogr_val){
					foreach ($vlist->esams[$visitnum] as $esam => $es_val){
						if (isset($res[$visitnum][$visitnum_progr][$esam])){
							if (count($res[$visitnum][$visitnum_progr][$esam])>1) $multiple=true;
							else $multiple=false;
							foreach ($res[$visitnum][$visitnum_progr][$esam] as $progr => $progr_val){
								if ($multiple) $ret.="<li><b>Scheda n.ro $progr</b></li>";
								$ret.=$this->printable_form($esam, $visitnum, $visitnum_progr, $progr,$service,$vlist);
							}
						}
					}
				}
			}
		}
		return $ret;

	}
	
	/**
	* Genera il codice html di tutte le schede compilate in visualizzazione
	* COMPRESI I SOTTOSTUDI
	*
	* @param String $service
	* @return String
	*/
	function view_all_services($services){
		foreach ($services as $key => $val){
			if($val ==  $this->xmr_root->prefix){
				$vlist= new xml_esams_list ( $this->xml_dir .'/'. $this->visit_structure_xml,$config,$this->session_vars, $this->conn);
			}
			else{
				$vlist= new xml_esams_list ( $this->xml_dir . '/' .$val.'/'. $this->visit_structure_xml,$config,$this->session_vars, $this->conn);
			}
			$ret.=$this->view_all($val,$vlist);
		}
		return $ret;
	}

	function eCRF($pdf=false){
		$banner="../imgserv/bannerstudy.jpg";
		if (isset($this->config_service['banner'])) $banner=$this->config_service['banner'];
		
			$css="hypernet.css";
		if (isset($this->config_service['css'])) $css=$this->config_service['css'];
			$header="<page_header>
	        <img src=\"$banner\" width=\"1400\">
	        
	    </page_header>";
	    
			
    
    	$html="
			<style>
				".file_get_contents($css)."
			</style>
			
			
			";
			$service = $this->config_service ['service'];
			$marginTop="35mm";
			if (isset($this->config_service['marginTop'])) $marginTop=$this->config_service['marginTop']."mm";
			
			if (isset($this->config_service['marginTop'])) $marginTop=$this->config_service['marginTop']."mm";
				$sql_query = "select visitnum, esam, visitnum_progr, progr from {$service}_coordinate where fine=1 and {$this->config_service['PK_SERVICE']}={$this->pk_service} order by progr asc";
				$sql = new query ( $this->conn );
				$sql->exec ( $sql_query );
				while ( $sql->get_row () ) {
					$res [$sql->row ['VISITNUM']] [$sql->row ['VISITNUM_PROGR']] [$sql->row ['ESAM']] [$sql->row ['PROGR']] = true;
				}
				foreach ( $this->vlist->visitnums as $visitnum => $visitnum_val ) {
					
					if (isset ( $res [$visitnum] )) {
						$html.="<page backtop=\"35mm\" backbottom=\"10mm\">
						$header";
							$html.="<bookmark title=\"{$this->vlist->visitnums[$visitnum]['TEXT']}\" level=\"0\" ></bookmark>";
							//$html.=$header;
							$footer="
							    		<page_footer>
							        		<table style=\"width: 100%; border: solid 0px black;\">
									            <tr>
									                <td style=\"text-align: left;    width: 50%\">{$this->vlist->visitnums[$visitnum]['TEXT']}</td>
									                <td style=\"text-align: right;    width: 50%\">page [[page_cu]]/[[page_nb]]</td>
									            </tr>
									        </table>
									    </page_footer>
							    ";
							$html.=$footer;
						foreach ( $res [$visitnum] as $visitnum_progr => $vprogr_val ) {
							
							foreach ( $this->vlist->esams [$visitnum] as $esam => $es_val ) {
								
								if (isset ( $res [$visitnum] [$visitnum_progr] [$esam] )) {
									
									if (count ( $res [$visitnum] [$visitnum_progr] [$esam] ) > 1)
									$multiple = true;
									else
									$multiple = false;
									foreach ( $res [$visitnum] [$visitnum_progr] [$esam] as $progr => $progr_val ) {
										$nomeEsame=$this->vlist->esams[$visitnum][$esam]['TESTO'];
										$nomeEsame=rtrim($nomeEsame, "\n");
										$nomeEsame=rtrim($nomeEsame, "\r");
										
										$nomeEsame=rtrim($nomeEsame, "\s");
										$nomeEsame=ltrim($nomeEsame, "\n");
										
										if ($multiple)
										$html .= "<bookmark title=\"$nomeEsame $progr\" level=\"1\" ></bookmark>";
										else $html .= "<bookmark title=\"$nomeEsame\" level=\"1\" ></bookmark>";
										
										$form= $this->printable_form ( $esam, $visitnum, $visitnum_progr, $progr, $service );
										$form=str_replace('<table border=0 width=100%><tr><td align="center">', "", $form);
										$form=str_replace("<table style='width:100% ;' align=center ><tr><td><form method=\"post\">","",$form);
										$form=str_replace("class=\"sf\" align=\"center\" border=\"0\" cellpadding=\"2\"", "", $form);
										$form=str_replace("<link media='screen' href='giotto.css' rel='stylesheet' type='text/css' /></p></td></tr></table></form></td></tr></table>", "", $form);
										$html.="$form";
									}
								}
								
							}
							//$html.="</page>";
						}
						$html.="</page>";
								$last_visitnum=$visitnum;
					}
				}
				$html=str_replace("width=\"100%\"", "style=\"width: 100%\"", $html);
				$html=str_replace("</tr><td", "</tr><tr><td", $html);
				$html=str_replace("</tr> <td", "</tr><tr><td", $html);
				$html=str_replace("</tr></tr>", "</tr>", $html);
				$html=str_replace("/images", "images", $html);
				$html=str_replace("..images", "images", $html);
				
				$html=str_replace("</td>	</table>", "</td></tr></table>", $html);
				$html=str_replace("</td></table>", "</td></tr></table>", $html);
				$html=str_replace("width=\"50%\"", "style=\"width: 50%\"", $html);
				$html=str_replace("width=\"25%\"", "style=\"width: 25%\"", $html);
				
				if ($pdf){
	require_once('/http/lib/tcpdf/html2pdf.class.php');
    try
    {
        $html2pdf = new HTML2PDF('P', 'A2', 'it');
        //$html2pdf->setModeDebug();
        $html2pdf->setDefaultFont('times');
        $html2pdf->writeHTML($html, isset($_GET['vuehtml']));
        if (!is_dir("eCRFs")){
        	mkdir("eCRFs");
        	chmod("eCRFs", 2777);
        }
        $nomeFile="eCRFs/{$this->config_service['PK_SERVICE']}_{$this->pk_service}.pdf";
        $html2pdf->Output($nomeFile, "F");
        if (!isset($_GET['batchExec'])) {
        	header("location: $nomeFile");
        	die();
        }
        else die("OK");
    }
    catch(HTML2PDF_exception $e) {
        echo $e;
        exit;
    }
				}
				else 
			die($html);
		
	}
	
	/**
	 * Gestione equery
	 *
	 * @return String
	 */
	function Equery() {
		$in = $this->session_vars;
		$service = $this->service;
		$remote_userid = $in ['remote_userid'];
		//		if(isset($this->config_service['patients_list_substudy']) && $this->config_service['patients_list_substudy'] != ""){
		//			$destination_url="../index.php";
		//			$link_list="<a href=\"../index.php?=&list=patients_list.xml\">{$this->config_service['Patients_list']}</a>&gt;&gt;<b>{$this->config_service['patients_list_substudy']}</b>";
		//		}else{
		//			$destination_url="index.php";
			//			$link_list="<b>{$this->config_service['Patients_list']}</b>";
			//		}
		if (! isset ( $in ['eform'] )) {
			if (isset ( $in ['closed'] )) {
				$open = false;
				$sql_rec = "
				select e.ID,
					e.REGISTRY,
			       e.ESAM,
			       e.VISITNUM,
			       e.VISITNUM_PROGR,
			       e.PROGR,
			       e.{$this->config_service['PK_SERVICE']},
			       e.CENTER,
			       C.DENOM,
			       E.CHIUSA,
			       E.CHIUSA_DT,
			       E.TO_BE_VALIDATE,
			       E.VALIDATA,
			       E.VAL_DT,
			       E.QUEST_DT,
			       E.ANS_DT,
			       E.CHIUSA_DT
			  from {$this->xmr_root->prefix}_equery e, {$service}_utenti_centri uc, {$service}_centri c
			 where e.q_userid <> :userid
			   and e.chiusa=1
			   and c.center = e.center
			   and uc.center = c.center
			   and uc.userid = :userid
					order by e.ID";
				$sql_sent = "
				select e.ID,
			       e.ESAM,
			       e.VISITNUM,
			       e.VISITNUM_PROGR,
			       e.PROGR,
			       e.{$this->config_service['PK_SERVICE']},
			       e.CENTER,
			       C.DENOM,
			       E.CHIUSA,
			       E.CHIUSA_DT,
			       E.TO_BE_VALIDATE,
			       E.VALIDATA,
			       E.VAL_DT,
			       E.QUEST_DT,
			       E.ANS_DT,
			       E.CHIUSA_DT
			  from {$this->xmr_root->prefix}_equery e, {$service}_utenti_centri uc, {$service}_centri c
			 where e.q_userid = :userid
			   and e.chiusa=1
			   and c.center = e.center
			   and uc.center = c.center
			   and uc.userid = :userid
					order by e.ID";
				$html .= "
				<p align=center><b>" . $this->testo ( "closedEqL" ) . "</b></p>
					<p align=right><a href=\"index.php?eQuery\">" . $this->testo ( "openedEqS" ) . "</p>
				";
				unset($bind_userid);
				$bind_userid['USERID']=$in['remote_userid'];
			} else {
				$open = true;
				$sql_rec = "
				select e.ID,
				   e.REGISTRY,
			       e.ESAM,
			       e.VISITNUM,
			       e.VISITNUM_PROGR,
			       e.PROGR,
			       e.{$this->config_service['PK_SERVICE']},
			       e.CENTER,
			       C.DENOM,
			       E.CHIUSA,
			       E.CHIUSA_DT,
			       E.TO_BE_VALIDATE,
			       E.VALIDATA,
			       E.VAL_DT,
			       E.QUEST_DT,
			       E.ANS_DT
			  from {$this->xmr_root->prefix}_equery e, {$service}_utenti_centri uc, {$service}_centri c
			 where e.q_userid <> :userid
			   and e.chiusa is null
			   and c.center = e.center
			   and uc.center = c.center
			   and uc.userid = :userid
					order by e.ID";
				$sql_sent = "
				select e.ID,
				   e.REGISTRY,
			       e.ESAM,
			       e.VISITNUM,
			       e.VISITNUM_PROGR,
			       e.PROGR,
			       e.{$this->config_service['PK_SERVICE']},
			       e.CENTER,
			       C.DENOM,
			       E.CHIUSA,
			       E.CHIUSA_DT,
			       E.TO_BE_VALIDATE,
			       E.VALIDATA,
			       E.VAL_DT,
			       E.QUEST_DT,
			       E.ANS_DT
			  from {$this->xmr_root->prefix}_equery e, {$service}_utenti_centri uc, {$service}_centri c
			 where e.q_userid = :userid
			   and e.chiusa is null
			   and c.center = e.center
			   and uc.center = c.center
			   and uc.userid = :userid
					order by e.ID";
				$html .= "
				<p align=center><b>" . $this->testo ( "openedEq" ) . "</b></p>
					<p align=right><a href=\"index.php?eQuery&closed\">" . $this->testo ( "closedEq" ) . "</p>
				";
				unset($bind_userid);
				$bind_userid['USERID']=$in['remote_userid'];
			}
			
			//eQuery ricevute
			$sql = new query ( $this->conn );
			//$sql->set_sql ( $sql_rec );
			$sql->exec ($sql_rec,$bind_userid);//binded
			$rec_list = $this->eList ( $sql, $open );
			$sql = new query ( $this->conn );
			//$sql->set_sql ( $sql_sent );
			$sql->exec ($sql_sent,$bind_userid);//binded
			$sent_list = $this->eList ( $sql, $open );
			if (! preg_match ( "/^995/", $remote_userid ))
			$html .= "<br><a href=\"index.php?eQuery&eform\">" . $this->testo ( "newEq" ) . "</a><br><br>";
			$html .= "

				<table border=0 cellpadding=0 cellspacing=0 class=titolo align=center width=95%>
					<tr>
						<td class=\"int\">" . $this->testo ( "receivedEq" ) . "</td>
					</tr>
				</table>
				<br>
				$rec_list
				<br><br>
				<table border=0 cellpadding=0 cellspacing=0 class=titolo align=center width=95%>
					<tr>
						<td class=\"int\">" . $this->testo ( "sendedEq" ) . "</td>
					</tr>
				</table>
				<br>
				$sent_list
				<br><br>

				";
				if (! preg_match ( "/^995/", $remote_userid ))
				$html .= "<a href=\"index.php?eQuery&eform\">" . $this->testo ( "newEq" ) . "</a>";
		} else {
			if (! isset ( $in ['ID'] )) {
				$dati_equery = null;
			} else {
				$sql_dati_query = "select * from {$service}_equery where id=:eq_id";
				$sql = new query ( $this->conn );
				$sql->set_sql ( $sql_dati_query );
				unset($bind);
				$bind['EQ_ID']=$in['ID'];
				$sql->exec ($sql_dati_query,$bind);//binded
				$sql->get_row ();
				$dati_equery = $sql->row;
			}
			$html .= $this->eForm ( $dati_equery );
		}
		//Nuovo modo di generare il menu briciola di pane
		$percorso = $this->breadcrumb ( "equery" );
		return $percorso . $html;
	}

	/**
	 * Lista delle equery
	 *
	 * @param String $sql
	 * @param dbconn $open
	 * @return String
	 */
	function eList($sql, $open) {
		$in = $this->session_vars;
		$config_service = $this->config_service;
        if(!$this->config_service['eQueryXmlConfigurations']['SingleRegistry']){
            $th_registry="<th class=int>" . $this->testo ( "Registry" ) . "</th>";
            
        }
		if ($open)
		$html = "
			<table border=0 cellpadding=0 cellspacing=2 width=95% align=center>
				<tr>
					<th class=int>ID</th>
					{$th_registry}
					<th class=int>" . $this->testo ( "Center" ) . "</th>
					<th class=int>" . $this->testo ( "Visit" ) . "</th>
					<th class=int>" . $this->testo ( "Esam" ) . "</th>
					<th class=int>" . $this->testo ( "eQueryDate" ) . "</th>
					<th class=int>" . $this->testo ( "Dateofanswer" ) . "</th>
					<th class=int>" . $this->testo ( "Modify" ) . "</th>
				</tr>
		";
		if (! $open) {
			$html = "
			<table border=0 cellpadding=0 cellspacing=2 width=95% align=center>
				<tr>
					<th class=int>ID</th>
					{$th_registry}
					<th class=int>" . $this->testo ( "Center" ) . "</th>
					<th class=int>" . $this->testo ( "Visit" ) . "</th>
					<th class=int>" . $this->testo ( "Esam" ) . "</th>
					<th class=int>" . $this->testo ( "eQueryDate" ) . "</th>
					<th class=int>" . $this->testo ( "Dateofanswer" ) . "</th>
					<th class=int>" . $this->testo ( "closeDate" ) . "</th>
					<th class=int>" . $this->testo ( "Modify" ) . "</th>
				</tr>
		";
		}

		//modifica G.Tufano 01/07/2010
		//per correggere l'eList che non distingue i sottostudi,
		//creo tanti $vlists ad-hoc

		//inoltre per migliorare la tabella inserisco il campo DESCR
		//nella colonna "Registro"

		foreach ($this->xmr->substudies as $substd){
			$vlists[$substd->prefix] = new xml_esams_list ( $this->xml_dir . '/' .$substd->prefix.'/'. $this->visit_structure_xml,$config,$this->session_vars, $this->conn);
			$descrs[$substd->prefix] = $substd->workflow['DESCR'];
			$dirs[$substd->prefix] = $substd->prefix."/";
		}

		$vlists[$this->service]=$this->vlist;
		$descrs[$this->service] = $this->xmr->workflow['DESCR'];
		$dirs[$this->service] = "";

		while ( $sql->get_row () ) {
		    if(!$this->config_service['eQueryXmlConfigurations']['SingleRegistry']){
                $td_registry="<td class=sc4bis align=center>{$descrs[$sql->row ['REGISTRY']]}</td>";
            }
			$visita = $vlists[$sql->row ['REGISTRY']]->visitnums [$sql->row ['VISITNUM']] ['TEXT'];
			$esame = $vlists[$sql->row ['REGISTRY']]->esams [$sql->row ['VISITNUM']] [$sql->row ['ESAM']] ['TESTO'];
			$link_ = "<a href=\"index.php?eQuery&eform&ID={$sql->row['ID']}\">{$sql->row['ID']}</a>";
			if ($sql->row ['TO_BE_VALIDATE'] == '1' && $in ['USER_TIP'] == 'DM' && $sql->row ['VAL_DT'] == '') {
				//percorso al file xml
				//	$subdir = '';
				$form = "&amp;form={$vlists[$sql->row ['REGISTRY']]->esams[$sql->row['VISITNUM']][$sql->row['ESAM']]['XML']}";
				
				$link_validazione = "
					<a href=\"{$dirs[$sql->row ['REGISTRY']]}index.php?CENTER={$sql->row['CENTER']}&amp;{$config_service['PK_SERVICE']}={$sql->row[$config_service['PK_SERVICE']]}&amp;ESAM={$sql->row['ESAM']}&amp;PROGR={$sql->row['PROGR']}&amp;VISITNUM={$sql->row['VISITNUM']}&amp;VISITNUM_PROGR={$sql->row['VISITNUM_PROGR']}{$form}\">" . $this->testo ( "ModifyForm" ) . "</a>
					";
			}
			if ($sql->row ['TO_BE_VALIDATE'] == '1' && $sql->row ['VAL_DT'] == '' && $in ['USER_TIP'] != 'DM') {
				$link_validazione = $this->testo ( "ChangeNecessary" );
			}
			if ($sql->row ['TO_BE_VALIDATE'] == '0') {
				$link_validazione = $this->testo ( "ChangeNotNecessary" );
				//				if($this->config_service['lang']=="en") {
				//					$link_validazione='Change is not necessary';
				//				} else {
				//					$link_validazione='Modifica non necessaria';
				//				}
			}
			if ($sql->row ['TO_BE_VALIDATE'] == '') {
				$link_validazione = '---';
			}
			if ($sql->row ['TO_BE_VALIDATE'] == '1' && $sql->row ['VAL_DT'] != '') {
				$link_validazione = $this->testo ( "ChangeMadeAt" ) . " " . $sql->row ['VAL_DT'];
				//				if($this->config_service['lang']=="en") {
				//					$link_validazione="Changes made to the {$sql->row['VAL_DT']}";
				//				} else {
				//					$link_validazione="Modifica effettuata il {$sql->row['VAL_DT']}";
				//				}
			}

			if ($open) {

				$html .= "
				<tr>
					<td class=sc4bis align=center>$link_</td>
					{$td_registry}
					<td class=sc4bis>{$sql->row['DENOM']}</td>
					<td class=sc4bis>$visita</td>
					<td class=sc4bis>$esame</td>
					<td class=sc4bis>{$sql->row['QUEST_DT']}</td>
					<td class=sc4bis>{$sql->row['ANS_DT']}</td>
					<td class=sc4bis align=center>$link_validazione</td>
				</tr>
					";
			} else
			$html .= "
				<tr>
					<td class=sc4bis align=center>$link_</td>
					{$td_registry}
					<td class=sc4bis>{$sql->row['DENOM']}</td>
					<td class=sc4bis>$visita</td>
					<td class=sc4bis>$esame</td>
					<td class=sc4bis>{$sql->row['QUEST_DT']}</td>
					<td class=sc4bis>{$sql->row['ANS_DT']}</td>
					<td class=sc4bis>{$sql->row['CHIUSA_DT']}</td>
					<td class=sc4bis align=center>$link_validazione</td>
				</tr>
					";
		}
		$html .= "</table>";

		return $html;
	}

	/**
	 * Form in modalità equery
	 *
	 * @param array $dati_equery
	 * @return String
	 */
	function eForm($dati_equery = null) {
		$in = $this->session_vars;
		$this->eRegistryList ();
		if (! isset ( $in ['ID'] ) || ($dati_equery ['ANSWER'] == '' && $dati_equery ['Q_USERID'] == $in ['remote_userid']))
		return $this->eFormStep1 ( $dati_equery );
		else {
			$first_step = $this->eFormStep1 ( $dati_equery );
			$second_step = $this->eFormStep2 ( $dati_equery );
			return $first_step . $second_step;
		}
	}

	/**
	 * Step 2 delle equery
	 *
	 * @param array $dati_equery
	 * @return String
	 */
	function eFormStep2($dati_equery) {
		$form = file_get_contents ( "equery_answer.htm" );
		$service = $this->service;
		$in = $this->session_vars;
		//echo "<hr>step2<hr>";
		//echo $in['USER_TIP']."<hr>";
		if (isset ( $in ['ANSWER'] ) && $in ['ANSWER'] != '') {
			$values ['A_USERID'] = $in ['remote_userid'];
			$values ['ANSWER'] = $in ['ANSWER'];
			$values ['ANS_DT'] = "sysdate";
			if (isset ( $in ['TO_BE_VALIDATE'] )) {
				if ($in ['TO_BE_VALIDATE'] == '0') {
					$values ['CHIUSA'] = '1';
					$values ['CHIUSA_DT'] = 'sysdate';
				}
				$values ['TO_BE_VALIDATE'] = $in ['TO_BE_VALIDATE'];
			}

			$pk ['ID'] = $in ['ID'];
			$table = $service . "_equery";
			$sql = new query ( $this->conn );
			$sql->update ( $values, $table, $pk );
			$this->conn->commit ();

			// Notifiche mail, nuova equery
			if ($this->notifica)
			$this->notifica_equery ( 2, $in ['ID'] );

			die ( "<html><head><meta http-equiv=\"refresh\" content=\"0;url=index.php?eQuery\"></head></html>" );
		}
		if (isset ( $in ['TO_BE_VALIDATE'] )) {
			if ($in ['TO_BE_VALIDATE'] == '0') {
				$values ['CHIUSA'] = '1';
				$values ['CHIUSA_DT'] = 'sysdate';
			}
			$values ['TO_BE_VALIDATE'] = $in ['TO_BE_VALIDATE'];
			$pk ['ID'] = $in ['ID'];
			$table = $service . "_equery";
			$sql = new query ( $this->conn );
			$sql->update ( $values, $table, $pk );
			$this->conn->commit ();
			die ( "<html><head><meta http-equiv=\"refresh\" content=\"0;url=index.php?eQuery\"></head></html>" );
		}
		if ($dati_equery ['ANSWER'] == '') {
			if ($in ['remote_userid'] != $dati_equery ['Q_USERID']) {
				$answer = "<textarea name=\"ANSWER\" cols=\"80\" ROWS=\"10\"></textarea>";
				if ($in ['USER_TIP'] == 'DM')
				$answer .= "
					</td>
				</tr>
				<tr>
					<td class=destra><b>" . $this->testo ( 'ModifyForm' ) . "</b></td>
					<td class=input>
						<input type='radio' name='TO_BE_VALIDATE' value='0'>" . $this->testo ( 'notNecessary' ) . "<br>
						<input type='radio' name='TO_BE_VALIDATE' value='1'>" . $this->testo ( 'necessary' ) . "

				";
				$form = str_replace ( "<!--answer-->", $answer, $form );
				$html .= "<form method=post action=\"index.php\">
				$form
				<p align=center>
						<input type='submit' value='" . $this->testo ( 'sendAnswer' ) . "'> &nbsp;
						<input type='reset' value='" . $this->testo ( 'cancel' ) . "'>
					</p>
				</form>	";

			} else
			error_page ( $in ['remote_userid'], $this->testo ( 'userNotCenter' ), $this->testo ( 'userNotCenter' ) );
		} else {

			if ($dati_equery ['TO_BE_VALIDATE'] == '') {
				if ($in ['USER_TIP'] == 'DM') {
					$answer = "<b>{$dati_equery['ANSWER']}</b>";
					$answer .= "
					</td>
				</tr>
				<tr>
					<td class=destra><b>Modify form:</b></td>
					<td class=input>
						<input type='radio' name='TO_BE_VALIDATE' value='0'>" . $this->testo ( 'notNecessary' ) . "<br>
						<input type='radio' name='TO_BE_VALIDATE' value='1'>" . $this->testo ( 'necessary' ) . "

				";
					$form = str_replace ( "<!--answer-->", $answer, $form );
					$html .= "
				<form method=post action=\"index.php\">
				$form
				<p align=center>
						<input type='submit' value='" . $this->testo ( 'sendAnswer' ) . "'> &nbsp;
						<input type='reset' value='" . $this->testo ( 'cancel' ) . "'>
					</p>
				</form>
				";
				} else {
					$form = str_replace ( "<!--answer-->", "<b>{$dati_equery['ANSWER']}</b>", $form );
					$html .= "
					$form
						";
				}
			} else {
				$answer = "<b>{$dati_equery['ANSWER']}</b>";
				$img_not_nec = $img_nec = "<img src=\"images/uncheckedradio.gif\">";
				if ($dati_equery ['TO_BE_VALIDATE'] == '0')
				$img_not_nec = "<img src=\"images/checkedradio.gif\">";
				if ($dati_equery ['TO_BE_VALIDATE'] == '1')
				$img_nec = "<img src=\"images/checkedradio.gif\">";
				$answer .= "
				</td>
				</tr>
				<tr>
					<td class=destra><b>" . $this->testo ( 'ModifyForm' ) . ":</b></td>
					<td class=input>
					$img_not_nec " . $this->testo ( 'notNecessary' ) . "<br>
					$img_nec " . $this->testo ( 'necessary' ) . "
				";
					$form = str_replace ( "<!--answer-->", $answer, $form );
					$html .= "
					$form
				";
			}
		}
		return $html;
	}

	/**
	 * Step 1 delle equery
	 *
	 * @param array $dati_equery
	 * @return String
	 */
	function eFormStep1($dati_equery = null) {
		$in = $this->session_vars;
		$config_service = $this->config_service;
		$xml_dir = $this->xml_dir;
		$service = $this->xmr->prefix;
		if (!is_null ( $dati_equery )) {
			/*parte per la visualizzazione del progressivo in visualizzazione delle equery /**Giorgio DELSIGNORE**/
			$sql_query="
					select
						distinct progr
					from {$service}_coordinate
					where
					{$config_service['PK_SERVICE']}=:pk_service
					and abilitato=1
					and visitnum=:visitnum
					and visitnum_progr=:visitnum_progr
					and esam=:esam
					";
					unset($bind);
					$bind['PK_SERVICE']=$dati_equery[$config_service['PK_SERVICE']];
					$bind['VISITNUM']=$dati_equery['VISITNUM'];
					$bind['VISITNUM_PROGR']=$dati_equery['VISITNUM_PROGR'];
					$bind['ESAM']=$dati_equery['ESAM'];
					$sql= new query($this->conn);
					//$sql->set_sql($sql_query);
					$sql->exec($sql_query,$bind);//binded

					//					print_R($in);
					if ($sql->numrows>1){

						$progressivo="
								<b>n. {$dati_equery['PROGR']}</b>
				";
					}
					$sql_query="
					select
						distinct visitnum_progr
					from {$service}_coordinate
					where
					{$config_service['PK_SERVICE']}=:pk_service
					and abilitato=1
					and visitnum=:visitnum
					and esam=:esam
					";
					unset($bind);
					$bind['PK_SERVICE']=$dati_equery[$config_service['PK_SERVICE']];
					$bind['VISITNUM']=$dati_equery['VISITNUM'];
					$bind['ESAM']=$dati_equery['ESAM'];
					$sql= new query($this->conn);
					//$sql->set_sql($sql_query);
					$sql->exec($sql_query,$bind);//binded

					//					print_R($in);
					if ($sql->numrows>1){
						$vprogr=$dati_equery['VISITNUM_PROGR']+1;
						$visit_progr="
								<b>n. {$vprogr}</b>
				";
					}
					/*fine parte per la visualizzazione del progressivo*/
					$sql_query = "
				select c.*
				from {$service}_centri c,
				{$service}_utenti_centri uc
				where
					uc.userid=:userid
					and uc.center=c.center
					and uc.center=:center
					";
				unset($bind);
				$bind['CENTER']=$dati_equery['CENTER'];
				$bind['USERID']=$in['remote_userid'];
				$sql = new query ( $this->conn );
				//$sql->set_sql ( $sql_query );
				$sql->exec ($sql_query,$bind);//binded
				$sql->get_row ();

				//NON COMMENTARE LA PARTE SEGUENTE: per problemi rivolgersi a Giorgio Delsignore o Lorenzo Manacorda (17/06/2010)
			 $prefix= $dati_equery ['REGISTRY'];
			 if($prefix==$this->xmr->prefix){
			 	$vlist=$this->vlist;
			 }
			 else{
				 $vlist= new xml_esams_list ( $this->xml_dir . '/' .$prefix.'/'. $this->visit_structure_xml,$config,$this->session_vars, $this->conn);
			 }

			 $centro = "<b>{$sql->row['DENOM']}</b><input type=\"hidden\" name=\"CENTER\" value=\"{$dati_equery['CENTER']}\">";
			 $paziente = "<b>{$dati_equery[$config_service['PK_SERVICE']]}</b><input type=\"hidden\" name=\"{$config_service['PK_SERVICE']}\" value=\"{$dati_equery[$config_service['PK_SERVICE']]}\">";
			 $visita = "<b>{$vlist->visitnums[$dati_equery['VISITNUM']]['TEXT']}</b><input type=\"hidden\" name=\"VISITNUM\" value=\"{$dati_equery['VISITNUM']}\">";
			 $visit_progr.= "<input type=\"hidden\" name=\"VISITNUM_PROGR\" value=\"{$dati_equery['VISITNUM_PROGR']}\">";
			 $esame = "<b>{$vlist->esams[$dati_equery['VISITNUM']][$dati_equery['ESAM']]['TESTO']}</b>
						<input type=\"hidden\" name=\"ESAM\" value=\"{$dati_equery['ESAM']}\">
						";
			 $progressivo.= "
						<input type=\"hidden\" name=\"PROGR\" value=\"{$dati_equery['PROGR']}\">
						";
			 $question = "<b>{$dati_equery['QUESTION']}</b>";
			 $form = file_get_contents ( "equery_question.htm" );
			 $form = str_replace ( "<!--centro-->", $centro, $form );
			 $form = str_replace ( "<!--paziente-->", $paziente, $form );
			 $form = str_replace ( "<!--registry-->", $this->eRegistryList (), $form );
			 $form = str_replace ( "<!--visita-->", $visita . $visit_progr, $form );
			 $form = str_replace ( "<!--esame-->", $esame . $progressivo, $form );
			 error_log("---- q " . $question . " visita" . $visita);
			 $form = str_replace ( "<!--question-->", $question, $form );
			 $html .= "
				<p class=titolo>eQuery n. {$in['ID']}</p>

				$form


			";
		} else {
			if (isset ( $in ['CENTER'] ) && $in ['CENTER'] != '' && isset ( $in [$config_service ['PK_SERVICE']] ) && $in [$config_service ['PK_SERVICE']] != '' && isset ( $in ['VISITNUM'] ) && $in ['VISITNUM'] != '' && isset ( $in ['VISITNUM_PROGR'] ) && $in ['VISITNUM_PROGR'] != '' && isset ( $in ['ESAM'] ) && $in ['ESAM'] != '' && isset ( $in ['PROGR'] ) && $in ['PROGR'] != '' && isset ( $in ['REGISTRY'] ) && $in ['REGISTRY'] != '' && isset ( $in ['SALVA_EQUERY'] ) && $in ['SALVA_EQUERY'] != '' && isset ( $in ['QUESTION'] ) && $in ['QUESTION'] != '') {

				$sql_query = "select max(ID) as maxid from {$this->config['service']}_equery";
				$sql = new query ( $this->conn );
				$sql->set_sql ( $sql_query );
				$sql->exec ();//non richiede binding
				$sql->get_row ();
				$maxid = $sql->row ['MAXID'] - 0;
				$maxid ++;
				$values ['ID'] = $maxid;
				$values ['QUEST_DT'] = "sysdate";
				$values ['Q_USERID'] = $in ['remote_userid'];
				$values ['CENTER'] = $in ['CENTER'];
				$values ['CODPAT'] = $in ['CODPAT'];
				$values ['VISITNUM'] = $in ['VISITNUM'];
				$values ['ESAM'] = $in ['ESAM'];
				$values ['PROGR'] = $in ['PROGR'];
				$values ['QUESTION'] = $in ['QUESTION'];
				$values ['VISITNUM_PROGR'] = $in ['VISITNUM_PROGR'];
				$values ['REGISTRY'] = $in ['REGISTRY'];

				$table = "{$this->config['service']}_equery";
				$pk ['ID'] = '';
				$sql = new query ( $this->conn );
				$sql->insert ( $values, $table, $pk, true );
				$this->conn->commit ();

				// Notifiche mail, nuova equery
				if ($this->notifica)
				$this->notifica_equery ( 1, $maxid );

				die ( "<html><head><meta http-equiv=\"refresh\" content=\"0;url=index.php?eQuery\"></head></html>" );
			}
			$sql_query = "select  wf.* from workflow wf where prefix='{$this->service}WF'";
			//			echo $sql_query;
			$sql_wf = new query ( $this->conn );
			$sql_wf->get_row ( $sql_query );
			$question = "<textarea name=\"QUESTION\" cols=\"80\" ROWS=\"10\"></textarea>";
			$form = file_get_contents ( "equery_question.htm" );
			$form = str_replace ( "<!--centro-->", $this->eCenterList (), $form );
			$form = str_replace ( "<!--study-->", "<input type=\"hidden\" value='{$sql_wf->row['ID']}'>", $form );
			$form = str_replace ( "<!--paziente-->", $this->ePatientList (), $form );
			$form = str_replace ( "<!--registry-->", $this->eRegistryList (), $form );
			$form = str_replace ( "<!--visita-->", $this->eVisitList (), $form );
			//error_log("---- visita " . $this->eVisitList() );
			$form = str_replace ( "<!--esame-->", $this->eEsamList (), $form );
			$form = str_replace ( "<!--question-->", $question, $form );
			if ($this->config_service ['lang'] == 'en') {
				$html .= "
				<p class=titolo>New eQuery</p>
				<form method=post action=\"index.php\">
				$form
				<p align=center>
						<input type='submit' name='SALVA_EQUERY' onclick=\"
							if (document.forms[0].CENTER.value=='') {
								alert('It\\'s necessary to select a centre');
								return false;
							}
							if (document.forms[0].{$config_service['PK_SERVICE']}.value=='') {
								alert('It\\'s necessary to select a patient');
								return false;
							}
							if (document.forms[0].VISITNUM.value=='') {
								alert('It\\'s necessary to select a visit');
								return false;
							}
							if (document.forms[0].ESAM.value=='') {
								alert('It\\'s necessary to select an exam');
								return false;
							}
							if (document.forms[0].QUESTION.value=='') {
								alert('Insert the question');
								return false;
							}
						\" value='Send eQuery'> &nbsp;
						<input type='reset' value='Cancel'>
					</p>
				</form>
			";
			} else {
				$html .= "
				<p class=titolo>Nuova eQuery</p>
				<form method=post action=\"index.php\">
				$form
				<p align=center>
						<input type='submit' name='SALVA_EQUERY' onclick=\"
							if (document.forms[0].CENTER.value=='') {
								alert('E\\' necessario selezionare un centro');
								return false;
							}
							if (document.forms[0].{$config_service['PK_SERVICE']}.value=='') {
								alert('E\\' necessario selezionare un paziente');
								return false;
							}
							if (document.forms[0].VISITNUM.value=='') {
								alert('E\\' necessario selezionare una visita');
								return false;
							}
							if (document.forms[0].ESAM.value=='') {
								alert('E\\' necessario selezionare un esame');
								return false;
							}
							if (document.forms[0].QUESTION.value=='') {
								alert('Inserire la domanda');
								return false;
							}
						\" value='Invia eQuery'> &nbsp;
						<input type='reset' value='Annulla'>
					</p>
				</form>
			";
			}
		}

		return $html;
	}

	/**
	 * Lista delle schede dell'oggetto di studio (equery)
	 *
	 * @return array
	 */
	function eEsamList() {
		$xml_dir = $this->xml_dir;
		$in = $this->session_vars;
		$config_service = $this->config_service;

		if (! isset ( $in [$config_service ['PK_SERVICE']] ) || $in [$config_service ['PK_SERVICE']] == '') {
			return "";
		}
		if (isset ( $in ['VISITNUM'] ) && $in ['VISITNUM'] != '') {
			/*$str="select prefix from workflow where id={$in['STUDY']}";
			 $sql_study=new query($this->conn);
			 $sql_study->get_row($str);
			 $prefix=substr($sql_study->row['PREFIX'],0,strlen($sql_study->row['PREFIX'])-2);

			 */
			//$vlist = $this->vlist;
			//NON COMMENTARE LA PARTE SEGUENTE: per problemi rivolgersi a Giorgio Delsignore o Giacomo Tufano (05/07/2010)
			$prefix=$in ['REGISTRY'];

			if($prefix == $this->xmr->prefix){
				$vlist=$this->vlist;
				$service = $this->service;
			}
			else{
				$vlist= new xml_esams_list ( $this->xml_dir . '/' .$prefix.'/'. $this->visit_structure_xml,$config,$this->session_vars, $this->conn);;
				$service = $in['REGISTRY'];
			}

			if ($service == '')
			$service = $this->service;
			//FINE PARTE DA NON COMMENTARE (05/07/2010)
			//Esame
			$sql_query = "
					select
						distinct esam
					from {$service}_coordinate
					where {$config_service['PK_SERVICE']}=:pk_service
					and abilitato=1
					and fine=1
					and visitnum=:visitnum
					and visitnum_progr=:visitnum_progr
					order by esam asc";
			$sql = new query ( $this->conn );
			//$sql->set_sql ( $sql_query );
			unset($bind);
			$bind['PK_SERVICE']=$in[$config_service['PK_SERVICE']];
			$bind['VISITNUM']=$in['VISITNUM'];
			$bind['VISITNUM_PROGR']=$in['VISITNUM_PROGR'];
			$sql->exec ($sql_query,$bind);//binded
			$options = "";

			if ($sql->numrows > 0) {
				while ( $sql->get_row () ) {
					if (isset ( $in ['ESAM'] ) && $in ['ESAM'] == $sql->row ['ESAM'])
					$selected = "selected";
					else
					$selected = '';
					$options .= "
						<option value=\"{$sql->row['ESAM']}\" $selected>{$vlist->esams[$in['VISITNUM']][$sql->row['ESAM']]['TESTO']}</option>";
				}
				$esame = "
					<select name=\"ESAM\" onchange=\"document.forms[0].submit();\">
						<option value=\"\"></option>
						$options
					</select>
				";
			} else {
				$sql->get_row ();
				$in ['ESAM'] = $sql->row ['ESAM'];
				$esame = "
						<b>{$vlist->esams[$in['VISITNUM']][$sql->row['ESAM']]['TESTO']}</b>
						<input type=\"hidden\" name=\"ESAM\" value=\"{$in['ESAM']}\">
						";
			}
		}

		if (isset ( $in ['VISITNUM'] ) && $in ['VISITNUM'] != '' && isset ( $in ['ESAM'] ) && $in ['ESAM'] != '') {
			$sql_query = "
					select
						distinct progr
					from {$service}_coordinate
					where
					{$config_service['PK_SERVICE']}=:pk_service
					and abilitato=1
					and visitnum=:visitnum
					and visitnum_progr=:visitnum_progr
					and esam=:esam
					order by progr asc";
					$sql = new query ( $this->conn );
					//$sql->set_sql ( $sql_query );
					unset($bind);
					$bind['PK_SERVICE']=$in[$config_service['PK_SERVICE']];
					$bind['VISITNUM']=$in['VISITNUM'];
					$bind['VISITNUM_PROGR']=$in['VISITNUM_PROGR'];
					$bind['ESAM']=$in['ESAM'];
					$sql->exec ($sql_query,$bind);//binded
					$options = "";
					//print_R($in);
					if ($sql->numrows > 1) {
						while ( $sql->get_row () ) {
							if (isset ( $in ['PROGR'] ) && $in ['PROGR'] == $sql->row ['PROGR'])
							$selected = "selected";
							else
							$selected = '';
							$options .= "
						<option value=\"{$sql->row['PROGR']}\" $selected>{$sql->row['PROGR']}</option>";
						}
						$progressivo = "
							</td>
						</tr>
						<tr>
							<td class=destra>
								<b>Esame n.ro</b>
							</td>
							<td class=input>
								<select name=\"PROGR\" onchange=\"document.forms[0].submit();\">
									<option value=\"\"></option>
									$options
								</select>
				";
					} else {
						$sql->get_row ();
						$in ['PROGR'] = $sql->row ['PROGR'];
						$progressivo = "
						<input type=\"hidden\" name=\"PROGR\" value=\"{$in['PROGR']}\">
						";
					}
		}
		return $esame . $progressivo;
	}

	/**
	 * Lista Visite (equery)
	 *
	 * @return String
	 */
	function eVisitList() {
		//		global $xml_dir;
		//		global $in;
		//		global $service;
		//		global $config_service;
		$xml_dir = $this->xml_dir;
		$in = $this->session_vars;
		$service = $this->service;
		$config_service = $this->config_service;
		if (! isset ( $in ['REGISTRY'] ) || $in ['REGISTRY'] == '' || $this->session_vars [$this->config_service ['PK_SERVICE']] == '') {
			return "";
		}
		//Visita
		if (isset ( $in ['REGISTRY'] ) && $in ['REGISTRY'] != '') {
			//NON COMMENTARE LA PARTE SEGUENTE: per problemi rivolgersi a Giorgio Delsignore o Lorenzo Manacorda (17/06/2010)
			$prefix=$in ['REGISTRY'];
			if($prefix==$this->xmr->prefix){
				$vlist=$this->vlist;
			}
			else{
				$vlist= new xml_esams_list ( $this->xml_dir . '/' .$prefix.'/'. $this->visit_structure_xml,$config,$this->session_vars, $this->conn);;
			}
			//FINE PARTE DA NON COMMENTARE (17/06/2010)
			//$vlist = $this->vlist;

			$sql_query = "
					select
						distinct visitnum
					from {$this->service}_coordinate
					where {$config_service['PK_SERVICE']}=:pk_service
					and abilitato=1
					and fine=1
					order by visitnum asc";
			unset($bind_pk);
			$bind_pk['PK_SERVICE']=$in[$config_service['PK_SERVICE']];
			$sql = new query ( $this->conn );
			//$sql->set_sql ( $sql_query );
			$sql->exec ($sql_query,$bind_pk);//binded
			$options = "";
			if ($sql->numrows > 0) {
				while ( $sql->get_row () ) {
					if (isset ( $in ['VISITNUM'] ) && $in ['VISITNUM'] == $sql->row ['VISITNUM'])
					$selected = "selected";
					else
					$selected = '';
					$options .= "
						<option value=\"{$sql->row['VISITNUM']}\" $selected>{$vlist->visitnums[$sql->row['VISITNUM']]['TEXT']}</option>";
				}
				$visita = "
					<select name=\"VISITNUM\" onchange=\"document.forms[0].submit();\">
						<option value=\"\"></option>
						$options
					</select>
				";
			} else {
				$sql->get_row ();
				$in ['VISITNUM'] = $sql->row ['VISITNUM'];
				$visita = "
						<b>{$vlist->visitnums[$sql->row['VISITNUM']]['TEXT']}</b>
						<input type=\"hidden\" name=\"VISITNUM\" value=\"{$in['VISITNUM']}\">
						";

			}
		}
		if (isset ( $in ['VISITNUM'] ) && $in ['VISITNUM'] != '') {
			//visita progressiva
			$sql_query = "
					select
						distinct visitnum_progr
					from {$service}_coordinate
					where {$config_service['PK_SERVICE']}=:pk_service
					and abilitato=1 and visitnum=:visitnum
					order by visitnum_progr asc";
			$sql = new query ( $this->conn );
			//$sql->set_sql ( $sql_query );
			unset($bind);
			$bind['PK_SERVICE']=$in[$config_service['PK_SERVICE']];
			$bind['VISITNUM']=$in['VISITNUM'];
			$sql->exec ($sql_query,$bind);//binded
			$options = "";
			if ($sql->numrows > 0) {
				while ( $sql->get_row () ) {
					if (isset ( $in ['VISITNUM_PROGR'] ) && $in ['VISITNUM_PROGR'] == $sql->row ['VISITNUM_PROGR'])
					$selected = "selected";
					else
					$selected = '';
					$n_visit = $sql->row ['VISITNUM_PROGR'] + 1;
					$options .= "
						<option value=\"{$sql->row['VISITNUM_PROGR']}\" $selected>{$n_visit}</option>";
				}
				$visit_progr = "
							</td>
						</tr>
						<tr>
							<td class=destra>
								<b>" . $this->testo ( "Visit" ) . " n.ro</b>
							</td>
							<td class=input>
								<select name=\"VISITNUM_PROGR\" onchange=\"document.forms[0].submit();\">
									<option value=\"\"></option>
									$options
								</select>
				";
			} else {
				$sql->get_row ();
				$in ['VISITNUM_PROGR'] = $sql->row ['VISITNUM_PROGR'];
				$visit_progr = "
						<input type=\"hidden\" name=\"VISITNUM_PROGR\" value=\"{$in['VISITNUM_PROGR']}\">
						";
			}
		}
		return $visita . $visit_progr;
	}

	/**
	 * Lista pazienti (equery)
	 *
	 * @return String
	 */
	function ePatientList() {
		//		global $xml_dir;
		//		global $in;
		//		global $service;
		//		global $config_service;
		$xml_dir = $this->xml_dir;
		$in = $this->session_vars;
		$service = $this->service;
		$config_service = $this->config_service;

		$in = $this->session_vars;

		if ($this->session_vars ['CENTER'] != '') {
			$reg_form = new xml_form ( $this->conn, $this->xmr_root->prefix );

			$reg_form->xml_form_by_file ( $xml_dir . "/" . $this->vlist_root->esams [0] [0] ['XML'] );
			$table_ana = $reg_form->form ['TABLE'];

			$sql_query = "
					select
						a.{$config_service['PK_SERVICE']}
					from $table_ana a , {$this->service}_coordinate coor
					where a.center=:center and a.{$config_service['PK_SERVICE']}=coor.{$config_service['PK_SERVICE']} and coor.esam=0
					order by {$config_service['PK_SERVICE']} asc";
			unset($bind_center);
			$bind_center['CENTER']=$in['CENTER'];
			$sql = new query ( $this->conn );
			$sql->exec ($sql_query,$bind_center);//binded

			$options = '';
			if ($sql->numrows >= 1) {
				while ( $sql->get_row () ) {
					//					print_r($sql->row);
					if (isset ( $in [$config_service ['PK_SERVICE']] ) && $in [$config_service ['PK_SERVICE']] == $sql->row [$config_service ['PK_SERVICE']])
					$selected = "selected";
					else
					$selected = '';
					$options .= "
						<option value=\"{$sql->row[$config_service['PK_SERVICE']]}\" $selected>{$sql->row[$config_service['PK_SERVICE']]}</option>
						";
				}
				$paziente = "
					<select name=\"{$config_service['PK_SERVICE']}\" onchange=\"document.forms[0].submit();\">
						<option value=''></option>
						" . $options . "
						</select>";
			} else {
				if ($sql->numrows > 0) {
					$sql->get_row ();
					$in ['CENTER'] = $sql->row ['CENTER'];
					$paziente = "<b>{$sql->row[$config_service['PK_SERVICE']]}</b><input type=\"hidden\" name=\"{$config_service['PK_SERVICE']}\" value=\"{$in[$config_service['PK_SERVICE']]}\">";
				} else {
					$in [$config_service ['PK_SERVICE']] = '';
					$no_pat = "<b>" . $this->testo ( "noPatient" ) . "</b>";
					//					if($this->config_service['lang']=="en") {
					//						$no_pat="<b>There are no patients in this center</b>";
					//					} else {
					//						$no_pat="<b>Non ci sono pazienti registrati in questo centro</b>";
					//					}
					$paziente = $no_pat;
				}

			}
		}
		return $paziente;
	}

	/**
	 * Lista Registri (equery)
	 *
	 * @return String
	 */
	function eRegistryList() {
		//		global $xml_dir;
		//		global $in;
		//		global $config_service;
		//		global $service;
		$xml_dir = $this->xml_dir;
		$in = $this->session_vars;
		$service = $this->service;
		$config_service = $this->config_service;
        if($this->config_service['eQueryXmlConfigurations']['SingleRegistry']){
            $return = "<input type='hidden' name='REGISTRY' value='{$this->service}' />";
            $in['REGISTRY'] = $_POST['REGISTRY'] = $this -> session_vars['REGISTRY'] = $this -> service;
            return $return;
        }
		if ($this->session_vars [$this->config_service ['PK_SERVICE']] != '') {
			if (isset ( $in ['REGISTRY'] ) && $in ['REGISTRY'] == $this->xmr->prefix)
			$selected = "selected";
			else
			$selected = '';
			$options .= "<option value='{$this->xmr->prefix}' $selected>{$this->xmr->workflow['DESCR']}</option>";
			foreach ( $this->xmr->substudies as $val ) {
				#echo $val;
				if (isset ( $in ['REGISTRY'] ) && $in ['REGISTRY'] == $val->prefix)
				$selected = "selected";
				else
				$selected = '';
				$sql_query_2 = "select count(*) conto from {$val->prefix}_coordinate where {$this->config_service['PK_SERVICE']}='{$this->session_vars[$this->config_service['PK_SERVICE']]}'";
				$sql = new query ( $this->conn );
				//$sql->set_sql ( $sql_query_2 );
				unset($bind_pk);
				$bind_pk['PK_SERVICE']=$this->session_vars[$this->config_service['PK_SERVICE']];
				$sql->exec ($sql_query_2,$bind_pk);//binded
				$sql->get_row ();
				if ($sql->row ['CONTO'] > 0) {
					$options .= "
						<option value=\"{$val->prefix}\" $selected>{$val->workflow['DESCR']}</option>
						";
				}

			}
			$registry_select = "
					<select name=\"REGISTRY\" onchange=\"document.forms[0].submit();\">
						<option></option>
						" . $options . "
						</select>";

		} else {
			$sql_query_2 = "select registry from {$this->xmr_root->prefix}_equery where ID=:eq_id";
			$sql = new query ( $this->conn );
			//$sql->set_sql ( $sql_query_2 );
			unset($bind);
			$bind['EQ_ID']=$this->session_vars['ID'];
			$sql->exec ($sql_query_2,$bind); //binded
			$sql->get_row ();
			$registry = $sql->row ['REGISTRY'];
			$registry_select = "<b>" . $registry . "</b>";
		}

		return $registry_select;

		//		$sql_query="select distinct c.* from {$service}_centri c, {$service}_utenti_centri uc where uc.userid='{$in['remote_userid']}' and uc.center=c.center ";
		//		$sql=new query($this->conn);
		//		$sql->set_sql($sql_query);
		//		$sql->exec();//commentata


	}

	/**
	 * Lista dei centri su cui ha visibilità l'utente (equery)
	 *
	 * @return array
	 */
	function eCenterList() {
		//		global $xml_dir;
		//		global $in;
		//		global $config_service;
		//		global $service;
		$xml_dir = $this->xml_dir;
		$in = $this->session_vars;
		$service = $this->service;
		$config_service = $this->config_service;

		//da filtrare con solo centri che hanno pazienti
		$sql_query = "select  distinct c.* from {$service}_centri c, {$service}_utenti_centri uc where uc.userid='{$in['remote_userid']}' and uc.center=c.center ";

		$sql = new query ( $this->conn );
		//$sql->set_sql ( $sql_query );
		unset($bind);
		$bind['USERID']=$in['remote_userid'];
		$sql->exec ($sql_query,$bind);//binded
		$options = '';
		if ($sql->numrows > 1) {

			while ( $sql->get_row () ) {
				if (isset ( $in ['CENTER'] ) && $in ['CENTER'] == $sql->row ['CENTER'])
				$selected = "selected";
				else
				$selected = '';
				$options .= "
						<option value=\"{$sql->row['CENTER']}\" $selected>{$sql->row['DENOM']} {$sql->row['CITTA']}</option>
						";
			}
			$centro = "
					<select name=\"CENTER\" onchange=\"document.forms[0].submit();\">
						<option value=''></option>
						" . $options . "
						</select>";
		} else {
			$sql->get_row ();
			$centro = "<b>{$sql->row['DENOM']}</b><input type=\"hidden\" name=\"CENTER\" value=\"{$in['CENTER']}\">";

		}
//
		return $centro;
	}

	//	function eStudytList(){
	//		global $xml_dir;
	//		global $in;
	//		global $config_service;
	//		global $service;
	//		$in=$this->session_vars;
	//		$sql_query="select  wf.* from workflow wf";
	//		$sql=new query($this->conn);
	//		$sql->set_sql($sql_query);
	//		$sql->exec();//commentata
	//
	//		$options='';
	//		if (isset($in[$config_service['PK_SERVICE']]) && $in[$config_service['PK_SERVICE']]!=''){
	//			if ($sql->numrows>1){
	//
	//				while ($sql->get_row()){
	//					$prefix=substr($sql->row['PREFIX'],0,strlen($sql->row['PREFIX'])-2);
		//					$sql_query_2="select  count(*) conto from {$prefix}_coordinate where {$config_service['PK_SERVICE']}='{$in[$config_service['PK_SERVICE']]}'";
		//					$sql_2=new query($this->conn);
		//					$sql_2->set_sql($sql_query_2);
		//					$sql_2->exec();//commentata
		//					$sql_2->get_row();
		//					if($sql_2->row['CONTO']>0){
		//						if($in['STUDY']==$sql->row['ID'])$selected='selected="selected"';
			//						else $selected="";
			//						$options.="
			//						<option value=\"{$sql->row['ID']}\" $selected>{$sql->row['DESCR']}</option>
			//						";
			//					}
			//				}
			//				$study="
			//					<select name=\"STUDY\" onchange=\"document.forms[0].submit();\">
	//						<option value=''></option>
	//						".$options."
	//						</select>";
	//			}
	//			else {
	//				$sql->get_row();
		//				$study="<b>{$sql->row['DENOM']}</b><input type=\"hidden\" name=\"STUDY\" value=\"{$in['CENTER']}\">";
		//
	//			}
	//		}
	//		return $study;
	//	}


	/**
	 * Salvataggio equery
	 *
	 */
	function eQuerySave() {
		//		global $in;
		global $filetxt;
		global $body;
		//		global $service;
		//		global $config_service;
		global $from_service_email;

		$in = $this->session_vars;
		$service = $this->service;
		$config_service = $this->config_service;

		$xml_dir = $this->xml_dir;
		$form = $in ['form'];
		$in ['INVIOCO'] = '1';
		$xml_form = new xml_form ( );
		$xml_form->xml_form_by_file ( $xml_dir . '/' . $form );
		$xml_form->valida ();
		if ($xml_form->validata) {
			$this->invia_db_dm ( $xml_form );
			$filetxt = preg_replace ( "/<!--body-->/", $body, $filetxt );
			echo $filetxt;
			die ();

		}

	}

	/**
	 * Costruisce l'href
	 *
	 * @param String $testo_link
	 * @param number $profondita
	 * @return String
	 */
	function href($testo_link, $profondita = 0) {
		if (! isset ( $this->hrefs [$testo_link] )) {
			$this->hrefs ['Home'] = "index.php";
			$this->hrefs ['Registro Lista Pazienti'] = "index.php?list=patients_list.xml&CENTER={$this->session_vars['CENTER']}";
			$this->hrefs ['Registro Lista Centri'] = "index.php?list=patients_list.xml";
			$this->hrefs ['Vista Paziente'] = "index.php?exams=visite_exam.xml&{$this->config_service ['PK_SERVICE']}=$this->pk_service&CENTER={$this->session_vars['CENTER']}";
			$this->hrefs ['eQuery List'] = "index.php?eQuery&";
		}
		for($i = 1; $i <= $profondita; $i ++) {
			$back_href .= "../";
		}
		return $back_href . $this->hrefs [$testo_link];
	}

	/**
	 * Tabella paziente (obsoleta)
	 *
	 */
	function make_patient_table() {
		return;
	}

	/**
	 * Menu a briciola di pane
	 *
	 * @param String $type
	 * @param array $dynamic_link_text
	 * @return String
	 */
	function breadcrumb($type, $dynamic_link_text='') {
		/*
		 * Il termine inglese 'breadcrumb'
		 * (letteralmente 'briciola di pane')
		 * fa riferimento alla favola di Grimm, Hansel e Gretel,
		 * che racconta la storia di due bambini perduti nel bosco che ...
		 * ...
		 * ...
		 * e poi sono morti tutti.
		 *
		 */
		$in = $this->session_vars;
		$percorso [0] ['TESTO'] = $this->testo ( 'Home' );
		$percorso [0] ['HREF'] = $this->href ( 'Home', $this->xmr->depth );

		switch ($type) {
			case 'form' :
				if (isset ( $this->session_vars ['CENTER'] )) {
					if ($this->xmr->depth > 0) {
						$percorso [] ['TESTO'] = $this->testo ( 'Registro Lista Pazienti' );
						$percorso [count ( $percorso ) - 1] ['HREF'] = $this->href ( 'Registro Lista Pazienti', $this->xmr->depth );
						$percorso [] ['TESTO'] = $this->testo ( 'Registro Lista Pazienti' ) . "($this->service)";
						$percorso [count ( $percorso ) - 1] ['HREF'] = $this->href ( 'Registro Lista Pazienti' );
					} else {
						$percorso [] ['TESTO'] = $this->testo ( 'Registro Lista Pazienti' );
						$percorso [count ( $percorso ) - 1] ['HREF'] = $this->href ( 'Registro Lista Pazienti' );
					}
				} else if (isset ( $this->centers )) {
					if ($this->xmr->depth > 0) {
						$percorso [] ['TESTO'] = $this->testo ( 'Registro Lista Centri' );
						$percorso [count ( $percorso ) - 1] ['HREF'] = $this->href ( 'Registro Lista Centri', $this->xmr->depth );
						$percorso [] ['TESTO'] = $this->testo ( 'Registro Lista Centri' ) . " ($this->service)";
						$percorso [count ( $percorso ) - 1] ['HREF'] = $this->href ( 'Registro Lista Centri' );

					} else {
						$percorso [] ['TESTO'] = $this->testo ( 'Registro Lista Centri' );
						$percorso [count ( $percorso ) - 1] ['HREF'] = $this->href ( 'Registro Lista Centri' );
					}
				}

				if ($this->pk_service != '' && $this->pk_service != "next") {
					if ($this->xmr->depth > 0)
					$percorso [] ['TESTO'] = $this->testo ( 'Vista Paziente' ) . " ($this->service)";
					else
					$percorso [] ['TESTO'] = $this->testo ( 'Vista Paziente' );
					$percorso [count ( $percorso ) - 1] ['HREF'] = $this->href ( 'Vista Paziente' );

				}
				$percorso [] ['TESTO'] = $dynamic_link_text;
				break;
			case 'patients_list' :
				//nuovo modo, solo lista centri valorizzato
				if ((isset ( $this->session_vars ['list'] ) && $this->session_vars ['list'] == 'patients_list.xml') || isset ( $_GET ['lista'] )) {
					if (isset ( $this->session_vars ['CENTER'] )) {
						if ($this->xmr->depth > 0) {
							$percorso [] ['TESTO'] = $this->testo ( 'Registro Lista Pazienti' );
							$percorso [count ( $percorso ) - 1] ['HREF'] = $this->href ( 'Registro Lista Pazienti', $this->xmr->depth );
							$percorso [] ['TESTO'] = $this->testo ( 'Registro Lista Pazienti' ) . " ($this->service)";
							$percorso [count ( $percorso ) - 1] ['HREF'] = $this->href ( 'Registro Lista Pazienti' );

						} else {
							$percorso [] ['TESTO'] = $this->testo ( 'Registro Lista Pazienti' );
							$percorso [count ( $percorso ) - 1] ['HREF'] = $this->href ( 'Registro Lista Pazienti' );
						}
					} else if (isset ( $this->centers )) {
						if ($this->xmr->depth > 0) {
							$percorso [] ['TESTO'] = $this->testo ( 'Registro Lista Centri' );
							$percorso [count ( $percorso ) - 1] ['HREF'] = $this->href ( 'Registro Lista Centri', $this->xmr->depth );
							$percorso [] ['TESTO'] = $this->testo ( 'Registro Lista Centri' ) . " ($this->service)";
							$percorso [count ( $percorso ) - 1] ['HREF'] = $this->href ( 'Registro Lista Centri' );

						} else {
							$percorso [] ['TESTO'] = $this->testo ( 'Registro Lista Centri' );
							$percorso [count ( $percorso ) - 1] ['HREF'] = $this->href ( 'Registro Lista Centri' );
						}
					}
				}else {
					if ($this->xmr->depth > 0) {
						$percorso [] ['TESTO'] = $this->testo ( 'Registro Lista Pazienti' );
						$percorso [count ( $percorso ) - 1] ['HREF'] = $this->href ( 'Registro Lista Pazienti', $this->xmr->depth );
						$percorso [] ['TESTO'] = $this->testo ( 'Registro Lista Pazienti' ) . " ($this->service)";
						$percorso [count ( $percorso ) - 1] ['HREF'] = $this->href ( 'Registro Lista Pazienti' );

					} else {
						$percorso [] ['TESTO'] = $this->testo ( 'Registro Lista Pazienti' );
						$percorso [count ( $percorso ) - 1] ['HREF'] = $this->href ( 'Registro Lista Pazienti' );
					}
				}

				//type=exam_list
				break;
			case 'altra_list' :
				//tutto uguale a patients_list, ma prendo un altro titolo (dalla scheda stessa)
				//nuovo modo, solo lista centri valorizzato
						$percorso [] ['TESTO'] = $dynamic_link_text;
						$percorso [count ( $percorso ) - 1] ['HREF'] = $dynamic_link_text;

				//type=exam_list
				break;
			case 'exam_list' :
				if (isset ( $this->session_vars ['CENTER'] )) {
					if ($this->xmr->depth > 0) {
						$percorso [] ['TESTO'] = $this->testo ( 'Registro Lista Pazienti' );
						$percorso [count ( $percorso ) - 1] ['HREF'] = $this->href ( 'Registro Lista Pazienti', $this->xmr->depth );
						$percorso [] ['TESTO'] = $this->testo ( 'Registro Lista Pazienti' ) . " ($this->service)";
						$percorso [count ( $percorso ) - 1] ['HREF'] = $this->href ( 'Registro Lista Pazienti' );
					} else {
						$percorso [] ['TESTO'] = $this->testo ( 'Registro Lista Pazienti' );
						$percorso [count ( $percorso ) - 1] ['HREF'] = $this->href ( 'Registro Lista Pazienti' );
					}
				} else if (isset ( $this->centers )) {
					if ($this->xmr->depth > 0) {
						$percorso [] ['TESTO'] = $this->testo ( 'Registro Lista Centri' );
						$percorso [count ( $percorso ) - 1] ['HREF'] = $this->href ( 'Registro Lista Centri', $this->xmr->depth );
						$percorso [] ['TESTO'] = $this->testo ( 'Registro Lista Centri' ) . " ($this->service)";
						$percorso [count ( $percorso ) - 1] ['HREF'] = $this->href ( 'Registro Lista Centri' );

					} else {
						$percorso [] ['TESTO'] = $this->testo ( 'Registro Lista Centri' );
						$percorso [count ( $percorso ) - 1] ['HREF'] = $this->href ( 'Registro Lista Centri' );
					}
				}
				if (isset ( $this->session_vars ['exams'] ) && isset ( $this->session_vars ['CENTER'] )) {

					$percorso [] ['TESTO'] = $this->testo ( 'Vista Paziente' );

				}
				break;
			case 'search' :
				$percorso [] ['TESTO'] = $this->testo ( 'Search' );
				break;
			case 'equery' :
				//				print_r($in);
				//				$percorso[]['TESTO']=$this->testo('Equery');
				if (! isset ( $in ['eform'] ) && ! isset ( $in ['eform'] )) {
					$percorso [] ['TESTO'] = "<b>" . $this->testo ( 'eQueryList' ) . "</b>";
				} else {
					$percorso [] ['TESTO'] = $this->testo ( 'eQueryList' );
					$percorso [count ( $percorso ) - 1] ['HREF'] = $this->href ( 'eQuery List' );
					if (! isset ( $in ['ID'] )) {
						$percorso [] ['TESTO'] = '<b>'.$this->testo ( 'newEquery' ).'</b>';
					} else {
						$sql_dati_query = "select * from {$this->xmr_root->prefix}_equery where id=:eq_id";
						$sql = new query ( $this->conn );
						//$sql->set_sql ( $sql_dati_query );
						unset($bind);
						$bind['EQ_ID']=$in['ID'];
						$sql->exec ($sql_dati_query,$bind);//binded
						$sql->get_row ();
						$dati_equery = $sql->row;
						$percorso [] ['TESTO'] = "<b>eQuery n.ro {$sql->row['ID']}</b>";
					}
				}
				break;
				case 'gest_profili' :
					$percorso [] ['TESTO'] = "<b>" . $this->testo ( 'gest_prof' ) . "</b>";

		}

		$percorso_html = "";
		$n_links = count ( $percorso );
		foreach ( $percorso as $key => $link ) {
			if ($key != $n_links - 1)
			$percorso_html .= "<a href=\"{$link['HREF']}\" >{$link['TESTO']}</a> &gt;&gt; ";
			else
			$percorso_html .= $link ['TESTO'];
		}

		$percorso_html = "<p>$percorso_html</p>";
		return $percorso_html;
	}

	/**
	 * Notifica eQuery
	 *
	 * @param String $switch_notifica
	 * @param number $id
	 * @return String
	 */
function notifica_equery($switch_notifica, $id) {

		$in = $this->session_vars;
//echo "Notifica:<hr>";
//print_r($in);
		$service = $this->service;
		$config_service = $this->config_service;
		$conn = $this->conn;
		
		$sql = new query ( $conn );
		$sql->set_sql ( "select max(id) as maxid from " . $service . "_equery" );
		$sql->exec ();
		$sql->get_row ();

		$query = "select nome||' '||cognome||' - '||azienda_ente as mitt from ana_utenti where userid='{$in['remote_userid']}'";
		$sql->set_sql ( $query );
		$sql->exec ();
		$sql->get_row ();
		//		echo $query;

		if ($_SERVER ['HTTPS'])
		$s = 's';
		$link = "http$s://" . $_SERVER ['HTTP_HOST'] . $_SERVER ['PHP_SELF'] . "?eQuery";

		switch ($switch_notifica) {
			case "1" :
				$where = "where a.userid=uc.userid and uc.center='{$in['CENTER']}' and ";
				if ($this->config_service ['lang'] == "en")
				$testo_mail = "New equery send from {$sql->row['MITT']} query n. $id
					<br /><br />
					Equeries list:<br />
					<a href='$link'>$link</a>
					";
					else
					$testo_mail = "Nuova equery inviata da {$sql->row['MITT']} query n. $id
					<br /><br />
					Elenco equery:<br />
					<a href='$link'>$link</a>
					";
					break;
			case "2" :
				$where = ", {$service}_equery eq where eq.id='{$in['ID']}' and eq.center=uc.center and a.userid=uc.userid and ";
				if ($this->config_service ['lang'] == "en")
				$testo_mail = "Equery answer n. $id
					<br /><br />
					Equeries list:<br />
					<a href='$link'>$link</a>
					";
					else
					$testo_mail = "Risposta query n. $id
					<br /><br />
					Elenco equery:<br />
					<a href='$link'>$link</a>
					";
					break;
			default :
				$where = " where ";
				return '';
		}

		//G.Tufano 27/07/2011
		//modifica: inserita la clausola per evitare di includere le farma territoriali tra i mittenti (lunghezza 9 e penultimo carattere = '0')
		//inoltre già che c'ero ho impostato l'invio affinché usi la libreria avanzata Mail.php 
		if ($in ['USER_TIP'] == 'DE') {
			$query = "select email from ana_utenti a, {$service}_utenti_centri uc $where uc.tipologia like '%manager%' and a.userid not like '______00_' and a.userid not like '_______0_'";
			$sql->set_sql ( $query );
			$sql->exec ();
			$to = '';
//			echo "if ".$query;die();
			while ( $sql->get_row () ) {
				if ($to != '')
				$to .= ",";
				$to .= $sql->row ['EMAIL'];
			}

		} else {
			$query = "select email from ana_utenti a,{$service}_utenti_centri uc $where  uc.tipologia like '%Entry%' and a.userid not like '______00_' and a.userid not like '______0_'";
//			echo "else ".$query;die();
			$sql->set_sql ( $query );
			$sql->exec ();

			$to = '';
			while ( $sql->get_row () ) {
				if ($to != '')
				$to .= ",";
				$to .= $sql->row ['EMAIL'];
			}
//		echo $to."<hr>";
		}

		//**** INVIO MAIL
		include_once 'Mail.php';
		
		//differenzio se sono in test o no
		if ((preg_match("/sissdev/i",$_SERVER['SERVER_NAME'])) || (preg_match("/sissprep/i",$_SERVER['SERVER_NAME']))){
			$test='***TEST***';
		}
		else{
			$test='';
		}
		
		//IMPOSTARE NEL CONFIG QUESTI PARAMETRI
		$from_service_email = $config_service ['from_service_email'];
		$from_service_name = $config_service ['from_service_name'];
		
		$reply_to = ($config_service['from_service_name']=='')? 'noreply@cineca.it': $config_service ['from_service_name'];
		
		if ($config_service ['oggetto_notifiche'] != "")
			$oggetto = $test.$config_service ['oggetto_notifiche'] . "- query n. '.$id";
		else
			$oggetto = $test.$_SERVER ['SERVER_NAME'] . ' - query n. ' . $id;
			
	
		
//		echo "tutto ok";die($from_service_email.' '.$from_service_name);
		if ($testo_mail != '')
			send_email_advanced(null, $from_service_email, $from_service_name, $oggetto, $testo_mail, $reply_to,false, null, $to);
	}




	function getAdminProfili() {
		//estraggo i gestori dei profili
		$sql_query="select * from user_views where view_name = '{$this->workflow->prefix}_ANA_ADMIN_PROFILI'";
		$sql_check=new query($this->conn);
		$sql_check->set_sql($sql_query);
		$sql_check->exec();//non richiede binding
		if($sql_check->numrows>0) {
			$sql_query="select * from {$this->workflow->prefix}_ANA_ADMIN_PROFILI";
//			echo $sql_query;
			$sql=new query($this->conn);
			$sql->set_sql($sql_query);
			$sql->exec();//non richiede binding
			while($sql->get_row()) {
				$this->admin_profili[]=$sql->row['USERID'];
			}

			//			} else {
			//				echo("Creare la vista {$this->workflow->prefix}_ANA_ADMIN_PROFILI con almeno il campo USERID contenente le user dei gestori dei profili");
			//			}
		}
	}

	/*
	 * admin_profili:
	 * Interfaccia di gestione del multiprofilo da parte degli utenti presenti nella vista [prefix]_gest_profili
	 *
	 * Tb dove salva le assegnazioni: [prefix]_admin_profili
	 *
	 * */
	function admin_profili_tb() {
		
		$this->body .= $this->breadcrumb("gest_prof");
		$prefix=$this->workflow->prefix;
		
		$sql_query = "select * from user_all_tables where table_name='{$prefix}_ASSIGN_PROFILI'";
		$sql_check=new query($this->conn);
		$sql_check->get_row($sql_query);
		if($sql_check->numrows==0) {
			$create_sql="
			CREATE TABLE {$prefix}_ASSIGN_PROFILI(
				USERID VARCHAR2(32 CHAR),
				PROFILE VARCHAR2(400 CHAR),
				PREDEF_ID VARCHAR2(400 CHAR),
				constraint pk_{$prefix}_userid primary key (userid,PROFILE)
			)";
			$sql_create=new query($this->conn);
			$sql_create->set_sql($create_sql);
			$sql_create->ins_upd();//non richiede binding

//			$values['USERID']=$this->user->userid;
//			$values['PROFILE']=$first_id;
//			$values['PREDEF_ID']='Yes';
//			$sql=new query($this->conn);
//			$sql->insert($values,"{$prefix}_ASSIGN_PROFILI");

			die("CREATA TABELLA $table ; inserire almeno un utente  a mano nella tabella creata.<br /> <a href=\"#\" onclick=\"window.location.href=window.location.href;\">Ricarica</a>");
		}

		if(in_array($this->user->userid,$this->admin_profili)) {

			//estraggo gli user dei profili
			$sql_query="select * from user_views where view_name = '{$prefix}_ANA_USER_PROFILI'";
			$sql_check=new query($this->conn);
			//$sql_check->set_sql($sql_query);
			unset($bind_table);
			$bind_table['TABLE_NAME']="{$prefix}_ANA_USER_PROFILI";
			$sql_check->exec($sql_query,$bind_table);//binded
			if($sql_check->numrows>0) {
				$sql_query="select * from {$prefix}_ANA_USER_PROFILI";
				$sql=new query($this->conn);
				$sql->set_sql($sql_query);
				$sql->exec();//non richiede binding
				while($sql->get_row()) {
					$this->user_profili[]=$sql->row['USERID'];
				}
			} else {
				die("Creare la vista {$prefix}_ANA_USER_PROFILI con almeno il campo USERID contenente le user dei gestori dei profili");
			}

			if(!in_array($this->user->userid,$this->admin_profili)) {
				die("L'utente {$this->user->userid} non è abilitato alla gestione dei multi-profili nella tabella [prefix]_ANA_ADMIN_PROFILI");
			}
			
			$sql_query = "select ID,DECODE from {$prefix}_attori_multi order by POS";
			$sql_check=new query($this->conn);
			$sql_check->exec($sql_query);//non richiede binding
			$all_profiles=array();
			while($sql_check->get_row()) {
				$all_profiles[$sql_check->row['ID']]=$sql_check->row['DECODE'];
			}

			//salvo le impostazioni utenti-profili
			if(isset($_POST['salva_admin_profili']) && $_POST['salva_admin_profili']!="") {
				foreach($_POST as $key=>$val) {
					if(preg_match("/^checkbox_/",$key)) {
						if($val=="on")
						$checkbox_array[]=str_replace("checkbox_","",$key);
					}

					if(preg_match("/^sel_/",$key)) {
						if($val!="")
						$sel_array[]=str_replace("sel_","",$key)."_$val";
					}
				}
				$table=$prefix."_ASSIGN_PROFILI";
				$query="delete from $table";
				$sql_delall=new query($this->conn);
				$sql_delall->set_sql($query);
				$sql_delall->ins_upd();//non richiede binding
				$this->conn->commit();
				foreach($checkbox_array as $key=>$val) {
					$checkbox_arr=explode("_",$val);
					if(!in_array($checkbox_arr[0],$this->user_profili)) {
						die("L'utente {$checkbox_arr[0]} non è abilitato alla gestione dei multi-profili nella tabella [prefix]_ANA_ADMIN_PROFILI");
					}
					$values['USERID']=$checkbox_arr[0];
					$values['PROFILE']=$checkbox_arr[1];
					$query="select * from $table where USERID='{$checkbox_arr[0]}' and PROFILE='{$checkbox_arr[1]}'";
					$sql_integrity=new query($this->conn);
					$sql_integrity->get_row($query);
					$sql=new query($this->conn);
					$sql->insert($values,$table);
					$this->conn->commit(); 
					
				}

				foreach($sel_array as $key=>$val) {
					$sel_arr=explode("_",$val);
					$table=$prefix."_ASSIGN_PROFILI";
					$values=array();
					$pk=array();
					$pk['USERID']=$sel_arr[0];
					$values['PREDEF_ID']="";
					$sql_clean=new query($this->conn);
					$sql_clean->update($values,$table,$pk);
					$this->conn->commit();

					$values=array();
					$pk=array();
					$pk['USERID']=$sel_arr[0];
					$pk['PROFILE']=$sel_arr[1];
					$values['PREDEF_ID']="Yes";
					$sql_yes=new query($this->conn);
					$sql_yes->update($values,$table,$pk);

					$this->conn->commit();

				}

				header("Location: {$_SERVER['REQUEST_URI']}");



			}

			$html.="
				<style>
				#admin_profili {
				margin:5px auto;
				border: 1px solid #1b358a;
				border-collapse: collapse
				}
				#admin_profili td {
				border: 1px solid #1b358a;
				padding:5px;
				}
				#admin_profili td.center {
				margin:auto;
				text-align:center;
				}
				</style>
				";
			$html.="<a href=\"index.php\">Home</a>
			<p><h2 style=\"text-align:center;text-decoration:underline;font-weight:bold;\">Utilizzare questa tabella per abilitare alle utenze i profili del sistema</h2></p>";
			$html.="<form method=\"POST\" id=\"profile_admin\"><table id=\"admin_profili\">";
			$html.="<tr><td class=\"int\">Username</td>";

			foreach($all_profiles as $id=>$profile) {
				$html.="<td class=\"int\"><b>".$profile."</b></td>";
			}
			$html.= "<td class=\"int\"> <b>Profilo predefinito</b> </td>";
			$html.="</tr>";

			$html.="<tr><td  class=\"int\">&nbsp;</td>";
			foreach($all_profiles as $id=>$profile) {
				$html.="<td style=\"text-align:center;\" class=\"int\"><b>seleziona tutti</b><br /><input type=\"checkbox\" name=\"sel_all_$id\" onclick=\"if(this.checked) selall('$id','1'); else selall('$id','2');\" /></td>";
			}
			$html.= "<td class=\"int\">&nbsp;</td>";
			$html.="</tr>";

			$table=$prefix."_ASSIGN_PROFILI";
			$query="select * from $table";
			$sql_=new query($this->conn);
			$sql_->exec($query);//non richiede binding
			while($sql_->get_row()) {
				$dump_arr[]=$sql_->row['USERID']."_".$sql_->row['PROFILE'];
				$selected_arr[$sql_->row['USERID']."_".$sql_->row['PROFILE']]=$sql_->row['PREDEF_ID'];
			}

			foreach($this->user_profili as $id=>$user) {
				$html.="<tr>";
				$html.= "<td class=\"int\"> <b>".$this->useridNome($user)." ($user)</b> </td>";
				foreach($all_profiles as $id=>$profile) {
					$colspan++;
					$checked=$class="";
					if(in_array($user."_".$id,$dump_arr)) {
						$checked="checked=\"checked\"";
						$class="class=\"sc4bis\"";
					}
					$checkbox="<input type=\"checkbox\" name=\"checkbox_{$user}_{$id}\" $checked 
					onclick=\"if(!this.checked && document.forms[0].sel_$user.value==$id) {
						document.forms[0].sel_$user.value='';
					} else if(this.checked && document.forms[0].sel_$user.value==$id) {
						document.forms[0].sel_$user.value='';	
					} else if(this.checked && document.forms[0].sel_$user.value=='') {
						document.forms[0].sel_$user.value=$id;			
					} 
					\" />";
					$html.="<td style=\"text-align:center;\" $class onclick=\"
					if(this.className=='sc4bis') {
						this.className='';
					} else {
						this.className='sc4bis';
					} \"> $checkbox </td>";

				}


				$option_predef="<option value=\"\"></option>";
				$class_color="";
				foreach($all_profiles as $id=>$profile) {
					$selected="";
					if($selected_arr[$user."_".$id]=="Yes") {
						$selected="selected=\"selected\"";
					}
					$option_predef.="<option value=\"$id\" $selected>$profile</option>";
					if($selected!="") $class_color="class=\"sc4bis\"";
				}

				$select_predef="<select name=\"sel_{$user}\" onchange=\"check_predef('$user',this.value);
				\" />$option_predef</select>";
				$html.= "<td $class_color> $select_predef </td>";
				$html.="</tr>";
			}
			$html.="<tr>";

			$colspan_all=$colspan+count($this->user->profile_list);
			$invia_button.= "<td colspan=\"{$colspan_all}\" class=\"int\" style=\"text-align:center;\">
			<input type=\"submit\" value=\"Salva\" name=\"salva_admin_profili\" /></td></tr>";

			$html.= $invia_button;
			$html.="</table></form>";
			$html.="<p><a href=\"javascript:document.location.href=document.location.href;\"><h2 style=\"text-align:center;text-decoration:underline;font-weight:bold;\">Per ricaricare le impostazioni salvate aggiornare la pagina cliccando qui</h2></a></p>";

		} else {
			$html="<h2 style=\"color:red;\">Utenza non abilitata alla gestione dei profili. Contattare l'assistenza tecnica.</h2>";
		}

		return $html;

	}
	
	function useridNome($userid) {
		$sql_str="select nvl(nome||' ' ||cognome,'-') as nome from ana_utenti where userid = :userid";
		//		echo $sql_str;
		$sql=new query($this->conn);
		$bind['USERID']=$userid;
		$sql->exec($sql_str,$bind);//binded
		$sql->get_row();
		return $sql->row['NOME'];
	}

	
	/**
	 * Funzioni di libreria AIFA per gestire cancella/inserisci schede
	 * G.Tufano 12/12/2011
	 * 
	 */

	/**
	*
	* Funzione per cancellare un esame non progressivo
	* OVVIAMENTE con BINDING e senza toccare i costraints
	*/
	function DeleteEsam($nome_tabella,$visitnum, $visitnum_progr, $esam,$progr=1){
		$in=$this->session_vars;
		global $conn;
	
		if ($in['ajax_call']==''){
			$sql=new query($this->conn);
			//0.0 estrazione tabella dell'esame
			if ($nome_tabella != ''){
				$table = $nome_tabella;
			}
			else{
				$xml_form = new xml_form ( $this->conn, $this->service, $this->config_service, $this->session_vars, $this->uploaded_file_dir );
				$xml_form->xml_form_by_file ( $this->xml_dir . '/' . $this->vlist->esams [$visitnum] [$esam] ['XML'] );
				$table = $xml_form->form ['TABLE'];
			}
			//echo $table;
	
			//preparo il binding
			$bind = array();
			$bind['userid'] = $this->user->userid;
			$bind['pk_service'] = $_GET[$this->config_service['PK_SERVICE']];
			$bind['visitnum'] = $visitnum;
			$bind['visitnum_progr'] = $visitnum_progr;
			$bind['esam'] = $esam;
			$bind['progr'] = $progr;
	
	
			//			0.1 LOCK sulle tabelle
			$sql_lock = "LOCK TABLE $table,{$this->service}_coordinate in EXCLUSIVE MODE";
			// 						echo "--REM 0.1) LOCK: <br />$sql_lock <hr />";
			$sql->exec ($sql_lock);
	
			// 			0.2 Salvo la tabella nello storico
			$sql_storico = "insert into S_{$table}
						select :userid, 
						sysdate, 
						storico_id.nextval, 
						'V', 
						null, 
						{$table}.*
						from $table 
						where {$this->config_service['PK_SERVICE']}=:pk_service and 
						VISITNUM=:visitnum and 
						VISITNUM_PROGR=:visitnum_progr and 
						ESAM=:esam and
						progr = :progr
						";
	
						// 						echo "--REM 0.2)  storico: <br />$sql_storico <br />--" .print_r($bind,true)."<hr />";
						// 			die();
						$sql->ins_upd ($sql_storico,$bind);
	
					//1. cancello dalla tabella la riga corrispondente
					$sql_del_row_coo = "DELETE {$table}
										WHERE
										esam=:esam
									and visitnum=:visitnum
									and visitnum_progr=:visitnum_progr
									and {$this->config_service['PK_SERVICE']}= :pk_service
									and progr = :progr
									";
					// 			 			echo "--REM 1)  cancello la riga da coord: <br />$sql_del_row_coo <br />--" . print_r($bind,true)."<hr />";
					//  			die();
					$sql->ins_upd ($sql_del_row_coo,$bind);
						
					//2. riapro la scheda
					$sql_open_visit = "UPDATE {$this->service}_coordinate
												SET inizio = NULL,
													fine = NULL,
													--insertdt = NULL,
													--MODDT = NULL,
													--USERID = NULL,
													abilitato = 1
													--eq_action = NULL
												
												WHERE visitnum=:visitnum
												and visitnum_progr=:visitnum_progr
												and esam = :esam
												and {$this->config_service['PK_SERVICE']}= :pk_service
												and progr = :progr
								";
					// 						echo "--REM 2) Riapro la visita con inizio e fine: <br /> $sql_open_visit<br />--" . print_r($bind,true)."<hr />";
						
					$sql->ins_upd ($sql_open_visit,$bind);
	
						
	
					//2.1. infine controllo che la visita venga riaperta: visitclose =0
					$sql_open_visit = "UPDATE {$this->service}_coordinate
									SET visitclose = 0
									WHERE visitnum=:visitnum
									and visitnum_progr=:visitnum_progr
									and {$this->config_service['PK_SERVICE']}= :pk_service
									and progr = :progr
					";
					// 						echo "--REM 2.1) Riapro la visita con visitclose: <br /> $sql_open_visit<br />--" . print_r($bind,true)."<hr />";
					// 			die();
	
					$sql->ins_upd ($sql_open_visit,$bind);
					// 				die();
					$this->conn->commit();
		}
	
	}
	
	
	
	
	/**
	 * Cancella un esame progressivo tra altri 2 in una tabella, e
	 * si preoccupa automagicamente di sistemare anche le tabelle correlate
	 *
	 * in modalità "Don't Touch Costraints!!!" (Edo copyright)
	 * __creata da Giacomo Tufano 12/11/2010__
	 *
	 * @param number $visitnum
	 * @param number $visitnum_progr
	 * @param number $esam
	 * @param number $progr
	 */
	function DeleteProgrEsamConCorrelate($nome_tabella,$visitnum, $visitnum_progr, $esam, $progr){
		$sql=new query($this->conn);
			
		// 	 	echo $this->vlist->esams[$visitnum][$esam]['CORR'];die();
		//se sono il correlativo di qualcuno, non devo cancellare tutti i progr a catena, ma solo me stesso!
		if ($this->vlist->esams[$visitnum][$esam]['CORR'] != ''){
			$this->DeleteEsam($nome_tabella,$visitnum,$visitnum_progr,$esam, $progr);
		}
		else{
			$this->DeleteProgrEsam($nome_tabella,$visitnum,$visitnum_progr,$esam, $progr);
		}
		 
		 
		$sql_count="select max(esam) as MAXE,min(esam) as MINE
		 	from {$this->service}_coordinate  
		 	where
		 	visitnum={$visitnum} 
		 	and {$this->config_service['PK_SERVICE']}='{$this->pk_service}'";
		// echo $sql_count."<hr>";
		$sql->set_sql($sql_count);
		$sql->exec();
		$sql->get_row();
	
		$maxe=$sql->row['MAXE'];
			$mine=$sql->row['MINE'];
			$ncorr=-1;
		for ($nes=$mine;$nes<=$maxe;$nes++){
		//    echo $nes."<hr>";
			if ($this->vlist->esams[$visitnum][$nes]['CORR']==$esam)
			$ncorr=$nes;
		}
		//	  	   echo $ncorr."<hr>";
		if ($ncorr!=-1){
		$xml_form_corr= new xml_form ( $this->conn, $this->service, $this->config_service, $this->session_vars, $this->uploaded_file_dir );
		$xml_form_corr->xml_form_by_file($this->xml_dir . '/' . $this->vlist->esams [$visitnum] [$ncorr] ['XML'] );
		$table_corr = $xml_form_corr->form ['TABLE'];
		//print_r($xml_form_corr);die();
		$this->DeleteProgrEsam($table_corr,$visitnum,$visitnum_progr,$ncorr, $progr);
		}
	}
	
	static function SDeleteProgrEsam($conn, $config_service,$session_vars, $xmldir,$xml, $userid, $pk_service, $esam, $progr, $visitnum, $visitnum_progr){
		$sql=new query($conn);
		$xml_form = new xml_form ( $conn, $config_service['service'], $config_service, $session_vars, $xmldir );
		$xml_form->xml_form_by_file ($xmldir . '/' .$xml );
		$table = $xml_form->form ['TABLE'];
		$bind = array();
		$bind['userid'] = $userid;
		$bind['pk_service'] = $pk_service;
		$bind['visitnum'] = $visitnum;
		$bind['visitnum_progr'] = $visitnum_progr;
		$bind['esam'] = $esam;
		$bind['progr'] = $progr;
		//Controllo la foreign key verso coordinate
		$sql_query_fk="
			select 
			c.CONSTRAINT_NAME, c.DELETE_RULE, c.STATUS, c.DEFERRABLE,c.DEFERRED, c.VALIDATED 
			from user_constraints c, user_constraints c1  where c.CONSTRAINT_TYPE='R' and c.TABLE_NAME=upper('{$table}') and c1.CONSTRAINT_NAME=c.R_CONSTRAINT_NAME
			and c1.TABLE_NAME='{$config_service['service']}_COORDINATE'";
		if ($sql->get_row($sql_query_fk)){
			//Se presente controllo che sia DEFERRABLE e DEFERRED altrimenti la droppo e la ricreo DEFERRABLE e DEFERRED
		if ($sql->row['DEFERRABLE']!='DEFERRABLE' || $sql->row['DEFERRED']!='DEFERRED'){
			$alter1="ALTER TABLE $table drop constraint {$sql->row['CONSTRAINT_NAME']}";
			$alter2="ALTER TABLE $table ADD CONSTRAINT {$sql->row['CONSTRAINT_NAME']} 
			FOREIGN KEY({$config_service['PK_SERVICE']}, ESAM, VISITNUM, VISITNUM_PROGR, PROGR) 
			REFERENCES {$config_service['service']}_COORDINATE({$config_service['PK_SERVICE']}, ESAM, VISITNUM, VISITNUM_PROGR, PROGR) ";
			if ($sql->row['DELETE_RULE']=='CASCADE') $alter2.=" ON DELETE CASCADE ";
			$alter2.="DEFERRABLE INITIALLY DEFERRED";
			if ($sql->row['STATUS']=='ENABLED') $alter2.=" ENABLE";
			if ($sql->row['VALIDATED']=='VALIDATED') $alter2.=" VALIDATE";
			$sql->ins_upd($alter1);
			$sql->ins_upd($alter2);
		
		}
		}
		//Locko la tabella
		$sql_lock = "LOCK TABLE $table in EXCLUSIVE MODE";
		$sql->set_sql ( $sql_lock );
		$sql->ins_upd ();
		
		//Inserimento in storico:
		$sql_storico = "insert into S_{$table}
				select :userid,
				sysdate,
				storico_id.nextval,
				'E',
				(select inv_query from {$config_service['service']}_COORDINATE where  {$config_service['PK_SERVICE']}=:pk_service and VISITNUM=:visitnum and VISITNUM_PROGR=:visitnum_progr and ESAM=:esam and PROGR=:progr),
				{$table}.*
				from $table
				where {$config_service['PK_SERVICE']}=:pk_service and
				VISITNUM=:visitnum and
							VISITNUM_PROGR=:visitnum_progr and 
							ESAM=:esam and 
							PROGR=:progr
							";
// 				
// 				
				$sql->ins_upd($sql_storico, $bind);
				unset($bind['userid']);
				$sql_query="select * from $table where ESAM=:esam and VISITNUM=:visitnum and VISITNUM_PROGR=:visitnum_progr and PROGR=:progr and {$config_service['PK_SERVICE']}=:pk_service";
				$sql=new query($conn);
				$sql->get_row($sql_query, $bind);
				$db_vals=$sql->row;
				foreach ($xml_form->fields as $key=>$val){
					if (isset ( $val ['TYPE'] ) && $val ['TYPE'] != '')
					$field_type = "field_{$val['TYPE']}";
					else
					$field_type = "field";
		
					if ($config_service['field_lib'] != '' && file_exists ( $config_service['field_lib'] . $field_type . ".inc" )) {
						include_once $config_service['field_lib'] . $field_type . ".inc";
					} else
					include_once "{$field_type}.inc";
					$field_obj = new $field_type ( $xml_form, $key, $conn, $db_vals, $session_vars, $config_service['service'], $errors );
					//Funzione per la gestione avanzata della delete (fondamentalmente nei field legati alla WCA per impostare a Trash il documento
					if (method_exists($field_obj, "gestDelete")){
						$field_obj->gestDelete($conn);
					}
				}
				$check_visitclose="select visitclose from {$config_service['service']}_COORDINATE where {$config_service['PK_SERVICE']}=:pk_service and
				VISITNUM=:visitnum and
							VISITNUM_PROGR=:visitnum_progr and 
							ESAM=:esam  and 
							PROGR=:progr
							";
				$sql->get_row($check_visitclose,$bind);
				$visitclose=$sql->row['VISITCLOSE'];
				$delete_coord="delete from {$config_service['service']}_COORDINATE where {$config_service['PK_SERVICE']}=:pk_service and
				VISITNUM=:visitnum and
							VISITNUM_PROGR=:visitnum_progr and 
							ESAM=:esam and 
							PROGR=:progr";
				//verifico che ci sia almeno una progr dopo il delete se no reinserisco la prima			
				$check_n_progr="select count(progr) conto from {$config_service['service']}_COORDINATE where {$config_service['PK_SERVICE']}=:pk_service and
				VISITNUM=:visitnum and
							VISITNUM_PROGR=:visitnum_progr and 
							ESAM=:esam  
							";
				$values_one_progr[$config_service['PK_SERVICE']]=$pk_service;
				$values_one_progr['VISITNUM']=$visitnum;
				$values_one_progr['VISITNUM_PROGR']=$visitnum_progr;
				$values_one_progr['ESAM']=$esam;
				$values_one_progr['PROGR']=1;
				$values_one_progr['ABILITATO']=1;
				$values_one_progr['VISITCLOSE']=$visitclose;
				$values_one_progr['INSERTDT']='sysdate';
				
				if ($config_service['ALLOW_BLANK_PROGR']!=1){
				$update_coordinate="update {$config_service['service']}_COORDINATE set progr=progr-1 where {$config_service['PK_SERVICE']}=:pk_service and
				VISITNUM=:visitnum and
							VISITNUM_PROGR=:visitnum_progr and 
							ESAM=:esam and 
							PROGR>:progr";
				$update_table="update {$table} set progr=progr-1 where {$config_service['PK_SERVICE']}=:pk_service and
				VISITNUM=:visitnum and
							VISITNUM_PROGR=:visitnum_progr and 
							ESAM=:esam and 
							PROGR>:progr";
				foreach ($xml_form->fields as $key=>$val){
					if (isset ( $val ['TYPE'] ) && $val ['TYPE'] != '')
					$field_type = "field_{$val['TYPE']}";
					else
					$field_type = "field";
				
					if ($config_service['field_lib'] != '' && file_exists ( $config_service['field_lib'] . $field_type . ".inc" )) {
						include_once $config_service['field_lib'] . $field_type . ".inc";
					} else
					include_once "{$field_type}.inc";
					$field_obj = new $field_type ( $xml_form, $key, $conn, $db_vals, $session_vars, $config_service['service'], $errors );
					//Funzione per la gestione avanzata della update (fondamentalmente nei field legati alla WCA per impostare correttamente le keywords
					if (method_exists($field_obj, "gestDelete")){
							$field_obj->gestChangeProgr($conn, $progr);
					}
				}
				}
// 				
// 				
				$sql->ins_upd($delete_coord,$bind);
				$sql->get_row($check_n_progr,$bind);
				if($sql->row['CONTO']=='0'){
					$sql->insert($values_one_progr,$config_service['service'].'_COORDINATE');	
				}
				if ($config_service['ALLOW_BLANK_PROGR']!=1){
// 				
// 				
// 				
// 				
				$sql->ins_upd($update_coordinate,$bind);
				$sql->ins_upd($update_table,$bind);
				}			
// 				
	}
	
	/**
	* Cancella un esame progressivo
	* in modalità "Don't Touch Costraints!!!" (Edo copyright)
	* __creata da Giacomo Tufano 12/11/2010__
	*
	* UPDATE 16/11/2011 --> ORA CON BINDING!
	*
	* @param number $visitnum
	* @param number $visitnum_progr
	* @param number $esam
	* @param number $progr
	*/
	function DeleteProgrEsam($nome_tabella,$visitnum, $visitnum_progr, $esam, $progr){
	$in=$this->session_vars;
	
	global $conn;
	//
	if (isset($this->integrazione) && !$this->config_service['eQuerySpec']['Integrazione']['EXCLUDE_ESAM'][$esam] && !$this->config_service['eQuerySpec']['Integrazione']['EXCLUDE_VISIT'][$visitnum] && $this->integrazione->profilo==$this->integrazione->role && $this->session_vars['per_integrazione']=='true'){
		
		if ($this->integrazione->eq_int==''){
			
			$valuesEq['EQUERY_INT']="{$this->service}_EQSEQ.nextval";
			$valuesEq[$this->config_service['PK_SERVICE']]=$_GET[$this->config_service['PK_SERVICE']];
			$valuesEq['INS_DT']="sysdate";
			$valuesEq['STATO']=0;
			$valuesEQ['USERID_INS']=$this->user->userid;
			$sql=new query($this->conn);
			$sql->insert($valuesEq, $this->service."_EQ");
			$sql_query="select {$this->service}_EQSEQ.currval as eq_int from dual";
			$sql->get_row($sql_query);
			$this->integrazione->eq_int=$sql->row['EQ_INT'];
			
		}
		$xml_form = new xml_form ( $this->conn, $this->service, $this->config_service, $this->session_vars, $this->uploaded_file_dir );
		$xml_form->xml_form_by_file ( $this->xml_dir . '/' . $this->vlist->esams [$visitnum] [$esam] ['XML'] );
		$table = $xml_form->form ['TABLE'];
		
		$pk[$this->config_service['PK_SERVICE']]=$_GET[$this->config_service['PK_SERVICE']];
		$pk['ESAM']=$_GET['ESAM'];
		$pk['VISITNUM']=$_GET['VISITNUM'];
		$pk['VISITNUM_PROGR']=$_GET['VISITNUM_PROGR'];
		$pk['PROGR']=$_GET['PROGR'];
		$sql_query="select * from $table where ESAM={$pk['ESAM']} and VISITNUM={$pk['VISITNUM']} and VISITNUM_PROGR={$pk['VISITNUM_PROGR']} and PROGR={$pk['PROGR']} and {$this->config_service['PK_SERVICE']}={$pk[$this->config_service['PK_SERVICE']]}";
		$sql=new query($this->conn);
// 		
		$sql->get_row($sql_query);
		$db_vals=$sql->row;
		foreach ($xml_form->fields as $key=>$val){
			if (isset ( $val ['TYPE'] ) && $val ['TYPE'] != '')
			$field_type = "field_{$val['TYPE']}";
			else
			$field_type = "field";
				
			if ($this->config_service['field_lib'] != '' && file_exists ( $this->config_service['field_lib'] . $field_type . ".inc" )) {
				include_once $this->config_service['field_lib'] . $field_type . ".inc";
			} else
			include_once "{$field_type}.inc";
			$field_obj = new $field_type ( $xml_form, $key, $this->conn, $db_vals, $this->session_vars, $this->service, $this->errors );
			$field_obj->insert_stmt();
			foreach ($field_obj->field_stmt as $k1=>$field){
				if (!isset($pk[$field])){
					$valuesEqField='';
					foreach ($pk as $k2=>$v2){
						$valuesEqField[$k2]=$v2;
					}
					$valuesEqField['VALORE']=$db_vals[$field];
					$valuesEqField['FIELD']=$field;
					$valuesEqField['ACTION']=2;
					$valuesEqField['EQ_INT']=$this->integrazione->eq_int;
					$pk1='';
					$sql->insert($valuesEqField, $this->service."_EQFIELD", $pk1);
				}
			}
		}
		$coordUpdateValues['EQ_ACTION']=2;
		$coordUpdateValues['INV_QUERY']=$this->integrazione->eq_int;
		$sql->update($coordUpdateValues, $this->service."_COORDINATE", $pk);
		
		//effettuo inserimenti in eqfield con action=2
		$this->conn->commit();
		return;
		
	}
	if ($in['ajax_call']==''){
	$sql=new query($this->conn);
	call_user_func(__CLASS__."::SDeleteProgrEsam",$this->conn, $this->config_service,$this->session_vars,$this->xml_dir,$this->vlist->esams [$visitnum] [$esam] ['XML'], $this->session_vars['remote_userid'], $_GET[$this->config_service['PK_SERVICE']], $esam, $progr, $visitnum, $visitnum_progr);
	$this->conn->commit();
	return;
	/*MODIFICA  Carlo Contino 30/01/2012 Questa parte viene gestita dalla statica SDeleteProgrEsam
		
		
	// 			0.2 Salvo la tabella nello storico
	$sql_storico = "insert into S_{$table}
	select :userid,
	sysdate,
	storico_id.nextval,
	'V',
	null,
	{$table}.*
	from $table
	where {$this->config_service['PK_SERVICE']}=:pk_service and
	VISITNUM=:visitnum and
				VISITNUM_PROGR=:visitnum_progr and 
				ESAM=:esam and 
				PROGR=:progr
				";
				
	// 			echo "--REM 0.2)  storico: <br />$sql_storico <br />--" .print_r($bind,true)."<hr />";
	// 			die();
				$sql->ins_upd ($sql_storico,$bind);
				
				
				//1.1 controllo quanti progr sono
				$sql_maxq = "
								select
					nvl(max(progr),0) as conto
					from {$this->service}_coordinate
					where esam= :esam
					and visitnum=:visitnum
					and visitnum_progr=:visitnum_progr
					and {$this->config_service['PK_SERVICE']}=:pk_service";
				
// 					echo "--REM 2.1)  TROVA MAX:<br /> $sql_maxq <br />--" . print_r($bind,true)."<hr />";
				// 			die();
				$sql->exec ($sql_maxq,$bind);
				$sql->get_row ();
				
				
				
				$bind['max_progr'] = $sql->row ['CONTO'];
				// 			echo "<hr />TOTALE:". $bind['max_progr']." <hr />";die();
				
				//1.2 cancello da coordinate la riga corrispondente
	$sql_del_row_coo = "DELETE {$this->service}_coordinate
	WHERE
	esam=:esam
	and visitnum=:visitnum
	and visitnum_progr=:visitnum_progr
	and {$this->config_service['PK_SERVICE']}= :pk_service
	and progr = :progr";
// 	 			echo "--REM 1)  cancello la riga da coord: <br />$sql_del_row_coo <br />--" . print_r($bind,true)."<hr />";
// 	 			die();

				$sql->ins_upd ($sql_del_row_coo,$bind);
				
				
				//2. aggiungo un rigo in COORDINATE
	$sql_add_coo = "insert into {$this->service}_coordinate
	(VISITNUM, VISITNUM_PROGR, PROGR, ESAM, VISITCLOSE, {$this->config_service['PK_SERVICE']}, ABILITATO)
	VALUES
	(:visitnum, :visitnum_progr, :max_progr + 1 , :esam, 0, :pk_service, 1)";
	// 			echo "--REM 2.2) aggiungo una riga in COORDINATE:  <br />$sql_add_coo <br />--" . print_r($bind,true)."<hr />";
	// 			die();
				$sql->ins_upd ($sql_add_coo,$bind);
				
				//3. in COORDINATE tutte le righe da ultima fino a progr attuale shiftano: PROGR = PROGR-1
				$sql_update_coo = "UPDATE {$this->service}_coordinate
	SET progr = progr - 1
	WHERE
	esam=:esam
	and visitnum=:visitnum
	and visitnum_progr=:visitnum_progr
	and {$this->config_service['PK_SERVICE']}= :pk_service
	and progr > :progr
	";
		
	// 			echo "--REM 3)  Shift in coordinate: <br />$sql_update_coo<br />--" . print_r($bind,true)."<hr />";
	// 			die();
				$sql->ins_upd ($sql_update_coo,$bind);
				
				//4. in TABLE shifto i progr: PROGR = PROGR -1 da ultima fino a progr
				$sql_update_tab = "UPDATE $table
								SET progr = progr - 1
								WHERE 
								esam=:esam
	and visitnum=:visitnum
	and visitnum_progr=:visitnum_progr
	and {$this->config_service['PK_SERVICE']}= :pk_service
	and progr >= :progr
	";
// 				echo "--REM 4) Shift in TABLE:  <br />$sql_update_tab<br />--" . print_r($bind,true)."<hr />";
	// 			die();
	$sql->ins_upd ($sql_update_tab,$bind);
				
				
				//5. cancello la riga MAX_PROGR in coordinate
				$sql_del_last_riga_coo = "delete {$this->service}_coordinate 
	WHERE
	esam=:esam
	and visitnum=:visitnum
								and visitnum_progr=:visitnum_progr
								and {$this->config_service['PK_SERVICE']}= :pk_service
								and progr = :max_progr";
// 				echo "--REM 5) cancello max_progr in coordinate: <br /> $sql_del_last_riga_coo<br />--" . print_r($bind,true)."<hr />";
// 	 			die();
	$sql->ins_upd ($sql_del_last_riga_coo,$bind);
				
				//6. infine controllo che la visita venga riaperta: visitclose =0
				$sql_open_visit = "UPDATE {$this->service}_coordinate 
								SET visitclose = 0
								WHERE visitnum=:visitnum
								and visitnum_progr=:visitnum_progr
								and {$this->config_service['PK_SERVICE']}= :pk_service
								";
// 											echo "--REM 6) Riapro la visita: <br /> $sql_open_visit<br />--" . print_r($bind,true)."<hr />";
	
								$sql->ins_upd ($sql_open_visit,$bind);
	
	$this->conn->commit();
*/
	}
	
	}
	
	
	/**
	* Inserisce un esame progressivo tra altri 2
	* in modalità "Don't Touch Costraints!!!" (Edo copyright)
	* __creata da Giacomo Tufano 11/11/2010__
	*
	* @param number $visitnum
	* @param number $visitnum_progr
	* @param number $esam
	* @param number $progr
	*/
	function InsertProgrEsam($nome_tabella,$visitnum, $visitnum_progr, $esam, $progr){
		$in=$this->session_vars;
		global $conn;
		//global $visit_exam;
		//$vlist= new xml_esams_list($xml_dir.'/'.$visit_exam);
	
		if ($in['ajax_call']==''){
			$sql=new query($this->conn);
			//0.0 estrazione tabella dell'esame
			if ($nome_tabella != ''){
				$table = $nome_tabella;
			}
			else{
				$xml_form = new xml_form ( $this->conn, $this->service, $this->config_service, $this->session_vars, $this->uploaded_file_dir );
				$xml_form->xml_form_by_file ( $this->xml_dir . '/' . $this->vlist->esams [$visitnum] [$esam] ['XML'] );
				$table = $xml_form->form ['TABLE'];
			}
			//echo $table;
				
			//preparo il binding
			$bind = array();
			$bind['userid'] = $this->user->userid;
			$bind['pk_service'] = $_GET[$this->config_service['PK_SERVICE']];
			$bind['visitnum'] = $visitnum;
			$bind['visitnum_progr'] = $visitnum_progr;
			$bind['esam'] = $esam;
			$bind['PROGR'] = $progr;
				
			//			0.1 LOCK sulle tabelle
			$sql_lock = "LOCK TABLE $table,{$this->service}_coordinate in EXCLUSIVE MODE";
			// 			echo "--REM 0.1) LOCK: <br />$sql_lock <hr />";
			$sql->set_sql ( $sql_lock );
			$sql->ins_upd ();
				
			//0.2 Salvo la tabella nello storico
			$sql_storico = "insert into S_{$table}
				select 
					:userid, 
					sysdate, 
					storico_id.nextval, 
					'V', 
					null, 
					{$table}.*  
				from $table 
				where 
					{$this->config_service['PK_SERVICE']}= :pk_service and 
					VISITNUM= :visitnum and 
					VISITNUM_PROGR= :visitnum_progr and 
					ESAM= :esam and 
					PROGR >= :progr
				
				";
			// 			echo "--REM 0.2) storico:  <br />$sql_storico<br />".print_r($bind,true)."<hr />";
			// 			die();
			$sql->ins_upd ($sql_storico,$bind);
	
			//1.1 controllo quanti progr sono
			$sql_maxq = "
				select
					max(progr) as conto
				from {$this->service}_coordinate
				where 
					esam= :esam
					and visitnum= :visitnum
					and visitnum_progr=$visitnum_progr
					and {$this->config_service['PK_SERVICE']}= :pk_service
				";
			// 			echo "--REM 1.1a) controllo il nume di progr:  <br />$sql_maxq<br />".print_r($bind,true);
			$sql->exec ($sql_maxq,$bind);
			$sql->get_row ();
			$max_progr = $sql->row ['CONTO'];
			// 			echo "<br /> VALORE TROVATO: $max_progr<hr />";
			// 			die();
				
				
			$bind['max_progr'] = $sql->row ['CONTO'];
			//1.2 aggiungo un rigo in COORDINATE
			$sql_add_coo = "
								insert into {$this->service}_coordinate 
								(VISITNUM, VISITNUM_PROGR, PROGR, ESAM, VISITCLOSE, {$this->config_service['PK_SERVICE']}, ABILITATO)
									VALUES 
								(:visitnum, :visitnum_progr, :max_progr + 1 ,:esam, 0, :pk_service, 1)";
			// 			echo "--REM 1.2) aggiungo una riga in COORDINATE:  <br />$sql_add_coo<br />".print_r($bind,true)."<hr />";
			// 			die();
			$sql->ins_upd ($sql_add_coo,$bind);
	
			//2. in TABLE tutte le righe da ultima fino a progr attuale shiftano: PROGR = PROGR+1
			$sql_update_table = "UPDATE $table
								SET progr = progr +1
								WHERE 
								esam= :esam
								and visitnum= :visitnum
								and visitnum_progr= :visitnum_progr
								and {$this->config_service['PK_SERVICE']}= :pk_service
								and progr >= :progr
				";
				
			// 			echo "--REM 2) Shift in table:  <br />$sql_update_table<br />".print_r($bind,true)."<hr />";
			// 			die();
			$sql->ins_upd ($sql_update_table,$bind);
				
			//3. in COORDINATE shifto TUTTI I CAMPI tranne le coordinate da PROGR a PROGR +1
			/*			for ($i= $max_progr; $i >= $progr; $i--){
			$sql_update_coo = "UPDATE {$this->service}_coordinate
			SET
			(INIZIO, FINE, INSERTDT, MODDT, USERID, VISITCLOSE, INV_QUERY, {$this->config_service['PK_SERVICE']}, ABILITATO)
			=
			(SELECT INIZIO, FINE, INSERTDT, MODDT, USERID, VISITCLOSE, INV_QUERY, {$this->config_service['PK_SERVICE']}, ABILITATO
			from {$this->service}_coordinate where
			esam=$esam
			and visitnum=$visitnum
			and visitnum_progr=$visitnum_progr
			and {$this->config_service['PK_SERVICE']}= '{$this->pk_service}'
			and progr = $i )
			WHERE
			esam=$esam
			and visitnum=$visitnum
			and visitnum_progr=$visitnum_progr
			and {$this->config_service['PK_SERVICE']}= '{$this->pk_service}'
			and progr = $i+1 ";
			//				echo "3) Shift in COORDINATE: ".$sql_update_coo;echo "<hr />";
			$sql->set_sql ( $sql_update_coo );
			$sql->ins_upd ();
			}
			*/
			$sql_update_coo = "UPDATE {$this->service}_coordinate
			SET progr = progr +1
			WHERE
			esam= :esam
			and visitnum= :visitnum
			and visitnum_progr= :visitnum_progr
								and {$this->config_service['PK_SERVICE']}= :pk_service
								and progr >= :progr
				";
	// 			echo "--REM 3) Shift in COORDINATE:  <br />$sql_update_coo<br />".print_r($bind,true)."<hr />";
	// 			die();
			$sql->ins_upd ($sql_update_coo,$bind);
				
				
			//4. infine inserisco la riga PROGR mancante
			$sql_ins_missing_riga_coo = "insert into {$this->service}_coordinate
			(VISITNUM, VISITNUM_PROGR, PROGR, ESAM, VISITCLOSE, {$this->config_service['PK_SERVICE']}, ABILITATO)
									VALUES 
			(:visitnum, :visitnum_progr, :progr , :esam, 0, :pk_service, 1)
				";
	// 			echo "--REM 4) inserisco un'altra riga in coordinate:  <br />$sql_ins_missing_riga_coo<br />".print_r($bind,true)."<hr />";
			// 			die();
			$sql->ins_upd ($sql_ins_missing_riga_coo,$bind);
				
			//5. cancello infine il campo in pi?
			$sql_del_row_coo = "DELETE {$this->service}_coordinate
			WHERE
			esam= :esam
			and visitnum= :visitnum
			and visitnum_progr= :visitnum_progr
			and {$this->config_service['PK_SERVICE']}= :pk_service
								and progr = :max_progr + 2";
	// 			echo "--REM 5) cancello la riga in eccesso:  <br />$sql_del_row_coo<br />".print_r($bind,true)."<hr />";
	// 			die();
				$sql->ins_upd ($sql_del_row_coo,$bind);
				
			// 			die();
	
			$this->conn->commit();
		}
	
		}
	
	
			/**
		 * Inserisce un esame progressivo tra altri 2 in una tabella, e
		 * si preoccupa automagicamente di sistemare anche le tabelle correlate
		 *
		 * in modalità "Don't Touch Costraints!!!" (Edo copyright)
		 * __creata da Giacomo Tufano 11/11/2010__
		 *
		 * @param number $visitnum
		 * @param number $visitnum_progr
		 * @param number $esam
		 * @param number $progr
		 */
		 function InsertProgrEsamConCorrelate($nome_tabella,$visitnum, $visitnum_progr, $esam, $progr){
		 $sql=new query($this->conn);
		 $this->InsertProgrEsam($nome_tabella,$visitnum,$visitnum_progr,$esam, $progr);
		  
		 //preparo il binding
		 $bind = array();
		 $bind['userid'] = $this->user->userid;
		 $bind['pk_service'] = $this->pk_service;
		 $bind['visitnum'] = $visitnum;
		 $bind['visitnum_progr'] = $visitnum_progr;
		 $bind['esam'] = $esam;
		 $bind['PROGR'] = $progr;
		  
		 	$sql_count="select max(esam) as MAXE,min(esam) as MINE  
		 from {$this->service}_coordinate
		 where
		 visitnum= :visitnum
		 	and {$this->config_service['PK_SERVICE']}= :pk_service
		 	";
			// echo $sql_count."<br />".print_r($bind,true)."<hr>";
	
			$sql->exec($sql_count,$bind);
			$sql->get_row();
			
			$maxe=$sql->row[MAXE];
			$mine=$sql->row[MINE];
			
			$esami_corr = array();
			for ($nes=$mine;$nes<=$maxe;$nes++){
		 //    echo $nes."<hr>";
		 if ($this->vlist->esams[$visitnum][$nes]['CORR']==$esam)
		 $esami_corr[] = $nes;
	}
		 // 	 	 echo print_r($esami_corr,true).'<hr>';die();
	
		 foreach ($esami_corr as $ncorr){
		 	// 	  	   	echo $ncorr;die();
		 $xml_form_corr= new xml_form ( $this->conn, $this->service, $this->config_service, $this->session_vars, $this->uploaded_file_dir );
		 $xml_form_corr->xml_form_by_file($this->xml_dir . '/' . $this->vlist->esams [$visitnum] [$ncorr] ['XML'] );
		 // 		  	print_r($xml_form_corr);die();
		 $table_corr = $xml_form_corr->form ['TABLE'];
	
		 $this->InsertProgrEsam($table_corr,$visitnum,$visitnum_progr,$ncorr, $progr);
		 }
	}
	
	
	function trasferisci_paziente($codice_pat, $centro_OLD, $CENTRO_new){
		echo "vaiiiii";
		die();
	}
	
	/**
	*
	* Metodo utilizzato per sapere la tipologia di un utente
	*
	* @param $userid
	* @param $center
	*/
	protected function getTipologia($userid,$center){
		//echo "<hr>".$userid;
		global $conn;
		$query=new query($conn);
		$sql="select tipologia from {$this->service}_utenti_centri where userid= :userid and center = :center";
		// 		$query->set_sql($sql);
		$bind = array();
		$bind['USERID'] = $userid;
		$bind['CENTER'] = $center;
		$query->exec($sql,$bind);
		$query->get_row();
		$perfil=$query->row['TIPOLOGIA'];
		return $perfil;
	}
	
	
	//restituisce il percorso dell'xmr, al livello che mi interessa
	//G.Tufano 20/03/2012
	function getXMRPath($tipo,$filename=null){
		$ret='';
		switch($tipo){
			//restituisce il percorso completo, a parte il nome dello script
			case 'full': 			$dirs=explode("/", $_SERVER['PATH_TRANSLATED']);
									for ($i=0;$i<count($dirs)-1;$i++){
										$ret.=$dirs[$i]."/";
									}
			break;
				
			//restituisce la dir della libreria o quella locale a seconda di dove trova il file xml
			case 'xml_dir':			/*$dirs=explode("/",__FILE__);
									for ($i=0;$i<count($dirs)-1;$i++){
										$dir_lib.=$dirs[$i]."/";
									}*/
									$dir_lib = $this->config_service['dir_lib'];
									//specifico questo controllo in ordine a seconda di dove voglio controllare.
									//1) dentro la cartella ARMONIA
									$dir_lib .= '/xml/';
									if ($filename != '' && file_exists ($dir_lib.$filename)){
										$ret = $dir_lib;
									}
									else{
										$ret = $this->xml_dir;
									}
			break;
			
			//restituisce la dir della libreria o quella locale a seconda di dove trova il file xml
			case 'templates_dir':	$dir_lib = $this->config_service['dir_lib'];
									//specifico questo controllo in ordine a seconda di dove voglio controllare.
									//1) dentro la cartella ARMONIA
									$dir_lib .= '/templates/';
									if ($filename != '' && file_exists ($dir_lib.$filename)){
										$ret = $dir_lib;
									}
									else{
										$ret = '.';
									}
			break;
	
				//restituisce la root del registro
			case 'dir_registro':	$ret = $_SERVER['DOCUMENT_ROOT'];
			break;
	
			//restituisce la root del servizio (se è srevizio root corrisponde a dir_registro, altrimenti è il registro padre
			case 'dir_servizio':
			default:				$dirs=explode("/", $_SERVER['PATH_TRANSLATED']);
									for ($i=0;$i<count($dirs)-(1*$this->xmr->depth+1);$i++){
										$ret.=$dirs[$i]."/";
									}
		}
	
		$ret=rtrim($ret, "/");
		// 		print_r($_SERVER);die();
		return $ret;
	
	}
	
	
	/*******************************************************************************************************
	 * Funzioni private e statiche
	 * G.Tufano 
	 * 
	 *******************************************************************************************************/
	private function _print_table_res_query($sql){
// 		print_r($sql);die();
		$body = '<table border="1px"><tr><th>ID</th>';
		
		foreach ($sql->keys as $chiave ){
			$body .= '<th>'.$chiave.'</th>';
		}
		$body .= '</tr>';
		
		
// 		echo "keys = {$sql->keys[2]} val = {$sql->res[$sql->keys[2]][5]}";die();
 		for($i=0;$i< $sql->numrows;$i++){
 			$body .= '<tr><td>'.$i.'</td>';
			for($j=0;$j< $sql->numcols;$j++){
				$body .= '<td>'.$sql->res[$sql->keys[$j]][$i].'</td>';
			}
			$body .= '</tr>';
 		}
		
		$body .= '</tr></table>'; 
		return $body;
	}
	
	
	public static function _elimina_files_e_dirs($dirname){
// 		Logger::info($dirname);
		if(file_exists($dirname) && is_file($dirname)) {
			unlink($dirname);
		}elseif(is_dir($dirname)){
			$handle = opendir($dirname);
			while (false !== ($file = readdir($handle))) {
				if(is_file($dirname.$file)){
					unlink($dirname.$file);
				}
			}
			$handle = closedir($handle);
			rmdir($dirname);
		}
	}
    
    function audit_trail($xml_form){
        if(class_exists("audit_trail_core")){
            $audit_trail =  new audit_trail_core($this->service,$this->conn,$this->config_service,$this->vlist);
            $audit_trail->audit_trail_difference($xml_form);
            return true;
        }
        else{
            return false;
        }
    }
    
    function audit_trail_form_js($xml_form){
        if(class_exists("audit_trail_core")){
            $audit_trail =  new audit_trail_core($this->service,$this->conn,$this->config_service,$this->vlist);
            return $audit_trail->audit_trail_form_js($xml_form);
          
        }
        else{
            return '';
        }
    }
    
    function audit_trail_form_body($xml_form){
        if(class_exists("audit_trail_core")){
            $audit_trail =  new audit_trail_core($this->service,$this->conn,$this->config_service,$this->vlist);
            return $audit_trail->audit_trail_form_body($xml_form);
          
        }
        else{
            return '';
        }
    }
    function pdf_esame($esam, $visitnum, $visitnum_progr, $progr, $filename_suffix = null, $download = true) {
        $dir = str_replace('html', '', $_SERVER['DOCUMENT_ROOT']);
        $folder="{$dir}pdf_esami/tmpCRF/";
        $folder_base="{$dir}pdf_esami/";
        $folder_pdf="{$dir}pdf_esami/pdfCRF/";
        $old=umask(0);
        mkdir ( $folder, 0770 ,true  );
        mkdir ( $folder_base, 0770 ,true  );
        mkdir ( $folder_pdf, 0770 ,true  );
        chgrp($folder, "devj");
        chgrp($folder_base, "devj");
        chgrp($folder_pdf, "devj");
        $form = $this -> printable_form($esam, $visitnum, $visitnum_progr, $progr, $this -> service, $this -> vlist,true);
        $fp = fopen("{$folder}{$this->session_vars['remote_userid']}_esam_pdf_{$this->pk_service}_{$esam}_{$visitnum}_{$visitnum_progr}_{$progr}{$filename_suffix}.html", "w");
        
        $search = array('@<a[^>]*?>.*?</a>@siU', '@<span[^>]*?display:none[^>]*?>.*?</span>@siU');
        $form = str_replace(' src="/', " src=\"{$dir}html/", $form);
        $form = str_replace(" src='/", " src='{$dir}html/", $form);
        $form = preg_replace($search, '', $form);
        $form = $prepend . $form . $append;
        fwrite($fp, $form);
        fclose($fp);
        system("htmldoc_rw -t pdf14 --no-title --footer . --size A3 --browserwidth 1024 --landscape long --charset iso-8859-15 --headfootsize 8 --headfootfont Times-Italic --bottom 5mm --top 5mm --left 5mm --right 5mm --path /amministrazione/schede_utente --webpage --no-numbered {$folder}{$this->session_vars['remote_userid']}_esam_pdf_{$this->pk_service}_{$esam}_{$visitnum}_{$visitnum_progr}_{$progr}{$filename_suffix}.html > {$folder_pdf}{$this->session_vars['remote_userid']}_esam_pdf_{$this->pk_service}_{$esam}_{$visitnum}_{$visitnum_progr}_{$progr}{$filename_suffix}.pdf");
        umask($old);
        if ($download) {
            ob_clean();
            $search[] = ' ';
            $search[] = '*';
            $replace[] = '_';
            $replace[] = '';
            $nome_file = $this -> vlist -> esams[$visitnum][$esam]['TESTO'] . $filename_suffix . ".pdf";
            $nome_file = trim($nome_file, ' ');
            $nome_file = str_replace($search, $replace, $nome_file);
            header("Content-type: *");
            header("Content-Disposition: attachment; filename={$nome_file}");
            readfile("{$folder_pdf}{$this->session_vars['remote_userid']}_esam_pdf_{$this->pk_service}_{$esam}_{$visitnum}_{$visitnum_progr}_{$progr}{$filename_suffix}.pdf");
            die();
        }
    }


}

